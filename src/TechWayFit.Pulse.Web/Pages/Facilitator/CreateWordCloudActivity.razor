@page "/facilitator/activities/create-wordcloud"
@inject NavigationManager Navigation
@inject TechWayFit.Pulse.Web.Services.IPulseApiService ApiService
@inject TechWayFit.Pulse.Web.Services.IClientTokenService TokenService
@inject Microsoft.Extensions.Options.IOptions<TechWayFit.Pulse.Web.Configuration.ActivityDefaultsOptions> ActivityDefaults
@using TechWayFit.Pulse.Contracts.Requests
@using TechWayFit.Pulse.Contracts.Enums
@using System.Text.Json

<PageTitle>Create Word Cloud Activity</PageTitle>

<div class="container mt-5" style="max-width: 800px;">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">☁️ Create Word Cloud Activity</h3>
        </div>
        <div class="card-body">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">
                    <strong>Error:</strong> @errorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">
                    <strong>Success:</strong> @successMessage
                    <div class="mt-3">
                        <button class="btn btn-primary" @onclick="GoToFacilitatorConsole">Go to Console</button>
                        <button class="btn btn-outline-secondary" @onclick="ResetForm">Create Another</button>
                    </div>
                </div>
            }
            else
            {
                <form @onsubmit="HandleSubmit">
                    <!-- Session Code -->
                    <div class="mb-3">
                        <label class="form-label">Session Code *</label>
                        <input type="text" class="form-control" @bind="sessionCode" placeholder="ABC-123" required readonly="@(!string.IsNullOrEmpty(Code))" />
                        <small class="text-muted">@(string.IsNullOrEmpty(Code) ? "Enter the session code for this activity" : "Session code from Live page")</small>
                    </div>

                    <!-- Activity Title -->
                    <div class="mb-3">
                        <label class="form-label">Activity Title *</label>
                        <input type="text" class="form-control" @bind="title" placeholder="What words describe our team culture?" required />
                    </div>

                    <!-- Prompt (optional) -->
                    <div class="mb-3">
                        <label class="form-label">Prompt (optional)</label>
                        <textarea class="form-control" @bind="prompt" rows="2" placeholder="Share 1-3 words that best capture your thoughts on this topic."></textarea>
                    </div>

                    <!-- Word Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Word Cloud Settings</h5>
                        </div>
                        <div class="card-body">
                            <!-- Max Words -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Maximum Words Per Response</label>
                                    <input type="number" class="form-control" @bind="maxWords" min="1" max="10" />
                                    <small class="text-muted">How many words can each participant submit (1-10)</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Placeholder Text</label>
                                    <input type="text" class="form-control" @bind="placeholder" placeholder="Enter your words here..." />
                                </div>
                            </div>

                            <!-- Word Length Limits -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Minimum Word Length</label>
                                    <input type="number" class="form-control" @bind="minWordLength" min="1" max="50" />
                                    <small class="text-muted">Ignore words shorter than this</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Maximum Word Length</label>
                                    <input type="number" class="form-control" @bind="maxWordLength" min="1" max="100" />
                                    <small class="text-muted">Ignore words longer than this</small>
                                </div>
                            </div>

                            <!-- Multiple Submissions -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="allowMultipleSubmissions" @bind="allowMultipleSubmissions" />
                                        <label class="form-check-label" for="allowMultipleSubmissions">
                                            Allow multiple submissions
                                        </label>
                                    </div>
                                </div>
                                @if (allowMultipleSubmissions)
                                {
                                    <div class="col-md-6">
                                        <label class="form-label">Max Submissions Per Participant</label>
                                        <input type="number" class="form-control" @bind="maxSubmissionsPerParticipant" min="1" max="10" />
                                    </div>
                                }
                            </div>

                            <!-- Case Sensitivity -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="caseSensitive" @bind="caseSensitive" />
                                    <label class="form-check-label" for="caseSensitive">
                                        Case sensitive (treat "Team" and "team" as different words)
                                    </label>
                                </div>
                            </div>

                            <!-- Stop Words -->
                            <div class="mb-3">
                                <label class="form-label">Stop Words (Optional)</label>
                                <textarea class="form-control" @bind="customStopWords" rows="3" 
                                          placeholder="Enter words to ignore, separated by commas (e.g., the, and, is, a, an)"></textarea>
                                <small class="text-muted">Common words like 'the', 'and', 'is' are automatically filtered. Add custom words here.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                            @(isSubmitting ? "Creating..." : "Create Word Cloud Activity")
                        </button>
                        <a href="/" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            }
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Code { get; set; }

    private string sessionCode = "";
    private string title = "";
    private string prompt = "";
    
    // WordCloud Configuration
    private int maxWords = 3;
    private int minWordLength = 3;
    private int maxWordLength = 50;
    private string placeholder = "Enter your words here...";
    private bool allowMultipleSubmissions = false;
    private int maxSubmissionsPerParticipant = 1;
    private bool caseSensitive = false;
    private string customStopWords = "";

    private bool isSubmitting = false;
    private string errorMessage = "";
    private string successMessage = "";
    private Guid? createdActivityId;

    protected override void OnInitialized()
    {
        // Pre-fill session code if provided via query parameter
        if (!string.IsNullOrEmpty(Code))
        {
            sessionCode = Code;
        }
        
        // Set default from configuration
        maxSubmissionsPerParticipant = ActivityDefaults.Value.WordCloud.MaxSubmissionsPerParticipant;
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            // Validate
            if (string.IsNullOrWhiteSpace(sessionCode))
            {
                errorMessage = "Session code is required.";
                return;
            }

            if (string.IsNullOrWhiteSpace(title))
            {
                errorMessage = "Activity title is required.";
                return;
            }

            if (maxWords < 1 || maxWords > 10)
            {
                errorMessage = "Maximum words must be between 1 and 10.";
                return;
            }

            if (minWordLength < 1 || minWordLength > maxWordLength)
            {
                errorMessage = "Minimum word length must be at least 1 and not greater than maximum word length.";
                return;
            }

            if (allowMultipleSubmissions && (maxSubmissionsPerParticipant < 1 || maxSubmissionsPerParticipant > 10))
            {
                errorMessage = "Maximum submissions per participant must be between 1 and 10.";
                return;
            }

            // Parse custom stop words
            var stopWordsList = new List<string>();
            if (!string.IsNullOrWhiteSpace(customStopWords))
            {
                stopWordsList = customStopWords
                    .Split(',')
                    .Select(w => w.Trim().ToLower())
                    .Where(w => !string.IsNullOrWhiteSpace(w))
                    .ToList();
            }

            // Build config using WordCloudConfig structure
            var config = new
            {
                MaxWords = maxWords,
                MinWordLength = minWordLength,
                MaxWordLength = maxWordLength,
                Placeholder = string.IsNullOrWhiteSpace(placeholder) ? "Enter your words here..." : placeholder.Trim(),
                AllowMultipleSubmissions = allowMultipleSubmissions,
                MaxSubmissionsPerParticipant = allowMultipleSubmissions ? maxSubmissionsPerParticipant : 1,
                CaseSensitive = caseSensitive,
                StopWords = stopWordsList
            };

            // Get next order number (TODO: Get from API)
            var order = 1; // Placeholder

            // Create activity
            var request = new CreateActivityRequest
            (
                ActivityType.WordCloud,
                order,
                title.Trim(),
                prompt?.Trim(),
                JsonSerializer.Serialize(config)
            );

            // Get facilitator token from token service
            var token = await TokenService.GetFacilitatorTokenAsync(sessionCode);
            if (string.IsNullOrEmpty(token))
            {
                errorMessage = "Unable to get facilitator authentication token. Please refresh and try again.";
                return;
            }

            var activity = await ApiService.CreateActivityAsync(sessionCode, request, token);

            createdActivityId = activity.ActivityId;
            successMessage = $"Word Cloud activity '{title}' created successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to create activity: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void GoToFacilitatorConsole()
    {
        Navigation.NavigateTo($"/facilitator/live?code={sessionCode}");
    }

    private void ResetForm()
    {
        sessionCode = Code ?? "";
        title = "";
        prompt = "";
        maxWords = 3;
        minWordLength = 3;
        maxWordLength = 50;
        placeholder = "Enter your words here...";
        allowMultipleSubmissions = false;
        maxSubmissionsPerParticipant = 1;
        caseSensitive = false;
        customStopWords = "";
        errorMessage = "";
        successMessage = "";
        createdActivityId = null;
    }
}