@page "/facilitator/create"
@using TechWayFit.Pulse.Web.Models
@using TechWayFit.Pulse.Web.Services
@using TechWayFit.Pulse.Contracts.Requests
@using TechWayFit.Pulse.Contracts.Models
@using TechWayFit.Pulse.Contracts.Enums
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IPulseApiService ApiService

<PageTitle>TechWayFit Pulse — Create Session</PageTitle>

<main class="wrap">
    <div class="create-session-container">
        <div class="page-header">
            <div>
                <h2>Create session</h2>
                <div class="subtitle">Context → Join Form (max 5 fields) → Launch</div>
            </div>
            <span class="chip">TTL: <strong>&nbsp;6h</strong></span>
        </div>

        <SessionContextTabs Data="sessionContext" DataChanged="OnSessionContextChanged" />
        
        <div class="section-card">
            <h3 class="section-title">Join form builder</h3>
            <p class="section-subtitle">Add up to 5 fields for participant registration. This data helps filter and group responses.</p>
            
            <div class="form-builder-container" id="joinFormBuilder" @key="joinFormBuilderKey">
                <div class="field-types">
                    <!-- Field types will be rendered by JavaScript -->
                </div>
                <div class="form-drop-zone">
                    <!-- Drop zone will be rendered by JavaScript -->
                </div>
            </div>
        </div>

        <div class="section-card">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    @errorMessage
                </div>
            }
            <div class="action-buttons">
                <a class="btn btn-secondary" href="/home">Cancel</a>
                <button class="btn btn-primary" @onclick="SaveAndGoLive" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Creating session...</span>
                    }
                    else
                    {
                        <span>Save & Go Live</span>
                    }
                </button>
            </div>
        </div>
    </div>
</main>

@code {
    private SessionContextViewModel sessionContext = new();
    private List<FormField> joinFormFields = new();
    private readonly string joinFormBuilderKey = Guid.NewGuid().ToString();
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(100);
            await JS.InvokeVoidAsync("initFormBuilder", "joinFormBuilder");
        }
    }

    private void OnSessionContextChanged(SessionContextViewModel updatedContext)
    {
        sessionContext = updatedContext;
    }

    private async Task SaveAndGoLive()
    {
        try
        {
            isSubmitting = true;
            errorMessage = string.Empty;
            StateHasChanged();

            // Collect form builder fields
            var fields = await JS.InvokeAsync<List<FormField>>("getFormBuilderFields");
            joinFormFields = fields ?? new();

            // Validate
            if (string.IsNullOrWhiteSpace(sessionContext.SessionTitle))
            {
                errorMessage = "Session title is required.";
                return;
            }

            // Generate session code
            var sessionCode = GenerateSessionCode();

            // Build request
            var request = new CreateSessionRequest
            {
                Code = sessionCode,
                Title = sessionContext.SessionTitle.Trim(),
                Goal = string.IsNullOrWhiteSpace(sessionContext.SessionGoal) ? null : sessionContext.SessionGoal.Trim(),
                Context = BuildContextString(),
                Settings = new SessionSettingsDto
                {
                    MaxContributionsPerParticipantPerSession = int.Parse(sessionContext.MaxContributions),
                    MaxContributionsPerParticipantPerActivity = null,
                    StrictCurrentActivityOnly = true,
                    AllowAnonymous = false,
                    TtlMinutes = 360 // 6 hours
                },
                JoinFormSchema = new JoinFormSchemaDto
                {
                    MaxFields = 5,
                    Fields = joinFormFields.Select((f, index) => new JoinFormFieldDto
                    {
                        Id = $"field_{index + 1}",
                        Label = f.Label,
                        Type = MapFieldType(f.Type),
                        Required = f.Required,
                        Options = f.Options ?? string.Empty, // Ensure it's never null
                        UseInFilters = true
                    }).ToList()
                }
            };

            // Call API
            var response = await ApiService.CreateSessionAsync(request);

            // Navigate to live page with session code
            Navigation.NavigateTo($"/facilitator/live?code={response.Code}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to create session: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private string? BuildContextString()
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(sessionContext.CurrentProcess))
            parts.Add($"Current Process: {sessionContext.CurrentProcess.Trim()}");
        
        if (!string.IsNullOrWhiteSpace(sessionContext.PainPoints))
            parts.Add($"Pain Points: {sessionContext.PainPoints.Trim()}");
        
        if (!string.IsNullOrWhiteSpace(sessionContext.TechnicalContext))
            parts.Add($"Technical Context: {sessionContext.TechnicalContext.Trim()}");
        
        if (!string.IsNullOrWhiteSpace(sessionContext.TeamBackground))
            parts.Add($"Team Background: {sessionContext.TeamBackground.Trim()}");
        
        if (!string.IsNullOrWhiteSpace(sessionContext.AiGoals))
            parts.Add($"AI Goals: {sessionContext.AiGoals.Trim()}");
        
        return parts.Any() ? string.Join(" | ", parts) : null;
    }

    private FieldType MapFieldType(string type)
    {
        return type.ToLower() switch
        {
            "text" => FieldType.Text,
            "number" => FieldType.Number,
            "dropdown" => FieldType.Dropdown,
            "multiselect" => FieldType.MultiSelect,
            "boolean" => FieldType.Boolean,
            _ => FieldType.Text
        };
    }

    private string GenerateSessionCode()
    {
        var random = new Random();
        var code = new string(Enumerable.Range(0, 6)
            .Select(_ => "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[random.Next(32)])
            .ToArray());
        return code;
    }

    public class FormField
    {
        public string Type { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
        public bool Required { get; set; }
        public string? Options { get; set; } // Can be string or null from JavaScript
       
    }
}
