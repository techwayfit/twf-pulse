@page "/facilitator/activities/create-poll"
@inject NavigationManager Navigation
@inject TechWayFit.Pulse.Web.Services.IPulseApiService ApiService
@inject TechWayFit.Pulse.Web.Services.IClientTokenService TokenService
@using TechWayFit.Pulse.Contracts.Requests
@using TechWayFit.Pulse.Contracts.Enums
@using System.Text.Json

<PageTitle>Create Poll Activity</PageTitle>

<div class="container mt-5" style="max-width: 800px;">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">?? Create Poll Activity</h3>
        </div>
        <div class="card-body">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">
                    <strong>Error:</strong> @errorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">
                    <strong>Success:</strong> @successMessage
                    <div class="mt-3">
                        <button class="btn btn-primary" @onclick="GoToFacilitatorConsole">Go to Console</button>
                        <button class="btn btn-outline-secondary" @onclick="ResetForm">Create Another</button>
                    </div>
                </div>
            }
            else
            {
                <form @onsubmit="HandleSubmit">
                    <!-- Session Code -->
                    <div class="mb-3">
                        <label class="form-label">Session Code *</label>
                        <input type="text" class="form-control" @bind="sessionCode" placeholder="ABC-123" required readonly="@(!string.IsNullOrEmpty(Code))" />
                        <small class="text-muted">@(string.IsNullOrEmpty(Code) ? "Enter the session code for this activity" : "Session code from Live page")</small>
                    </div>

                    <!-- Activity Title -->
                    <div class="mb-3">
                        <label class="form-label">Activity Title *</label>
                        <input type="text" class="form-control" @bind="title" placeholder="Which process step slows you down most?" required />
                    </div>

                    <!-- Prompt (optional) -->
                    <div class="mb-3">
                        <label class="form-label">Prompt (optional)</label>
                        <textarea class="form-control" @bind="prompt" rows="2" placeholder="Select the single biggest bottleneck in your daily work."></textarea>
                    </div>

                    <!-- Poll Options -->
                    <div class="mb-4">
                        <label class="form-label">Poll Options *</label>
                        @foreach (var (option, index) in pollOptions.Select((o, i) => (o, i)))
                        {
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control"
                                                   placeholder="Option label"
                                                   @bind="option.Label"
                                                   required />
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control"
                                                   placeholder="Description (optional)"
                                                   @bind="option.Description" />
                                        </div>
                                        <div class="col-md-2">
                                            @if (pollOptions.Count > 2)
                                            {
                                                <button type="button" class="btn btn-danger btn-sm w-100" @onclick="() => RemoveOption(index)">
                                                    Remove
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        <button type="button" class="btn btn-outline-primary btn-sm" @onclick="AddOption">
                            + Add Option
                        </button>
                    </div>

                    <!-- Settings -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="allowMultiple" @bind="allowMultiple" />
                            <label class="form-check-label" for="allowMultiple">
                                Allow multiple selections
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="allowCustomOption" @bind="allowCustomOption" />
                            <label class="form-check-label" for="allowCustomOption">
                                Allow "Other" custom option
                            </label>
                        </div>
                        @if (allowCustomOption)
                        {
                            <input type="text" class="form-control mt-2"
                                   @bind="customOptionPlaceholder"
                                   placeholder="Placeholder for custom option" />
                        }
                    </div>

                    @if (allowMultiple)
                    {
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Min Selections</label>
                                <input type="number" class="form-control" @bind="minSelections" min="1" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Max Selections</label>
                                <input type="number" class="form-control" @bind="maxSelections" min="1" />
                            </div>
                        </div>
                    }

                    <!-- Submit -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                            @(isSubmitting ? "Creating..." : "Create Poll Activity")
                        </button>
                        <a href="/" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            }
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Code { get; set; }

    private string sessionCode = "";
    private string title = "";
    private string prompt = "";
    private bool allowMultiple = false;
    private bool allowCustomOption = true;
    private string customOptionPlaceholder = "Other (please specify)";
    private int minSelections = 1;
    private int maxSelections = 3;

    private List<PollOptionInput> pollOptions = new()
    {
    new PollOptionInput { Label = "" },
        new PollOptionInput { Label = "" }
    };

    private bool isSubmitting = false;
    private string errorMessage = "";
    private string successMessage = "";
    private Guid? createdActivityId;

    protected override void OnInitialized()
    {
        // Pre-fill session code if provided via query parameter
        if (!string.IsNullOrEmpty(Code))
        {
            sessionCode = Code;
        }
    }

    private void AddOption()
    {
        pollOptions.Add(new PollOptionInput { Label = "" });
    }

    private void RemoveOption(int index)
    {
        if (pollOptions.Count > 2)
        {
            pollOptions.RemoveAt(index);
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            // Validate
            if (string.IsNullOrWhiteSpace(sessionCode))
            {
                errorMessage = "Session code is required.";
                return;
            }

            if (string.IsNullOrWhiteSpace(title))
            {
                errorMessage = "Activity title is required.";
                return;
            }

            var validOptions = pollOptions.Where(o => !string.IsNullOrWhiteSpace(o.Label)).ToList();
            if (validOptions.Count < 2)
            {
                errorMessage = "At least 2 options are required.";
                return;
            }

            // Build config
            var config = new
            {
                Options = validOptions.Select((o, i) => new
                {
                    Id = $"opt-{i + 1}",
                    Label = o.Label.Trim(),
                    Description = o.Description?.Trim()
                }).ToArray(),
                AllowMultiple = allowMultiple,
                MinSelections = allowMultiple ? minSelections : 1,
                MaxSelections = allowMultiple ? maxSelections : 1,
                AllowCustomOption = allowCustomOption,
                CustomOptionPlaceholder = allowCustomOption ? customOptionPlaceholder : "",
                RandomizeOrder = false,
                ShowResultsAfterSubmit = false
            };

            // Get next order number (TODO: Get from API)
            var order = 1; // Placeholder

            // Create activity
            var request = new CreateActivityRequest
            (
                ActivityType.Poll,
                order,
                title.Trim(),
                prompt?.Trim(),
                JsonSerializer.Serialize(config)
            );

            // Get facilitator token from token service
            var token = await TokenService.GetFacilitatorTokenAsync(sessionCode);
            if (string.IsNullOrEmpty(token))
            {
                errorMessage = "Unable to get facilitator authentication token. Please refresh and try again.";
                return;
            }

            var activity = await ApiService.CreateActivityAsync(sessionCode, request, token);

            createdActivityId = activity.ActivityId;
            successMessage = $"Poll activity '{title}' created successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to create activity: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void GoToFacilitatorConsole()
    {
        Navigation.NavigateTo($"/facilitator/live?code={sessionCode}");
    }

    private void ResetForm()
    {
        sessionCode = "";
        title = "";
        prompt = "";
        allowMultiple = false;
        allowCustomOption = true;
        customOptionPlaceholder = "Other (please specify)";
        minSelections = 1;
        maxSelections = 3;
        pollOptions = new()
        {
       new PollOptionInput { Label = "" },
            new PollOptionInput { Label = "" }
        };
        errorMessage = "";
        successMessage = "";
        createdActivityId = null;
    }

    private class PollOptionInput
    {
        public string Label { get; set; } = "";
        public string? Description { get; set; }
    }
}
