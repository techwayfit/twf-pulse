@page "/facilitator/live"
@using TechWayFit.Pulse.Web.Services
@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Enums
@using Microsoft.Extensions.Logging
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IPulseApiService ApiService
@inject ILogger<Live> Logger
@rendermode InteractiveServer

<PageTitle>TechWayFit Pulse â€” Live Session</PageTitle>

<main class="wrap">
    @if (isLoading)
    {
        <div class="section-card text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading session...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="section-card">
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
            <a href="/home" class="btn btn-primary">Back to Home</a>
        </div>
    }
    else if (session != null)
    {
        <div class="live-session-container">
            <!-- Header -->
            <div class="section-card">
                <div class="live-header">
                    <div class="live-header-info">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <h2 class="mb-0">@session.Title</h2>
                            <span class="badge bg-success d-flex align-items-center gap-2">
                                <span class="status-dot"></span>
                                Live
                            </span>
                        </div>
                        <div class="d-flex gap-3 text-muted small">
                            <span>Code: <strong>@sessionCode</strong></span>
                            <span>Participants: <strong>@participantCount</strong></span>
                            <span>TTL: <strong>6h</strong></span>
                        </div>
                    </div>
                    <div class="live-header-actions">
                        <button class="btn btn-outline-danger" @onclick="EndSession" disabled="@isPerformingAction">
                            @(isPerformingAction ? "Ending..." : "End Session")
                        </button>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Left Sidebar: QR Code & Agenda -->
                <div class="col-lg-4">
                    <!-- QR Code Section -->
                    <div class="section-card mb-4">
                        <h3 class="section-title">Participant Join</h3>
                        <div class="qr-code-container">
                            <div class="qr-code-display" id="qrCodeContainer">
                                <canvas id="qr-@sessionCode" width="200" height="200"></canvas>
                            </div>
                            <div class="qr-code-info">
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Join URL</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-sm" readonly value="@joinUrl" id="joinUrlInput" />
                                        <button class="btn btn-sm btn-outline-secondary" @onclick="CopyJoinUrl">
                                            ðŸ“‹
                                        </button>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="session-code-display">
                                        @sessionCode
                                    </div>
                                    <p class="small text-muted mb-0">Session Code</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agenda -->
                    <div class="section-card">
                        <h3 class="section-title mb-3">Agenda</h3>
                        <div class="agenda-list">
                            @if (activities != null && activities.Any())
                            {
                                @foreach (var (activity, index) in activities.Select((a, i) => (a, i)))
                                {
                                    <div class="agenda-item @(activity.Status == Contracts.Enums.ActivityStatus.Open ? "active" : "")">
                                        <div class="agenda-item-header">
                                            <strong>@(index + 1)) @activity.Type</strong>
                                            @if (activity.Status == Contracts.Enums.ActivityStatus.Open)
                                            {
                                                <span class="badge bg-success">Open</span>
                                            }
                                            else if (activity.Status == Contracts.Enums.ActivityStatus.Closed)
                                            {
                                                <span class="badge bg-secondary">Closed</span>
                                            }
                                        </div>
                                        <div class="agenda-item-description">@activity.Prompt</div>
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-muted small">No activities yet</p>
                            }
                        </div>
                        
                        <div class="agenda-actions mt-3">
                            <button class="btn btn-sm btn-primary w-100">Add Activity</button>
                        </div>
                        
                        <hr class="my-3" />
                        <p class="small text-muted mb-0">
                            ðŸ’¡ Strict pacing: only current open activity accepts responses.
                        </p>
                    </div>
                </div>

                <!-- Main Content: Activity Preview -->
                <div class="col-lg-8">
                    <div class="section-card">
                        <div class="activity-preview-header">
                            <div>
                                <h3 class="mb-1">@(currentActivity?.Prompt ?? "No active activity")</h3>
                                <p class="text-muted small mb-0">Live preview â€¢ Updates in real-time</p>
                            </div>
                            <div class="pulse-indicator">
                                <span class="pulse-dot"></span>
                                <span class="small">Updating</span>
                            </div>
                        </div>

                        @if (currentActivity != null)
                        {
                            <!-- Quadrant Visualization Placeholder -->
                            <div class="activity-visualization">
                                <svg viewBox="0 0 800 420" width="100%" height="auto" class="quadrant-viz">
                                    <line x1="400" y1="20" x2="400" y2="400" stroke="rgba(15,36,56,.12)" stroke-width="2"/>
                                    <line x1="20" y1="210" x2="780" y2="210" stroke="rgba(15,36,56,.12)" stroke-width="2"/>
                                    <text x="28" y="44" fill="rgba(15,36,56,.65)" font-size="14">Quick Wins</text>
                                    <text x="540" y="44" fill="rgba(15,36,56,.65)" font-size="14">Big Bets</text>
                                    <text x="28" y="392" fill="rgba(15,36,56,.65)" font-size="14">Fill-ins</text>
                                    <text x="540" y="392" fill="rgba(15,36,56,.65)" font-size="14">Hard Slogs</text>
                                    <g>
                                        <circle cx="260" cy="120" r="10" fill="rgba(43,196,138,.72)" stroke="rgba(43,196,138,.95)" stroke-width="2"/>
                                        <circle cx="600" cy="140" r="10" fill="rgba(45,127,249,.62)" stroke="rgba(45,127,249,.95)" stroke-width="2"/>
                                        <circle cx="560" cy="300" r="10" fill="rgba(255,176,32,.62)" stroke="rgba(255,176,32,.95)" stroke-width="2"/>
                                        <circle cx="220" cy="290" r="10" fill="rgba(255,77,109,.55)" stroke="rgba(255,77,109,.92)" stroke-width="2"/>
                                    </g>
                                </svg>
                            </div>

                            <!-- Activity Controls -->
                            <div class="activity-controls mt-4">
                                <div class="d-flex gap-2 flex-wrap mb-3">
                                    <span class="badge bg-light text-dark">Filter: Team = <strong>Ops</strong></span>
                                    <span class="badge bg-light text-dark">Filter: Role = <strong>Supervisor</strong></span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success">Open Activity</button>
                                    <button class="btn btn-secondary">Close Activity</button>
                                    <button class="btn btn-primary">Next Activity</button>
                                    <a class="btn btn-outline-primary ms-auto" href="/facilitator/dashboards">ðŸ“Š Open Dashboards</a>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <p class="text-muted">No activity selected</p>
                                <button class="btn btn-primary">Create First Activity</button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</main>

@code {
    [SupplyParameterFromQuery]
    public string? Code { get; set; }
    
    private string sessionCode = string.Empty;
    private SessionSummaryResponse? session;
    private List<AgendaActivityResponse> activities = new();
    private AgendaActivityResponse? currentActivity;
    private int participantCount = 0;
    private string joinUrl = string.Empty;
    private bool isLoading = true;
    private bool isPerformingAction = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSession();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(sessionCode))
        {
            await Task.Delay(100);
            await GenerateQRCode();
        }
    }

    private async Task LoadSession()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            StateHasChanged();

            // Get session code from query parameter or use default
            sessionCode = Code ?? "TYF-4821";

            // Load session data
            session = await ApiService.GetSessionAsync(sessionCode);
            
            // Load activities
            activities = (await ApiService.GetAgendaAsync(sessionCode)).ToList();
            currentActivity = activities.FirstOrDefault(a => a.Status == Contracts.Enums.ActivityStatus.Open);
            
            // TODO: Get actual participant count from API
            participantCount = 18;
            
            // Build join URL
            var uri = new Uri(Navigation.Uri);
            joinUrl = $"{uri.Scheme}://{uri.Authority}/participant/join?code={sessionCode}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load session: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GenerateQRCode()
    {
        try
        {
            await JS.InvokeVoidAsync("generateQRCode", $"qr-{sessionCode}", joinUrl);
        }
        catch (Exception ex)
        {
            Logger.LogWarning($"QR Code generation failed: {ex.Message}");
        }
    }

    private async Task CopyJoinUrl()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", joinUrl);
            // TODO: Show toast notification
        }
        catch (Exception ex)
        {
            Logger.LogWarning($"Copy failed: {ex.Message}");
        }
    }

    private async Task EndSession()
    {
        try
        {
            isPerformingAction = true;
            StateHasChanged();
            
            // TODO: Call API to end session
            await Task.Delay(1000); // Placeholder
            
            Navigation.NavigateTo("/home");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to end session: {ex.Message}";
        }
        finally
        {
            isPerformingAction = false;
            StateHasChanged();
        }
    }
}
