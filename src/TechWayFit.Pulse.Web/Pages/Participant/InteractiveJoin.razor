@page "/participant/join"
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject TechWayFit.Pulse.Application.Abstractions.Services.ISessionService SessionService
@inject TechWayFit.Pulse.Application.Abstractions.Services.IParticipantService ParticipantService
@inject TechWayFit.Pulse.Web.Api.IParticipantTokenStore ParticipantTokenStore
@using TechWayFit.Pulse.Contracts.Requests
@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Models
@using TechWayFit.Pulse.Web.Api
@using System
@using Microsoft.AspNetCore.SignalR.Client

<PageTitle>Join @sessionSummary?.Title - TechWayFit Pulse</PageTitle>

<main class="py-5">
  <div class="container container-wide">
    @if (isLoading)
    {
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted mb-0">Loading session information...</p>
        </div>
      </div>
    }
    else if (showCodeEntryForm)
    {
      <!-- Session Code Entry Form -->
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-4 p-md-5">
              <div class="text-center mb-4">
                <div class="mb-3">
                  <i class="fas fa-users fa-3x text-primary"></i>
                </div>
                <h1 class="h3 fw-bold mb-2">Join Workshop Session</h1>
                <p class="text-muted">Enter your session code or scan the QR code</p>
              </div>

              @if (!string.IsNullOrEmpty(codeEntryError))
              {
                <div class="alert alert-danger" role="alert">
                  <strong>Error:</strong> @codeEntryError
                </div>
              }

              <!-- Manual Code Entry -->
              <div class="mb-4">
                <label for="sessionCodeInput" class="form-label fw-semibold">Session Code</label>
                <div class="input-group input-group-lg">
                  <input type="text" 
                         id="sessionCodeInput" 
                         value="@manualSessionCode"
                         @oninput="FormatSessionCode"
                         @onkeypress="HandleKeyPress"
                         placeholder="XXX-XXX-XXX"
                         maxlength="11"
                         class="form-control form-control-lg text-center text-uppercase letter-spacing-wide fw-semibold" />
                  <button class="btn btn-primary" 
                          type="button" 
                          @onclick="JoinWithCode"
                          disabled="@(!IsValidSessionCodeFormat(manualSessionCode))">
                    Join
                  </button>
                </div>
                <small class="text-muted">Example: SHE-K4F-M4U</small>
              </div>

              <!-- Divider -->
              <div class="position-relative text-center my-4">
                <hr />
                <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted">OR</span>
              </div>

              <!-- QR Code Scanner -->
              <div class="mb-3">
                <button class="btn btn-outline-primary w-100" 
                        type="button" 
                        @onclick="ToggleQRScanner">
                  <i class="fas fa-qrcode me-2"></i>
                  @(showQRScanner ? "Close Scanner" : "Scan QR Code")
                </button>
              </div>

              @if (showQRScanner)
              {
                <div class="border rounded p-3 mb-3">
                  <div id="qr-reader" style="width: 100%;"></div>
                  @if (!string.IsNullOrEmpty(qrScannerStatus))
                  {
                    <div class="alert alert-info mt-3 mb-0">
                      @qrScannerStatus
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="alert alert-danger mb-4" role="alert">
            <strong>Error:</strong> @errorMessage
          </div>
          @if (!string.IsNullOrWhiteSpace(sessionCode))
          {
            <p class="text-muted mb-3">Session Code: <strong>@sessionCode</strong></p>
          }
          <a href="/participant/join" class="btn btn-primary pulse-btn-primary">Try Again</a>
        </div>
      </div>
    }
    else if (currentState == JoinState.FillForm && sessionSummary != null)
    {
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <!-- Session Header -->
          <div class="text-center mb-4">
            <div class="mb-3">
              <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-2">
                <span class="pulse-dot me-2"></span>
                @sessionSummary.Status
              </span>
            </div>
            <h1 class="h3 fw-bold mb-2">@sessionSummary.Title</h1>
            @if (!string.IsNullOrEmpty(sessionSummary.Goal))
            {
              <p class="text-muted mb-0">@sessionSummary.Goal</p>
            }
            <p class="text-muted small mt-2">Session Code: <strong>@sessionSummary.Code</strong></p>
          </div>

          <!-- Join Form -->
          <div class="row justify-content-center">
            <div class="col-md-8">
              <h4 class="h5 fw-semibold mb-3">Your Information</h4>

              <!-- Display Name -->
              <div class="mb-3">
                <label for="displayName" class="form-label">
                  Display Name
                  @if (DisplayNameRequired)
                  {
                    <span class="text-danger">*</span>
                  }
                </label>
                <input id="displayName" 
                       type="text" 
                       class="form-control" 
                       @bind="displayName" 
                       placeholder="@(DisplayNameRequired ? "Enter your name" : "How should others see you? (optional)")" 
                       maxlength="120" />
              </div>

              <!-- Anonymous Toggle -->
              <div class="form-check mb-4">
                <input type="checkbox" 
                       class="form-check-input" 
                       id="isAnonymous" 
                       @bind="isAnonymous" />
                <label class="form-check-label" for="isAnonymous">
                  <strong>Join anonymously</strong>
                  <small class="d-block text-muted">Your responses will be included in results but not linked to you</small>
                </label>
              </div>

              <!-- Additional Fields -->
              @if (joinFormFields?.Any() == true)
              {
                <h5 class="h6 fw-semibold mb-3">Additional Information</h5>
                
                @foreach (var field in joinFormFields)
                {
                  <div class="mb-3">
                    @if (field.Type != TechWayFit.Pulse.Contracts.Enums.FieldType.Boolean)
                    {
                      <label for="field-@field.Id" class="form-label @(field.Required ? "required" : "")">
                        @field.Label
                        @if (field.Required)
                        {
                          <span class="text-danger">*</span>
                        }
                      </label>
                    }

                    @if (field.Type == TechWayFit.Pulse.Contracts.Enums.FieldType.Text)
                    {
                      <input id="field-@field.Id" 
                             type="text"
                             class="form-control" 
                             @bind="fieldValues[field.Id]" 
                             placeholder="@GetFieldPlaceholder(field)" />
                    }
                    else if (field.Type == TechWayFit.Pulse.Contracts.Enums.FieldType.Dropdown)
                    {
                      <select id="field-@field.Id" 
                              class="form-select" 
                              @bind="fieldValues[field.Id]">
                        <option value="">-- Select @field.Label --</option>
                        @if (field.OptionsList?.Any() == true)
                        {
                          @foreach (var option in field.OptionsList)
                          {
                            <option value="@option">@option</option>
                          }
                        }
                      </select>
                    }
                    else if (field.Type == TechWayFit.Pulse.Contracts.Enums.FieldType.Number)
                    {
                      <input id="field-@field.Id" 
                             type="number"
                             class="form-control" 
                             @bind="fieldValues[field.Id]" 
                             placeholder="@GetFieldPlaceholder(field)" />
                    }
                    else if (field.Type == TechWayFit.Pulse.Contracts.Enums.FieldType.Boolean)
                    {
                      <div class="form-check">
                        <input id="field-@field.Id" 
                               type="checkbox"
                               class="form-check-input" 
                               @bind="fieldValues[field.Id]" />
                        <label class="form-check-label" for="field-@field.Id">
                          @field.Label
                        </label>
                      </div>
                    }
                  </div>
                }
              }

              <!-- Error Display -->
              @if (!string.IsNullOrEmpty(errorMessage))
              {
                <div class="alert alert-danger mb-4" role="alert">
                  @errorMessage
                </div>
              }

              <!-- Action Buttons -->
              <div class="d-flex gap-3 justify-content-between">
                <button type="button" 
                        class="btn btn-outline-secondary" 
                        @onclick="BackToStaticJoin">
                  Change Code
                </button>
                <button type="button" 
                        class="btn btn-primary pulse-btn-primary" 
                        @onclick="JoinSession" 
                        disabled="@(isLoading || !CanJoin)">
                  @if (isLoading)
                  {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Joining...</span>
                  }
                  else
                  {
                    <span>Join Workshop</span>
                  }
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    }
    else if (currentState == JoinState.Joined)
    {
      <!-- Redirect to participant activity page -->
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <div class="text-success mb-3">
            <i class="fas fa-check-circle fs-1"></i>
          </div>
          <h4 class="h5 fw-semibold mb-3">Successfully Joined!</h4>
          <p class="text-muted mb-4">You have been added to the workshop. Redirecting to activity page...</p>
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    }
  </div>
</main>

@code {
  [Parameter]
  [SupplyParameterFromQuery]
  public string sessionCode { get; set; } = string.Empty;

  private enum JoinState
  {
    FillForm,
    Joined
  }

  private JoinState currentState = JoinState.FillForm;
  private bool isLoading = true;
  private string errorMessage = "";
  private string codeEntryError = "";
  private SessionSummaryResponse? sessionSummary;
  private List<JoinFormFieldDto>? joinFormFields;
  private string displayName = "";
  private bool isAnonymous = false;
  private Dictionary<string, string?> fieldValues = new();
  private Guid? participantId;
  private HubConnection? hubConnection;
  
  // Session code entry
  private bool showCodeEntryForm = false;
  private string manualSessionCode = "";
  private bool showQRScanner = false;
  private string qrScannerStatus = "";

  private bool DisplayNameRequired =>
    joinFormFields?.Any(f => string.Equals(f.Id, "displayName", StringComparison.OrdinalIgnoreCase) && f.Required) ?? false;

  protected override async Task OnInitializedAsync()
  {
    // Check if session code is provided
    if (string.IsNullOrWhiteSpace(sessionCode))
    {
      // Show code entry form instead of error
      showCodeEntryForm = true;
      isLoading = false;
      return;
    }

    await LoadSession();
  }

  private async Task LoadSession()
  {
    try
    {
      isLoading = true;
      errorMessage = "";
      codeEntryError = "";
      
      // Check if user already joined this session
      var existingParticipantId = await CheckExistingParticipant();
      if (existingParticipantId.HasValue)
      {
        // User already joined - redirect to activity page
        participantId = existingParticipantId;
        Navigation.NavigateTo($"/participant/activity/{sessionCode}?Pid={existingParticipantId}");
        return;
      }
      
      // Load session data for new participants
      var sessionEntity = await SessionService.GetByCodeAsync(sessionCode);
      if (sessionEntity == null)
      {
        errorMessage = "Session not found.";
        isLoading = false;
        return;
      }
      sessionSummary = ApiMapper.ToSummary(sessionEntity);
      joinFormFields = sessionSummary?.JoinFormFields ?? new List<JoinFormFieldDto>();

      // Initialize field values
      fieldValues.Clear();
      if (joinFormFields?.Any() == true)
      {
        foreach (var field in joinFormFields)
        {
          fieldValues[field.Id] = "";
        }
      }

      // Setup SignalR connection for real-time updates
      await SetupSignalRConnection();
      
      showCodeEntryForm = false;
      isLoading = false;
    }
    catch (Exception ex)
    {
      errorMessage = $"Could not load session: {ex.Message}";
      isLoading = false;
    }
  }

  private async Task JoinWithCode()
  {
    if (!IsValidSessionCodeFormat(manualSessionCode))
    {
      codeEntryError = "Please enter a valid session code in format XXX-XXX-XXX.";
      return;
    }

    sessionCode = manualSessionCode.ToUpper().Trim();
    showCodeEntryForm = false;
    await LoadSession();
  }

  private bool IsValidSessionCodeFormat(string code)
  {
    if (string.IsNullOrWhiteSpace(code))
      return false;
    
    // Format: XXX-XXX-XXX (11 characters total)
    code = code.Trim();
    if (code.Length != 11)
      return false;
    
    // Check format: 3 chars, hyphen, 3 chars, hyphen, 3 chars
    var parts = code.Split('-');
    if (parts.Length != 3)
      return false;
    
    return parts.All(p => p.Length == 3 && p.All(c => char.IsLetterOrDigit(c)));
  }

  private void FormatSessionCode(ChangeEventArgs e)
  {
    var input = e.Value?.ToString() ?? "";
    manualSessionCode = FormatCode(input);
    StateHasChanged();
  }

  private string FormatCode(string input)
  {
    // Remove all non-alphanumeric characters
    var cleanInput = new string(input.Where(char.IsLetterOrDigit).ToArray()).ToUpper();
    
    // Limit to 9 alphanumeric characters
    if (cleanInput.Length > 9)
      cleanInput = cleanInput.Substring(0, 9);
    
    // Add hyphens at appropriate positions
    if (cleanInput.Length > 6)
      return $"{cleanInput.Substring(0, 3)}-{cleanInput.Substring(3, 3)}-{cleanInput.Substring(6)}";
    else if (cleanInput.Length > 3)
      return $"{cleanInput.Substring(0, 3)}-{cleanInput.Substring(3)}";
    else
      return cleanInput;
  }

  private async Task HandleKeyPress(KeyboardEventArgs e)
  {
    if (e.Key == "Enter" && IsValidSessionCodeFormat(manualSessionCode))
    {
      await JoinWithCode();
    }
  }

  private async Task ToggleQRScanner()
  {
    showQRScanner = !showQRScanner;
    
    if (showQRScanner)
    {
      await Task.Delay(100); // Give DOM time to render
      await StartQRScanner();
    }
    else
    {
      await StopQRScanner();
    }
  }

  private async Task StartQRScanner()
  {
    try
    {
      qrScannerStatus = "Initializing camera...";
      await JS.InvokeVoidAsync("initQRScanner", DotNetObjectReference.Create(this));
    }
    catch (Exception ex)
    {
      qrScannerStatus = $"Camera error: {ex.Message}";
    }
  }

  private async Task StopQRScanner()
  {
    try
    {
      await JS.InvokeVoidAsync("stopQRScanner");
      qrScannerStatus = "";
    }
    catch { }
  }

  [JSInvokable]
  public async Task OnQRCodeScanned(string scannedCode)
  {
    // Extract session code from URL or use directly
    var code = ExtractSessionCodeFromUrl(scannedCode);
    
    if (!string.IsNullOrWhiteSpace(code))
    {
      qrScannerStatus = "QR code detected! Redirecting...";
      await StopQRScanner();
      StateHasChanged(); // Force UI update
      
      // Redirect to join page with session code
      Navigation.NavigateTo($"/participant/join?sessionCode={code}", forceLoad: true);
    }
  }

  private string ExtractSessionCodeFromUrl(string input)
  {
    // If it's a URL, extract the session code
    if (input.Contains("/participant/join?sessionCode=", StringComparison.OrdinalIgnoreCase))
    {
      var uri = new Uri(input);
      var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
      return query["sessionCode"] ?? "";
    }
    
    // Otherwise, assume it's a direct code
    return input.Trim().ToUpper();
  }

  private async Task SetupSignalRConnection()
  {
    hubConnection = new HubConnectionBuilder()
    .WithUrl(Navigation.ToAbsoluteUri("/hubs/workshop"))
    .Build();

    // Setup event handlers for real-time updates
    hubConnection.On<object>("SessionStateChanged", async (data) =>
    {
      await InvokeAsync(StateHasChanged);
    });

    await hubConnection.StartAsync();
    await hubConnection.InvokeAsync("Subscribe", sessionCode);
  }

  private async Task JoinSession()
  {
    if (!CanJoin || sessionSummary == null) return;

    isLoading = true;
    errorMessage = "";

    try
    {
      var request = new JoinParticipantRequest
      {
        DisplayName = string.IsNullOrWhiteSpace(displayName) ? null : displayName.Trim(),
        IsAnonymous = isAnonymous,
        Dimensions = fieldValues.Where(kv => !string.IsNullOrWhiteSpace(kv.Value))
      .ToDictionary(kv => kv.Key, kv => kv.Value)
      };

      // Get session entity
      var sessionEntity = await SessionService.GetByCodeAsync(sessionSummary.Code);
      if (sessionEntity == null)
      {
        errorMessage = "Session not found.";
        return;
      }

      // Join session
      var participant = await ParticipantService.JoinAsync(
        sessionEntity.Id,
        request.DisplayName,
        request.IsAnonymous,
        request.Dimensions ?? new Dictionary<string, string?>(),
        DateTimeOffset.UtcNow);

      // Create participant token
      var auth = ParticipantTokenStore.Create(sessionEntity.Id, participant.Id);
      participantId = participant.Id;
      
      // Store participant info and token in browser storage to prevent duplicate joins
      await StoreParticipantSession(participant.Id, auth.Token, sessionSummary.Code);
      
      currentState = JoinState.Joined;
      
      // Redirect to activity page after a short delay
      await Task.Delay(1500);
      Navigation.NavigateTo($"/participant/activity/{sessionSummary.Code}?Pid={participant.Id}");
    }
    catch (Exception ex)
    {
      errorMessage = $"Could not join session: {ex.Message}";
    }
    finally
    {
      isLoading = false;
    }
  }

  private void BackToStaticJoin()
  {
    Navigation.NavigateTo($"/participant/join?code={sessionCode}");
  }

  private string GetFieldPlaceholder(JoinFormFieldDto field) =>
  field.Type switch
  {
    TechWayFit.Pulse.Contracts.Enums.FieldType.Text => "Enter text...",
    TechWayFit.Pulse.Contracts.Enums.FieldType.Number => "Enter number...",
    _ => ""
  };

  private bool CanJoin =>
  // If display name is required by schema, ensure it's provided
  (!DisplayNameRequired || !string.IsNullOrWhiteSpace(displayName)) &&
  // Validate other required join form fields (exclude displayName special-case)
  (joinFormFields?.Where(f => f.Required && !string.Equals(f.Id, "displayname", StringComparison.OrdinalIgnoreCase))
  .All(f => fieldValues.ContainsKey(f.Id) && !string.IsNullOrWhiteSpace(fieldValues[f.Id])) ?? true);

  private async Task<Guid?> CheckExistingParticipant()
  {
    try
    {
      // Check localStorage for existing participant session
      var storageKey = $"pulse_participant_{sessionCode}";
      var participantData = await JS.InvokeAsync<string?>("localStorage.getItem", storageKey);
      
      if (!string.IsNullOrEmpty(participantData))
      {
        // Parse stored participant ID
        if (Guid.TryParse(participantData, out var storedParticipantId))
        {
          // TODO: Optionally verify with server that participant is still active
          return storedParticipantId;
        }
      }
    }
    catch (Exception ex)
    {
      // If localStorage fails, continue with normal join flow
      Console.WriteLine($"Failed to check existing participant: {ex.Message}");
    }
    
    return null;
  }

  private async Task StoreParticipantSession(Guid participantId, string participantToken, string sessionCode)
  {
    try
    {
      // Store participant ID in localStorage
      var storageKey = $"pulse_participant_{sessionCode}";
      await JS.InvokeVoidAsync("localStorage.setItem", storageKey, participantId.ToString());
      
      // Store participant token in localStorage
      var tokenKey = $"pulse_participant_token_{sessionCode}";
      await JS.InvokeVoidAsync("localStorage.setItem", tokenKey, participantToken);
      
      // Also store session timestamp for cleanup
      var timestampKey = $"pulse_session_time_{sessionCode}";
      await JS.InvokeVoidAsync("localStorage.setItem", timestampKey, DateTimeOffset.UtcNow.ToUnixTimeSeconds().ToString());
    }
    catch (Exception ex)
    {
      // If localStorage fails, continue - not critical
      Console.WriteLine($"Failed to store participant session: {ex.Message}");
    }
  }

  public async ValueTask DisposeAsync()
  {
    if (hubConnection is not null)
    {
      await hubConnection.DisposeAsync();
    }
  }
}