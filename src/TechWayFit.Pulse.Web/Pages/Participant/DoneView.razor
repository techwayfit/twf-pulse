@page "/participant/done-view"
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>TechWayFit Pulse ‚Äî Done</PageTitle>

<div class="container-fluid" style="max-width: 1200px;">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 text-center py-4">
                    <h2 class="h3 fw-semibold text-success mb-2">Thanks! üôå</h2>
                    <p class="text-muted mb-0">Your input helped shape measurable next steps.</p>
                </div>
                
                <div class="card-body p-4">
                    @if (!string.IsNullOrEmpty(SessionCode))
                    {
                        <div class="alert alert-info d-flex align-items-center mb-4">
                            <div class="me-3 fs-5">‚ÑπÔ∏è</div>
                            <div>
                                <strong>Session @SessionCode has ended.</strong><br>
                                <small class="text-muted">Thank you for your participation!</small>
                            </div>
                        </div>
                    }
                    
                    <div class="mb-4">
                        <label for="finalThought" class="form-label fw-semibold">Final thought (optional)</label>
                        <textarea id="finalThought" 
                                  class="form-control" 
                                  rows="4" 
                                  @bind="finalThought" 
                                  placeholder="Anything else the team should know?"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" @onclick="SubmitAndExit" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                @:Submitting...
                            }
                            else
                            {
                                @:Submit & Exit
                            }
                        </button>
                        <a href="/home" class="btn btn-outline-secondary">Exit Without Submitting</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "session")]
    public string? SessionCode { get; set; }
    
    private string finalThought = "";
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        // Clean up participant session on page load
        if (!string.IsNullOrEmpty(SessionCode))
        {
            await CleanupParticipantSession();
        }
    }

    private async Task SubmitAndExit()
    {
        if (isSubmitting) return;
        
        isSubmitting = true;
        try
        {
            // Here you could submit the final thought to an API if needed
            // await ApiService.SubmitFinalThoughtAsync(SessionCode, finalThought);
            
            await Task.Delay(500); // Brief delay for user feedback
            Navigation.NavigateTo("/home");
        }
        catch (Exception ex)
        {
            // Handle submission error
            Console.WriteLine($"Error submitting final thought: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task CleanupParticipantSession()
    {
        if (string.IsNullOrEmpty(SessionCode)) return;
        
        try
        {
            await JSRuntime.InvokeVoidAsync("participantSession.removeFromSession", SessionCode);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cleaning up participant session: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        // Ensure cleanup on disposal
        await CleanupParticipantSession();
    }
}
