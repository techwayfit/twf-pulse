@page "/participant/activity/{SessionCode}"
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject TechWayFit.Pulse.Web.Services.IPulseApiService ApiService
@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Requests
@using TechWayFit.Pulse.Contracts.Enums
@using TechWayFit.Pulse.Web.Hubs
@using Microsoft.AspNetCore.SignalR.Client
@using System.Diagnostics
@using System.Text.Json
@using TechWayFit.Pulse.Domain.Models.ActivityConfigs
@implements IAsyncDisposable

<PageTitle>Workshop Activity - @(session?.Title ?? "Loading...")</PageTitle>

<main class="py-5">
  <div class="container" style="max-width: 1200px;">
    @if (isLoading)
    {
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted mb-0">Loading activity...</p>
        </div>
      </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="alert alert-danger mb-3" role="alert">
            <strong>Error:</strong> @errorMessage
          </div>
          <button class="btn btn-primary pulse-btn-primary" @onclick="LoadSession">Retry</button>
        </div>
      </div>
    }
    else if (session != null)
    {
      <!-- Session Header -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
            <div class="flex-grow-1">
              <h1 class="h5 fw-semibold mb-2 text-break" style="line-height: 1.3;">@session.Title</h1>
              <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="badge bg-light text-dark border px-2 py-1 small">
                  <strong>Code:</strong> @session.Code
                </span>
                <span class="badge @GetSessionStatusClass() px-2 py-1 small">
                  <span class="pulse-dot me-1"></span>
                  @session.Status
                </span>
              </div>
            </div>
            @if (!string.IsNullOrEmpty(participantDisplayName))
            {
              <div class="text-end flex-shrink-0">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <i class="fas fa-user text-muted small"></i>
                  <span class="fw-semibold">@participantDisplayName</span>
                </div>
                @if (contributionsRemaining >= 0)
                {
                  <div class="text-primary small">
                    @contributionsRemaining remaining
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Activity Content -->
      @if (session.Status == SessionStatus.Draft)
      {
        <div class="card border-0 shadow-lg" style="background: linear-gradient(145deg, #fff9e6, #ffffff);">
          <div class="card-body text-center py-5">
            <div class="display-1 text-warning mb-3">‚è±</div>
            <h4 class="h4 fw-bold mb-3">Waiting for facilitator to start...</h4>
            <p class="text-muted mb-0 fs-5">The workshop hasn't started yet. Please wait for the facilitator to begin the session.</p>
          </div>
        </div>
      }
      else if (session.Status == SessionStatus.Ended)
      {
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center py-5">
            <div class="display-1 text-success mb-3">‚úÖ</div>
            <h4 class="h5 fw-semibold mb-3">Workshop completed!</h4>
            <p class="text-muted mb-4">Thank you for participating in this workshop. The session has ended.</p>
            
            <div class="row justify-content-center">
              <div class="col-auto">
                <div class="text-center p-3 border rounded">
                  <div class="fw-bold fs-4 text-primary">@totalResponsesSubmitted</div>
                  <div class="small text-muted">responses submitted</div>
                </div>
              </div>
              <div class="col-auto">
                <div class="text-center p-3 border rounded">
                  <div class="fw-bold fs-4 text-success">@activitiesParticipated</div>
                  <div class="small text-muted">activities completed</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      }
      else if (currentActivity != null)
      {
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <!-- Activity Header -->
            <div class="mb-4 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
                <div class="flex-grow-1">
                  <h2 class="h4 fw-bold mb-0 text-break" style="line-height: 1.4;">@currentActivity.Title</h2>
                </div>
                <div class="d-flex gap-2 flex-shrink-0">
                  <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2">
                    @currentActivity.Type
                  </span>
                  <span class="badge @GetActivityStatusClass() px-3 py-2">
                    @currentActivity.Status
                  </span>
                </div>
              </div>
              @if (!string.IsNullOrEmpty(currentActivity.Prompt))
              {
                <p class="text-muted mb-0 fs-6">@currentActivity.Prompt</p>
              }
            </div>

  @if (currentActivity.Status == TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open)
       {
                  <div class="response-section mt-4">
     @if (currentActivity.Type == ActivityType.Poll)
  {
        @RenderPollActivity()
  }
              else if (currentActivity.Type == ActivityType.WordCloud)
            {
             @RenderWordCloudActivity()
        }
        else if (currentActivity.Type == ActivityType.Rating)
     {
   @RenderRatingActivity()
       }
           else if (currentActivity.Type == ActivityType.GeneralFeedback)
      {
      @RenderGeneralFeedbackActivity()
      }
   else
          {
                @RenderGenericActivity()
     }
   </div>
   }
            else
            {
              <div class="alert alert-warning d-flex align-items-center" role="alert">
                <div class="me-3 fs-4">üîí</div>
                <div>
                  <h6 class="alert-heading mb-1">Activity is not open</h6>
                  <div class="mb-0">Wait for the facilitator to open this activity.</div>
                </div>
              </div>
            }
          </div>
        </div>
      }
      else
      {
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center py-5">
            <div class="display-1 text-info mb-3">‚è≥</div>
            <h4 class="h5 fw-semibold mb-3">No active activity</h4>
            <p class="text-muted mb-0">Wait for the facilitator to start an activity.</p>
          </div>
        </div>
      } 
    }
  </div>
</main>

@code {
    [Parameter] public string SessionCode { get; set; } = "";
    [Parameter] [SupplyParameterFromQuery] public Guid? Pid { get; set; }

    private SessionSummaryResponse? session;
    private AgendaActivityResponse? currentActivity;
    private bool isLoading = true;
    private string errorMessage = "";
    private string participantDisplayName = "";
private int contributionsRemaining = -1;
    private int totalResponsesSubmitted = 0;
    private int activitiesParticipated = 0;
  
    // Response submission state
  private bool isSubmittingResponse = false;
    private bool hasSubmittedResponse = false;
    private string submitMessage = "";
    private bool submitSuccess = false;
 
    // Poll activity state
    private List<string> selectedPollOptionIds = new();
    private string? customPollText;
    private PollConfig? pollConfig;
    
    // WordCloud state
    private string? wordCloudText;
    private WordCloudConfig? wordCloudConfig;
    
    // Rating state
    private int selectedRating = 0;
    private RatingConfig? ratingConfig;
    private string? ratingComment;
    
    // GeneralFeedback state
    private string? feedbackText;
    private string? selectedFeedbackCategory;
    private GeneralFeedbackConfig? feedbackConfig;
    
    // Generic state
    private string? genericResponseText;

  private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadSession();
        await InitializeSignalR();
    }

    private async Task LoadSession()
    {
    isLoading = true;
  errorMessage = "";

      try
        {
            session = await ApiService.GetSessionAsync(SessionCode);
   
         // Load current activity
          if (session.CurrentActivityId.HasValue)
            {
    var activities = await ApiService.GetAgendaAsync(SessionCode);
    var newActivity = activities.FirstOrDefault(a => a.ActivityId == session.CurrentActivityId);
         
          // Reset submission state if activity changed
          if (newActivity != null && (currentActivity == null || currentActivity.ActivityId != newActivity.ActivityId))
          {
              hasSubmittedResponse = false;
              submitMessage = "";
              submitSuccess = false;
              ResetFormFields();
          }
          
          currentActivity = newActivity;
         
          // Parse activity configuration
   if (currentActivity != null)
    {
           ParseActivityConfig();
 }
      }
            
    // TODO: Load participant dashboard/stats
      if (Pid.HasValue)
{
         // Load participant-specific data
        participantDisplayName = "Participant"; // Placeholder
        contributionsRemaining = 3; // Placeholder
  totalResponsesSubmitted = 0; // Placeholder
 activitiesParticipated = 0; // Placeholder
            }
        }
        catch (HttpRequestException ex)
        {
 errorMessage = $"Network error: {ex.Message}";
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
      }
        catch (Exception ex)
      {
            errorMessage = $"Unexpected error: {ex.Message}";
 }
        finally
        {
     isLoading = false;
       StateHasChanged();
        }
    }

    private void ParseActivityConfig()
    {
        if (currentActivity == null || string.IsNullOrEmpty(currentActivity.Config))
  return;

        try
        {
            var options = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            };
            
            switch (currentActivity.Type)
            {
                case ActivityType.Poll:
                    Debug.WriteLine($"Parsing poll config: {currentActivity.Config}");
                    pollConfig = JsonSerializer.Deserialize<PollConfig>(currentActivity.Config, options);
                    Debug.WriteLine($"Poll config parsed. Options count: {pollConfig?.Options?.Count ?? 0}");
                    if (pollConfig?.Options != null)
                    {
                        foreach (var option in pollConfig.Options)
                        {
                            Debug.WriteLine($"Option: {option.Id} - {option.Label}");
                        }
                    }
                    break;
                case ActivityType.WordCloud:
                    Debug.WriteLine($"Parsing word cloud config: {currentActivity.Config}");
                    wordCloudConfig = JsonSerializer.Deserialize<WordCloudConfig>(currentActivity.Config, options);
                    Debug.WriteLine($"Word cloud config parsed. Max words: {wordCloudConfig?.MaxWords ?? 0}");
                    break;
                case ActivityType.Rating:
                    Debug.WriteLine($"Parsing rating config: {currentActivity.Config}");
                    ratingConfig = JsonSerializer.Deserialize<RatingConfig>(currentActivity.Config, options);
                    Debug.WriteLine($"Rating config parsed. Scale: {ratingConfig?.Scale ?? 0}, DisplayType: {ratingConfig?.DisplayType}");
                    Debug.WriteLine($"Raw DisplayType value in JSON: {(ratingConfig != null ? JsonSerializer.Serialize(ratingConfig) : "NULL")}");
                    break;
                case ActivityType.GeneralFeedback:
                    feedbackConfig = JsonSerializer.Deserialize<GeneralFeedbackConfig>(currentActivity.Config, options);
                    break;
            }
        }
        catch (JsonException ex)
        {
            Debug.WriteLine($"Failed to parse activity config: {ex.Message}");
            Debug.WriteLine($"Raw config: {currentActivity.Config}");
        }
 }

    private async Task InitializeSignalR()
    {
        if (string.IsNullOrEmpty(SessionCode)) return;

     try
        {
    hubConnection = new HubConnectionBuilder()
     .WithUrl($"{Navigation.BaseUri}hubs/workshop")
            .WithAutomaticReconnect()
 .Build();

  hubConnection.On<SessionStateChangedEvent>("SessionStateChanged", async (sessionEvent) =>
  {
           await InvokeAsync(async () =>
     {
      if (sessionEvent.SessionCode == SessionCode)
           {
                await LoadSession();
                
                // If session ended, clean up and redirect
                if (session?.Status == SessionStatus.Ended)
                {
                    await CleanupParticipantSession();
                    Navigation.NavigateTo($"/participant/done-view?session={SessionCode}");
                    return;
                }
                
       StateHasChanged();
       }
     });
            });

       hubConnection.On<ActivityStateChangedEvent>("ActivityStateChanged", async (activityEvent) =>
            {
    await InvokeAsync(async () =>
        {
          if (activityEvent.SessionCode == SessionCode)
    {
      await LoadSession();
        StateHasChanged();
    }
   });
       });

            hubConnection.On<DashboardUpdatedEvent>("DashboardUpdated", async (dashboardEvent) =>
            {
        await InvokeAsync(() =>
    {
               if (dashboardEvent.SessionCode == SessionCode)
        {
  Debug.WriteLine($"Dashboard updated for activity {dashboardEvent.ActivityId}");
       StateHasChanged();
          }
     });
 });

await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("Subscribe", SessionCode);
      }
        catch (Exception ex)
        {
            Debug.WriteLine($"SignalR connection error: {ex.Message}");
 }
    }

    // ===================
    // RENDER METHODS
    // ===================
    
    private RenderFragment RenderPollActivity() => __builder =>
    {
        <div class="poll-activity">
          <div class="mb-4">
            <h3 class="h5 fw-semibold text-secondary mb-4">@(pollConfig?.AllowMultiple == true ? "Select one or more:" : "Make your choice:")</h3>
  
            @if (pollConfig != null && pollConfig.Options != null && pollConfig.Options.Count > 0)
            {
              <div class="poll-options mb-4">
                             @foreach (var option in pollConfig.Options)
                {
                  var optionId = option.Id;
                  var isSelected = selectedPollOptionIds.Contains(optionId);
                  <div class="form-check poll-option mb-3 p-3 border rounded-3 position-relative 
                        @(isSelected ? "border-primary bg-primary bg-opacity-10 shadow-sm" : "border-2") 
                        poll-option-interactive" 
                    style="cursor: pointer; transition: all 0.2s ease-in-out;"
                    @onclick="@(async () => await HandlePollOptionClick(optionId, pollConfig.AllowMultiple))">
                    @if (pollConfig.AllowMultiple)
                    {
                      <input class="form-check-input position-absolute" 
                        type="checkbox" 
                        id="poll-@optionId"
                        checked="@isSelected"
                        style="top: 1rem; left: 1rem; width: 1.25rem; height: 1.25rem;"
                        @onchange="@((e) => TogglePollOption(optionId))" />
                    }
                    else
                    {
                      <input class="form-check-input position-absolute" 
                        type="radio" 
                        name="pollChoice"
                        id="poll-@optionId"
                        checked="@isSelected"
                        style="top: 1rem; left: 1rem; width: 1.25rem; height: 1.25rem;"
                        @onchange="@((e) => SelectPollOption(optionId))" />
                    }
                    <label class="form-check-label w-100 ps-4 ms-1" for="poll-@optionId" style="cursor: pointer;">
                      <strong class="d-block mb-1 fs-6">@option.Label</strong>
                      @if (!string.IsNullOrEmpty(option.Description))
                      {
                        <small class="text-muted d-block">@option.Description</small>
                      }
                    </label>
                  </div>
                             }
  
                @if (pollConfig.AllowCustomOption)
                {
                  var isCustomSelected = selectedPollOptionIds.Contains("custom");
                  <div class="form-check poll-option mb-3 p-3 border rounded-3 position-relative 
                        @(isCustomSelected ? "border-primary bg-primary bg-opacity-10 shadow-sm" : "border-2") 
                        poll-option-interactive" 
                    style="cursor: pointer; transition: all 0.2s ease-in-out;"
                    @onclick="@(async () => await HandlePollOptionClick("custom", pollConfig.AllowMultiple))">
                    @if (pollConfig.AllowMultiple)
                    {
                      <input class="form-check-input position-absolute" 
                        type="checkbox" 
                        id="poll-custom"
                        checked="@isCustomSelected"
                        style="top: 1rem; left: 1rem; width: 1.25rem; height: 1.25rem;"
                        @onchange="@((e) => TogglePollOption("custom"))" />
                    }
                    else
                    {
                      <input class="form-check-input position-absolute" 
                        type="radio" 
                        name="pollChoice"
                        id="poll-custom"
                        checked="@isCustomSelected"
                        style="top: 1rem; left: 1rem; width: 1.25rem; height: 1.25rem;"
                        @onchange="@((e) => SelectPollOption("custom"))" />
                    }
                    <label class="form-check-label w-100 ps-4 ms-1" for="poll-custom" style="cursor: pointer;">
                      <strong class="d-block mb-2 fs-6">Other</strong>
                      @if (isCustomSelected)
                      {
                        <input type="text" 
                          class="form-control" 
                          placeholder="@pollConfig.CustomOptionPlaceholder"
                          @bind="customPollText"
                          @onclick:stopPropagation="true"
                          maxlength="100" />
                      }
                    </label>
                  </div>
                }
              </div>
            }
            else
            {
              <div class="alert alert-warning">
                @if (pollConfig == null)
                {
                  <span>Poll configuration is null.</span>
                }
                else if (pollConfig.Options == null)
                {
                  <span>Poll options are null.</span>
                }
                else if (pollConfig.Options.Count == 0)
                {
                  <span>No poll options found.</span>
                }
                else
                {
                  <span>No poll options configured.</span>
                }
              </div>
            }
          </div>
            
          <button class="btn btn-primary btn-lg w-100 py-3" 
            @onclick="HandleSubmitPollResponse" 
            disabled="@(isSubmittingResponse || selectedPollOptionIds.Count == 0 || hasSubmittedResponse)">
            @GetSubmitButtonText()
          </button>
          
          @if (!string.IsNullOrEmpty(submitMessage))
          {
              <div class="alert @(submitSuccess ? "alert-success" : "alert-danger") mt-3 mb-0">
                  @submitMessage
                  @if (submitMessage.Contains("ERROR") && submitMessage.Contains("Pid"))
                  {
                      <div class="mt-2">
                          <a href="/participant/join?code=@SessionCode" class="btn btn-primary btn-sm">Rejoin Session</a>
                      </div>
                  }
              </div>
          }
        </div>
    };

    private RenderFragment RenderWordCloudActivity() => __builder =>
    {
        <div class="wordcloud-activity">
            <div class="mb-4">
              <h3 class="h5 fw-semibold text-secondary mb-3">Share your thoughts:</h3>
              <label class="form-label fw-semibold">Your words</label>
              <textarea class="form-control form-control-lg" 
                  value="@wordCloudText" 
                  @oninput="OnWordCloudTextChanged"
                  rows="4"
                  style="resize: vertical; min-height: 100px;"
                  placeholder="@(wordCloudConfig?.Placeholder ?? "Enter your words here...")"
                  maxlength="@(wordCloudConfig?.MaxWordLength * wordCloudConfig?.MaxWords ?? 150)"></textarea>
              <div class="form-text d-flex justify-content-between">
                  <span>
                      @((wordCloudText?.Length ?? 0)) / @(wordCloudConfig?.MaxWordLength * wordCloudConfig?.MaxWords ?? 150) characters
                  </span>
                  @if (wordCloudConfig != null)
                  {
                      <span>Max @wordCloudConfig.MaxWords words</span>
                  }
              </div>
            </div>
            @if (wordCloudConfig != null && !IsWordCloudInputValid() && !string.IsNullOrWhiteSpace(wordCloudText))
            {
                <div class="alert alert-warning mb-3">
                    @GetWordCloudValidationMessage()
                </div>
            }
            <button class="btn btn-primary btn-lg w-100 py-3" 
                @onclick="SubmitWordCloudResponse" 
                disabled="@(isSubmittingResponse || string.IsNullOrWhiteSpace(wordCloudText) || hasSubmittedResponse || !IsWordCloudInputValid())">
                @GetSubmitButtonText()
            </button>
        </div>
    };

    private RenderFragment RenderRatingActivity() => __builder =>
    {
        var scale = ratingConfig?.Scale ?? 5;
        var displayType = ratingConfig?.DisplayType ?? TechWayFit.Pulse.Domain.Models.ActivityConfigs.RatingDisplayType.Buttons;
        
        <div class="rating-activity">
          <div class="text-center mb-4">
            <h3 class="h5 fw-semibold text-secondary mb-4">Rate this:</h3>
            
            @if (!string.IsNullOrEmpty(ratingConfig?.MinLabel) || !string.IsNullOrEmpty(ratingConfig?.MaxLabel))
            {
              <div class="d-flex justify-content-between text-muted small mb-2">
                <span>@(ratingConfig?.MinLabel ?? "Low")</span>
                <span>@(ratingConfig?.MaxLabel ?? "High")</span>
              </div>
            }
            
            @if (displayType == TechWayFit.Pulse.Domain.Models.ActivityConfigs.RatingDisplayType.Stars)
            {
              <div class="rating-scale d-flex justify-content-center gap-2 mb-4 flex-wrap">
                @for (int i = 1; i <= scale; i++)
                {
                  var rating = i;
                  <button type="button" class="btn btn-link rating-star @(selectedRating >= rating ? "active" : "")"
                    style="font-size: 48px; line-height: 1; padding: 0.25rem; text-decoration: none; color: @(selectedRating >= rating ? "#ffc107" : "#dee2e6"); transition: all 0.2s ease;"
                    @onclick="() => SetRating(rating)">
                    @if (selectedRating >= rating)
                    {
                      <text>&#9733;</text>
                    }
                    else
                    {
                      <text>&#9734;</text>
                    }
                  </button>
                }
              </div>
            }
            else if (displayType == TechWayFit.Pulse.Domain.Models.ActivityConfigs.RatingDisplayType.Slider)
            {
              <div class="mb-4">
                <input type="range" class="form-range" 
                  min="1" max="@scale" 
                  value="@selectedRating"
                  @oninput="@((e) => SetRating(int.Parse(e.Value?.ToString() ?? "0")))"
                  style="height: 8px;" />
                @if (selectedRating > 0)
                {
                  <div class="text-center mt-3">
                    <span class="badge bg-primary" style="font-size: 24px; padding: 0.5rem 1rem;">@selectedRating</span>
                  </div>
                }
              </div>
            }
            else
            {
              <div class="rating-scale d-flex justify-content-center gap-3 mb-4 flex-wrap">
                @for (int i = 1; i <= scale; i++)
                {
                  var rating = i;
                  <button class="btn btn-outline-primary rating-button @(selectedRating == rating ? "active" : "")"
                    style="width: 70px; height: 70px; font-size: 28px; font-weight: 600; border-width: 2px; transition: all 0.2s ease;"
                    @onclick="() => SetRating(rating)">
                    @rating
                  </button>
                }
              </div>
            }
            
            @if (selectedRating > 0)
            {
              <div class="text-muted small mb-3">
                You selected: <strong class="text-primary">@selectedRating</strong>
              </div>
            }
          </div>
          
          @if (ratingConfig?.AllowComments == true)
          {
            <div class="mb-4">
              <label class="form-label fw-semibold">
                Comments @(ratingConfig?.CommentRequired == true ? "<span class='text-danger'>*</span>" : "<span class='text-muted'>(optional)</span>")
              </label>
              <textarea class="form-control" 
                value="@ratingComment" 
                @oninput="@((e) => { ratingComment = e.Value?.ToString(); if (hasSubmittedResponse) { hasSubmittedResponse = false; submitMessage = ""; } })"
                rows="3"
                placeholder="@(ratingConfig?.CommentPlaceholder ?? "Tell us more (optional)")"
                maxlength="500"></textarea>
            </div>
          }
          
          <button class="btn btn-primary btn-lg w-100 py-3" 
            @onclick="SubmitRatingResponse" 
            disabled="@(isSubmittingResponse || selectedRating == 0 || hasSubmittedResponse || (ratingConfig?.CommentRequired == true && string.IsNullOrWhiteSpace(ratingComment)))">
            @GetSubmitButtonText()
          </button>
        </div>
    };

  private RenderFragment RenderGeneralFeedbackActivity() => __builder =>
    {
    <div class="feedback-activity">
      <div class="mb-4">
        <h3 class="h5 fw-semibold text-secondary mb-3">Share your feedback:</h3>
      
        @if (feedbackConfig?.CategoriesEnabled == true && feedbackConfig.Categories != null)
        {
          <div class="mb-4">
            <label class="form-label fw-semibold">Category @(feedbackConfig.RequireCategory ? "<span class='text-danger'>*</span>" : "<span class='text-muted'>(optional)</span>")</label>
            <div class="btn-group w-100" role="group">
              @foreach (var category in feedbackConfig.Categories)
              {
                var catId = category.Id;
                <button type="button" 
                  class="btn btn-outline-secondary @(selectedFeedbackCategory == catId ? "active" : "") px-3 py-2"
                  @onclick="() => selectedFeedbackCategory = catId">
                  @if (!string.IsNullOrEmpty(category.Icon))
                  {
                    <span class="me-1">@category.Icon</span>
                  }
                  @category.Label
                </button>
              }
            </div>
          </div>
        }
      
        <div class="mb-4">
          <label class="form-label fw-semibold">Your feedback</label>
          <textarea class="form-control form-control-lg" 
            value="@feedbackText" 
            @oninput="OnFeedbackTextChanged"
            rows="6"
            style="resize: vertical; min-height: 120px;"
            placeholder="@(feedbackConfig?.Placeholder ?? "Share your thoughts, problems, or suggestions...")"
            maxlength="@(feedbackConfig?.MaxLength ?? 1000)"></textarea>
          @if (feedbackConfig?.ShowCharacterCount == true)
          {
            <div class="form-text">
              @((feedbackText?.Length ?? 0)) / @(feedbackConfig?.MaxLength ?? 1000) characters
            </div>
          }
        </div>
      </div>
            
      <button class="btn btn-primary btn-lg w-100 py-3" 
        @onclick="SubmitGeneralFeedbackResponse" 
        disabled="@(isSubmittingResponse || IsGeneralFeedbackInvalid() || hasSubmittedResponse)">
        @GetSubmitButtonText()
      </button>
    </div>
    };

    private RenderFragment RenderGenericActivity() => __builder =>
    {
      <div class="generic-activity">
        <div class="mb-4">
          <h3 class="h5 fw-semibold text-secondary mb-2">Activity type: @currentActivity?.Type</h3>
          <p class="text-muted small">This activity type is not yet fully implemented.</p>
          <div class="mb-3">
            <label class="form-label fw-semibold">Your response</label>
            <textarea class="form-control form-control-lg" 
              value="@genericResponseText" 
              @oninput="OnGenericTextChanged"
              rows="5"
              style="resize: vertical; min-height: 120px;"
              placeholder="Enter your response..."
              maxlength="1000"></textarea>
          </div>
        </div>
        <button class="btn btn-primary btn-lg w-100 py-3" 
          @onclick="SubmitGenericResponse" 
          disabled="@(isSubmittingResponse || string.IsNullOrWhiteSpace(genericResponseText) || hasSubmittedResponse)">
          @GetSubmitButtonText()
        </button>
      </div>
    };

    // ===================
    // POLL METHODS
    // ===================

    private void SelectPollOption(string optionId)
    {
        selectedPollOptionIds.Clear();
        selectedPollOptionIds.Add(optionId);
        hasSubmittedResponse = false;
        submitMessage = "";
    }

    private void TogglePollOption(string optionId)
    {
        if (selectedPollOptionIds.Contains(optionId))
        {
            selectedPollOptionIds.Remove(optionId);
        }
        else
        {
            selectedPollOptionIds.Add(optionId);
        }
        hasSubmittedResponse = false;
        submitMessage = "";
    }

    private async Task HandlePollOptionClick(string optionId, bool allowMultiple)
    {
        if (allowMultiple)
        {
            TogglePollOption(optionId);
        }
        else
        {
            SelectPollOption(optionId);
        }
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleSubmitPollResponse()
    {
        try
        {
            await SubmitPollResponse();
        }
        catch (Exception ex)
        {
            submitMessage = $"Error: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task SubmitPollResponse()
    {        
        if (currentActivity == null || !Pid.HasValue) 
        {
            submitMessage = "ERROR: currentActivity is null or Pid is not set. Please try rejoining the session.";
            StateHasChanged();
            return;
        }

        var payload = new
        {
            selectedOptionIds = selectedPollOptionIds,
            customOptionText = selectedPollOptionIds.Contains("custom") ? customPollText : null
        };

        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    // ===================
    // WORD CLOUD METHODS
    // ===================

    private void OnWordCloudTextChanged(ChangeEventArgs e)
    {
        wordCloudText = e.Value?.ToString();
        if (hasSubmittedResponse)
        {
            hasSubmittedResponse = false;
            submitMessage = "";
        }
    }

    private async Task SubmitWordCloudResponse()
    {
        if (currentActivity == null || !Pid.HasValue || string.IsNullOrWhiteSpace(wordCloudText)) return;

        var payload = new { text = wordCloudText.Trim() };
        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    private bool IsWordCloudInputValid()
    {
        if (string.IsNullOrWhiteSpace(wordCloudText) || wordCloudConfig == null) 
            return string.IsNullOrWhiteSpace(wordCloudText); // Allow empty if no config

        var words = wordCloudText.Trim().Split(new[] { ' ', '\t', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);
        
        // Check word count
        if (words.Length > wordCloudConfig.MaxWords)
            return false;
            
        // Check individual word lengths
        foreach (var word in words)
        {
            if (word.Length < wordCloudConfig.MinWordLength || word.Length > wordCloudConfig.MaxWordLength)
                return false;
        }

        return true;
    }

    private string GetWordCloudValidationMessage()
    {
        if (string.IsNullOrWhiteSpace(wordCloudText) || wordCloudConfig == null) 
            return "";

        var words = wordCloudText.Trim().Split(new[] { ' ', '\t', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);
        
        if (words.Length > wordCloudConfig.MaxWords)
            return $"Too many words. Maximum allowed: {wordCloudConfig.MaxWords}, you have: {words.Length}";
            
        foreach (var word in words)
        {
            if (word.Length < wordCloudConfig.MinWordLength)
                return $"Word '{word}' is too short. Minimum length: {wordCloudConfig.MinWordLength} characters";
            if (word.Length > wordCloudConfig.MaxWordLength)
                return $"Word '{word}' is too long. Maximum length: {wordCloudConfig.MaxWordLength} characters";
        }

        return "";
    }

    // ===================
    // RATING METHODS
// ===================

    private void SetRating(int rating)
    {
        selectedRating = rating;
  hasSubmittedResponse = false;
        submitMessage = "";
    }

    private async Task SubmitRatingResponse()
    {
        if (currentActivity == null || !Pid.HasValue) return;

        var payload = new { 
            rating = selectedRating, 
            scale = ratingConfig?.Scale ?? 5,
            comment = ratingComment
        };
        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    // ===================
    // GENERAL FEEDBACK METHODS
    // ===================

    private void OnFeedbackTextChanged(ChangeEventArgs e)
    {
        feedbackText = e.Value?.ToString();
        if (hasSubmittedResponse)
        {
            hasSubmittedResponse = false;
            submitMessage = "";
        }
    }

    private bool IsGeneralFeedbackInvalid()
    {
        if (string.IsNullOrWhiteSpace(feedbackText)) return true;
        
        var minLength = feedbackConfig?.MinLength ?? 10;
        if (feedbackText.Length < minLength) return true;
     
        if (feedbackConfig?.RequireCategory == true && string.IsNullOrEmpty(selectedFeedbackCategory))
            return true;
        
        return false;
    }

    private async Task SubmitGeneralFeedbackResponse()
    {
 if (currentActivity == null || !Pid.HasValue || IsGeneralFeedbackInvalid()) return;

        var payload = new
{
      text = feedbackText!.Trim(),
    category = selectedFeedbackCategory,
  isAnonymous = false,
      characterCount = feedbackText.Length
        };

        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    // ===================
    // GENERIC METHODS
    // ===================

    private void OnGenericTextChanged(ChangeEventArgs e)
    {
        genericResponseText = e.Value?.ToString();
        if (hasSubmittedResponse)
        {
            hasSubmittedResponse = false;
            submitMessage = "";
        }
    }

    private async Task SubmitGenericResponse()
    {
        if (currentActivity == null || !Pid.HasValue || string.IsNullOrWhiteSpace(genericResponseText)) return;

        var payload = new { text = genericResponseText.Trim() };
        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    // ===================
    // COMMON METHODS
    // ===================

    private async Task SubmitResponse(string payload)
    {        
        if (currentActivity == null || !Pid.HasValue) 
        {
            submitMessage = "ERROR: Validation failed in SubmitResponse";
            StateHasChanged();
            return;
        }

        isSubmittingResponse = true;
        submitMessage = "";
        submitSuccess = false;
        StateHasChanged();

        try
        {
            // Convert to proper request type
            var request = new TechWayFit.Pulse.Contracts.Requests.SubmitResponseRequest
            {
                ParticipantId = Pid.Value,
                Payload = payload
            };

            await ApiService.SubmitResponseAsync(SessionCode, currentActivity.ActivityId, request);

            hasSubmittedResponse = true;
            totalResponsesSubmitted++;
            contributionsRemaining--;
            submitSuccess = true;
            submitMessage = "Response submitted successfully!";
            
            ResetFormFields();
        }
        catch (Exception ex)
        {
            submitSuccess = false;
            submitMessage = $"API Error: {ex.Message}";
        }
        finally
        {
            isSubmittingResponse = false;
            StateHasChanged();
        }
    }

  private void ResetFormFields()
    {
     selectedPollOptionIds.Clear();
        customPollText = null;
        wordCloudText = "";
   selectedRating = 0;
        feedbackText = "";
    selectedFeedbackCategory = null;
genericResponseText = "";
    }

    private string GetSubmitButtonText()
{
        if (hasSubmittedResponse)
          return "Response Submitted ‚úì";
        if (isSubmittingResponse)
            return "Submitting...";
        return "Submit Response";
  }

    private string GetStatusBadgeClass()
    {
        return currentActivity?.Status switch
        {
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending => "secondary",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open => "success",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Closed => "danger",
            _ => "secondary"
        };
    }

    private string GetSessionStatusClass()
    {
        return session?.Status switch
        {
            SessionStatus.Draft => "bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25",
            SessionStatus.Live => "bg-success bg-opacity-10 text-success border border-success border-opacity-25",
            SessionStatus.Ended => "bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25",
            _ => "bg-light text-dark border"
        };
    }

    private string GetActivityStatusClass()
    {
        return currentActivity?.Status switch
        {
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending => "bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open => "bg-success bg-opacity-10 text-success border border-success border-opacity-25",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Closed => "bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25",
            _ => "bg-light text-dark border"
        };
    }

    private async Task CleanupParticipantSession()
    {
        try
        {
            await JS.InvokeVoidAsync("participantSession.removeFromSession", SessionCode);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error cleaning up participant session: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
   try
       {
     await hubConnection.InvokeAsync("Unsubscribe", SessionCode);
     await hubConnection.DisposeAsync();
            }
            catch (Exception ex)
            {
     Debug.WriteLine($"Error disposing SignalR connection: {ex.Message}");
   }
        }
        
        // Clean up participant session when leaving
        await CleanupParticipantSession();
    }

    // ===================
    // CONFIG CLASSES (Temporary - move to shared later)
    // ===================

    private class PollConfig
    {
        public List<PollOption> Options { get; set; } = new();
    public bool AllowMultiple { get; set; }
        public bool AllowCustomOption { get; set; }
   public string CustomOptionPlaceholder { get; set; } = "Other (please specify)";
    }

 private class PollOption
    {
        public string Id { get; set; } = "";
   public string Label { get; set; } = "";
        public string? Description { get; set; }
    }

    private class GeneralFeedbackConfig
    {
        public int MaxLength { get; set; } = 1000;
        public int MinLength { get; set; } = 10;
    public string Placeholder { get; set; } = "";
        public bool CategoriesEnabled { get; set; }
        public List<FeedbackCategory> Categories { get; set; } = new();
 public bool RequireCategory { get; set; }
        public bool ShowCharacterCount { get; set; } = true;
    }

    private class FeedbackCategory
    {
        public string Id { get; set; } = "";
        public string Label { get; set; } = "";
        public string? Icon { get; set; }
    }

    private class RatingConfig
    {
        public int Scale { get; set; } = 5;
        public string? MinLabel { get; set; }
        public string? MaxLabel { get; set; }
        public string? MidpointLabel { get; set; }
        public bool AllowComments { get; set; }
        public bool CommentRequired { get; set; }
        public string? CommentPlaceholder { get; set; }
        public TechWayFit.Pulse.Domain.Models.ActivityConfigs.RatingDisplayType DisplayType { get; set; }
        public bool ShowAverageAfterSubmit { get; set; }
    }
}