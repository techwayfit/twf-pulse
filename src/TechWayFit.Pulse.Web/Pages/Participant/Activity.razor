@page "/participant/activity/{SessionCode}"
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject TechWayFit.Pulse.Application.Abstractions.Services.ISessionService SessionService
@inject TechWayFit.Pulse.Application.Abstractions.Services.IActivityService ActivityService
@inject TechWayFit.Pulse.Application.Abstractions.Services.IResponseService ResponseService
@inject TechWayFit.Pulse.Web.Services.IHubNotificationService HubNotifications
@inject TechWayFit.Pulse.Web.Api.IParticipantTokenStore ParticipantTokenStore
@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Requests
@using TechWayFit.Pulse.Contracts.Enums
@using TechWayFit.Pulse.Web.Api
@using TechWayFit.Pulse.Web.Hubs
@using TechWayFit.Pulse.Web.Components.Participant.Activities
@using Microsoft.AspNetCore.SignalR.Client
@using System.Diagnostics
@using System.Text.Json
@implements IAsyncDisposable

<PageTitle>Workshop Activity - @(session?.Title ?? "Loading...")</PageTitle>

<main class="py-5">
    <div class="container container-wide">


        @if (isLoading)
        {
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted mb-0">Loading activity...</p>
                </div>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="alert alert-danger mb-3" role="alert">
                        <strong>Error:</strong> @errorMessage
                    </div>
                    <button class="btn btn-primary pulse-btn-primary" @onclick="LoadSession">Retry</button>
                </div>
            </div>
        }
        else if (session != null)
        {
            <!-- Session Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
                        <div class="flex-grow-1">
                            <h1 class="h5 fw-semibold mb-2 text-break lh-tight">@session.Title</h1>
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <span class="badge bg-light text-dark border px-2 py-1 small">
                                    <strong>Code:</strong> @session.Code
                                </span>
                                <span class="badge @GetSessionStatusClass() px-2 py-1 small">
                                    <span class="pulse-dot me-1"></span>
                                    @session.Status
                                </span>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(participantDisplayName))
                        {
                            <div class="text-end flex-shrink-0">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="fas fa-user text-muted small"></i>
                                    <span class="fw-semibold">@participantDisplayName</span>
                                </div>
                                @if (contributionsRemaining >= 0)
                                {
                                    <div class="text-primary small">
                                        @contributionsRemaining remaining
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Activity Content -->
            @if (session.Status == SessionStatus.Draft)
            {
                <div class="card border-0 shadow-lg bg-warning-subtle">
                    <div class="card-body text-center py-5">
                        <div class="mb-3"><i class="ics ics-hourglass ic-2xl text-warning"></i></div>
                        <h4 class="h4 fw-bold mb-3">Waiting for facilitator to start...</h4>
                        <p class="text-muted mb-0 fs-5">The workshop hasn't started yet. Please wait for the facilitator to begin the session.</p>
                    </div>
                </div>
            }
            else if (session.Status == SessionStatus.Ended)
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="mb-3"><i class="fas fa-check-circle text-success fa-3x" aria-hidden="true"></i></div>
                        <h4 class="h5 fw-semibold mb-3">Workshop completed!</h4>
                        <p class="text-muted mb-4">Thank you for participating in this workshop. The session has ended.</p>

                        <div class="row justify-content-center">
                            <div class="col-auto">
                                <div class="text-center p-3 border rounded">
                                    <div class="fw-bold fs-4 text-primary">@totalResponsesSubmitted</div>
                                    <div class="small text-muted">responses submitted</div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <div class="text-center p-3 border rounded">
                                    <div class="fw-bold fs-4 text-success">@activitiesParticipated</div>
                                    <div class="small text-muted">activities completed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (currentActivity != null)
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <!-- Activity Header -->
                        <div class="mb-4 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
                                <div class="flex-grow-1">
                                    <h2 class="h4 fw-bold mb-0 text-break lh-snug">@currentActivity.Title</h2>
                                </div>
                                <div class="d-flex gap-2 flex-shrink-0">
                                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2">
                                        @currentActivity.Type
                                    </span>
                                    <span class="badge @GetActivityStatusClass() px-3 py-2">
                                        @currentActivity.Status
                                    </span>
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(currentActivity.Prompt))
                            {
                                <p class="text-muted mb-0 fs-6">@currentActivity.Prompt</p>
                            }
                        </div>

                        <div class="response-section mt-4">
                            @if (currentActivity.Status == TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open)
                            {
                                @if (!participantId.HasValue)
                                {
                                    <div class="alert alert-danger d-flex align-items-center" role="alert">
                                        <div class="me-3"><i class="fas fa-exclamation-circle fa-lg" aria-hidden="true"></i></div>
                                        <div>
                                            <h6 class="alert-heading mb-1">Unable to identify participant</h6>
                                            <div class="mb-0">Please rejoin the session from the join page.</div>
                                        </div>
                                    </div>
                                }
                                else if (currentActivity.Type == ActivityType.Poll)
                                {
                                    <PollActivity Parameters="@CreateActivityParameters()" />
                                }
                                else if (currentActivity.Type == ActivityType.WordCloud)
                                {
                                    <WordCloudActivity Parameters="@CreateActivityParameters()" />
                                }
                                else if (currentActivity.Type == ActivityType.Rating)
                                {
                                    <RatingActivity Parameters="@CreateActivityParameters()" />
                                }
                                else if (currentActivity.Type == ActivityType.GeneralFeedback)
                                {
                                    <GeneralFeedbackActivity Parameters="@CreateActivityParameters()" />
                                }
                                else if (currentActivity.Type == ActivityType.Quadrant)
                                {
                                    <QuadrantActivity Parameters="@CreateActivityParameters()" />
                                }
                                else
                                {
                                    <GenericActivity Parameters="@CreateActivityParameters()" ActivityType="@currentActivity.Type.ToString()" />
                                }
                            }
                            else
                            {
                                <div class="alert alert-warning d-flex align-items-center" role="alert">
                                    <div class="me-3"><i class="ics ics-locked ic-lg"></i></div>
                                    <div>
                                        <h6 class="alert-heading mb-1">Activity is not open</h6>
                                        <div class="mb-0">Wait for the facilitator to open this activity.</div>
                                    </div>
                                </div>
                            }

                            @if (showRejoinAction && !submitSuccess)
                            {
                                <div class="alert alert-danger d-flex align-items-center justify-content-between flex-wrap gap-2 mt-3" role="alert">
                                    <div>
                                        <strong>Session authentication expired.</strong>
                                        <div class="small">Please rejoin to continue participating.</div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="RejoinSession">
                                        Rejoin Session
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="mb-3"><i class="ics ics-hourglass ic-2xl text-info"></i></div>
                        <h4 class="h5 fw-semibold mb-3">No active activity</h4>
                        <p class="text-muted mb-0">Wait for the facilitator to start an activity.</p>
                    </div>
                </div>
            }
        }
    </div>
</main>

@code {
    [Parameter] public string SessionCode { get; set; } = "";
    [Parameter][SupplyParameterFromQuery] public Guid? Pid { get; set; }

    private SessionSummaryResponse? session;
    private AgendaActivityResponse? currentActivity;
    private bool isLoading = true;
    private string errorMessage = "";
    private string participantDisplayName = "";
    private string participantToken = ""; // SECURITY: Store participant token from localStorage
    private Guid? participantId;
    private int contributionsRemaining = -1;
    private int totalResponsesSubmitted = 0;
    private int activitiesParticipated = 0;

    // Response submission state
    private bool isSubmittingResponse = false;
    private bool hasSubmittedResponse = false;
    private string submitMessage = "";
    private bool submitSuccess = false;
    private bool showRejoinAction = false;

    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        // SECURITY: Retrieve participant token from localStorage
        await LoadParticipantToken();
        await ResolveParticipantId();
        await LoadSession();
        await InitializeSignalR();
    }

    private async Task ResolveParticipantId()
    {
        if (Pid.HasValue)
        {
            participantId = Pid.Value;
            return;
        }

        try
        {
            var storageKey = $"pulse_participant_{SessionCode}";
            var storedParticipantId = await JS.InvokeAsync<string?>("localStorage.getItem", storageKey);

            if (Guid.TryParse(storedParticipantId, out var parsedParticipantId))
            {
                participantId = parsedParticipantId;
                Pid = parsedParticipantId;
                return;
            }
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error resolving participant ID: {ex.Message}");
        }

        participantId = null;
    }

    private async Task LoadParticipantToken()
    {
        try
        {
            var tokenKey = $"pulse_participant_token_{SessionCode}";
            participantToken = await JS.InvokeAsync<string>("localStorage.getItem", tokenKey) ?? "";
            
            Console.WriteLine($"Loaded token for session {SessionCode}: {(string.IsNullOrEmpty(participantToken) ? "EMPTY" : "EXISTS")}");
            
            if (string.IsNullOrEmpty(participantToken))
            {
                errorMessage = "Participant token not found. Please rejoin the session.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading participant token: {ex.Message}");
            errorMessage = $"Failed to retrieve participant token: {ex.Message}";
        }
    }

    private ParticipantActivityParameters CreateActivityParameters()
    {
        return new ParticipantActivityParameters
        {
            SessionCode = SessionCode,
            ParticipantId = participantId.GetValueOrDefault(),
            ActivityId = currentActivity!.ActivityId,
            Config = currentActivity.Config ?? "{}",
            HasSubmitted = hasSubmittedResponse,
            IsSubmitting = isSubmittingResponse,
            SubmitMessage = submitMessage,
            SubmitSuccess = submitSuccess,
            OnSubmit = SubmitResponse
        };
    }
    private async Task LoadSession()
    {
        isLoading = true;
        errorMessage = "";

        try
        {
            var sessionEntity = await SessionService.GetByCodeAsync(SessionCode);
            if (sessionEntity == null)
            {
                errorMessage = "Session not found.";
                return;
            }
            session = ApiMapper.ToSummary(sessionEntity);

            await EnsureParticipantIdentityConsistency(sessionEntity.Id);

            // Load current activity
            if (session.CurrentActivityId.HasValue)
            {
                var agenda = await ActivityService.GetAgendaAsync(sessionEntity.Id);
                var activities = agenda.Select(ApiMapper.ToAgenda).ToList();
                var newActivity = activities.FirstOrDefault(a => a.ActivityId == session.CurrentActivityId);

                // Reset submission state if activity changed
                if (newActivity != null && (currentActivity == null || currentActivity.ActivityId != newActivity.ActivityId))
                {
                    hasSubmittedResponse = false;
                    submitMessage = "";
                    submitSuccess = false;
                    showRejoinAction = false;
                }

                currentActivity = newActivity;
            }

            // TODO: Load participant dashboard/stats
            if (participantId.HasValue)
            {
                // Load participant-specific data
                participantDisplayName = "Participant"; // Placeholder

                // Fetch how many responses this participant has already submitted for the current activity
                if (currentActivity != null)
                {
                    try
                    {
                        var responses = await ResponseService.GetByParticipantAsync(sessionEntity.Id, participantId.Value);
                        var count = responses.Count(r => r.ActivityId == currentActivity.ActivityId);
                        // If any responses exist, consider the participant as having submitted
                        hasSubmittedResponse = count > 0;

                        // Try to derive per-activity max from activity config to compute remaining
                        int? maxResponses = null;
                        if (!string.IsNullOrWhiteSpace(currentActivity.Config))
                        {
                            try
                            {
                                using var doc = JsonDocument.Parse(currentActivity.Config);
                                if (doc.RootElement.TryGetProperty("MaxResponsesPerParticipant", out var maxProp) && maxProp.TryGetInt32(out var mr))
                                {
                                    maxResponses = mr;
                                }
                            }
                            catch { /* ignore parse issues */ }
                        }

                        if (maxResponses.HasValue)
                        {
                            contributionsRemaining = Math.Max(0, maxResponses.Value - count);
                        }
                        else
                        {
                            contributionsRemaining = -1; // unknown / unlimited
                        }
                        totalResponsesSubmitted = count;
                    }
                    catch (Exception ex)
                    {
                        // If API fails, fall back to placeholders
                        Debug.WriteLine($"Error fetching participant response count: {ex.Message}");
                        contributionsRemaining = -1;
                    }
                }
                else
                {
                    contributionsRemaining = -1;
                }
                activitiesParticipated = 0; // Placeholder
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Network error: {ex.Message}";
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task EnsureParticipantIdentityConsistency(Guid sessionId)
    {
        try
        {
            var storageKey = $"pulse_participant_{SessionCode}";
            var tokenKey = $"pulse_participant_token_{SessionCode}";

            var storedParticipantIdValue = await JS.InvokeAsync<string?>("localStorage.getItem", storageKey);
            var storedToken = await JS.InvokeAsync<string?>("localStorage.getItem", tokenKey);

            if (!Guid.TryParse(storedParticipantIdValue, out var storedParticipantId) || string.IsNullOrWhiteSpace(storedToken))
            {
                return;
            }

            var currentIsValid = participantId.HasValue
                && !string.IsNullOrWhiteSpace(participantToken)
                && ParticipantTokenStore.IsValid(sessionId, participantId.Value, participantToken);

            if (currentIsValid)
            {
                return;
            }

            if (ParticipantTokenStore.IsValid(sessionId, storedParticipantId, storedToken))
            {
                participantId = storedParticipantId;
                Pid = storedParticipantId;
                participantToken = storedToken;
            }
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error reconciling participant identity: {ex.Message}");
        }
    }

    private async Task InitializeSignalR()
    {
        if (string.IsNullOrEmpty(SessionCode)) return;

        try
        {
            hubConnection = new HubConnectionBuilder()
             .WithUrl($"{Navigation.BaseUri}hubs/workshop")
                    .WithAutomaticReconnect()
         .Build();

            hubConnection.On<SessionStateChangedEvent>("SessionStateChanged", async (sessionEvent) =>
            {
                await InvokeAsync(async () =>
                {
                    if (sessionEvent.SessionCode == SessionCode)
                    {
                        await LoadSession();

                        // If session ended, clean up and redirect
                        if (session?.Status == SessionStatus.Ended)
                        {
                            await CleanupParticipantSession();
                            Navigation.NavigateTo($"/participant/done-view?session={SessionCode}");
                            return;
                        }

                        StateHasChanged();
                    }
                });
            });

            hubConnection.On<ActivityStateChangedEvent>("ActivityStateChanged", async (activityEvent) =>
                 {
                     await InvokeAsync(async () =>
                    {
                        if (activityEvent.SessionCode == SessionCode)
                        {
                            await LoadSession();
                            StateHasChanged();
                        }
                    });
                 });

            hubConnection.On<DashboardUpdatedEvent>("DashboardUpdated", async (dashboardEvent) =>
            {
                await InvokeAsync(() =>
            {
                if (dashboardEvent.SessionCode == SessionCode)
                {
                    Debug.WriteLine($"Dashboard updated for activity {dashboardEvent.ActivityId}");
                    StateHasChanged();
                }
            });
            });

            await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("Subscribe", SessionCode);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"SignalR connection error: {ex.Message}");
        }
    }

    // ===================
    // RENDER METHODS
    // ===================

    private string GetSubmitButtonText()
    {
        if (hasSubmittedResponse)
            return "Response Submitted";
        if (isSubmittingResponse)
            return "Submitting...";
        return "Submit Response";
    }

    private string GetStatusBadgeClass()
    {
        return currentActivity?.Status switch
        {
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending => "secondary",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open => "success",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Closed => "danger",
            _ => "secondary"
        };
    }

    private string GetSessionStatusClass()
    {
        return session?.Status switch
        {
            SessionStatus.Draft => "bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25",
            SessionStatus.Live => "bg-success bg-opacity-10 text-success border border-success border-opacity-25",
            SessionStatus.Ended => "bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25",
            _ => "bg-light text-dark border"
        };
    }

    private string GetActivityStatusClass()
    {
        return currentActivity?.Status switch
        {
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending => "bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open => "bg-success bg-opacity-10 text-success border border-success border-opacity-25",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Closed => "bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25",
            _ => "bg-light text-dark border"
        };
    }

    private async Task CleanupParticipantSession()
    {
        try
        {
            await JS.InvokeVoidAsync("pulseParticipantSession.removeFromSession", SessionCode);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error cleaning up participant session: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            try
            {
                await hubConnection.InvokeAsync("Unsubscribe", SessionCode);
                await hubConnection.DisposeAsync();
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Error disposing SignalR connection: {ex.Message}");
            }
        }

        // Clean up participant session when leaving
        await CleanupParticipantSession();
    }

    // ===================
    // COMMON METHODS
    // ===================

    private async Task SubmitResponse(string payload)
    {
        if (currentActivity == null || !participantId.HasValue)
        {
            submitMessage = "ERROR: Validation failed in SubmitResponse";
            showRejoinAction = false;
            StateHasChanged();
            return;
        }

        isSubmittingResponse = true;
        submitMessage = "";
        submitSuccess = false;
        showRejoinAction = false;
        StateHasChanged();

        try
        {
            // Get session for validation
            var sessionEntity = await SessionService.GetByCodeAsync(SessionCode);
            if (sessionEntity == null)
            {
                submitSuccess = false;
                submitMessage = "Session not found.";
                showRejoinAction = false;
                return;
            }

            // SECURITY: Validate participant token
            if (string.IsNullOrEmpty(participantToken))
            {
                submitSuccess = false;
                submitMessage = "Participant token not found. Please refresh the page or rejoin the session.";
                showRejoinAction = true;
                Console.WriteLine($"Token is empty for participant {participantId.Value}");
                return;
            }
            
            // Check if token exists in store
            if (!ParticipantTokenStore.TryGet(sessionEntity.Id, participantId.Value, out var storedAuth))
            {
                submitSuccess = false;
                submitMessage = "Session state lost (server restart). Please rejoin the session by refreshing and entering your name again.";
                showRejoinAction = true;
                Console.WriteLine($"No token found in store for participant {participantId.Value} in session {sessionEntity.Id}");
                return;
            }
            
            if (!ParticipantTokenStore.IsValid(sessionEntity.Id, participantId.Value, participantToken))
            {
                await EnsureParticipantIdentityConsistency(sessionEntity.Id);

                if (!participantId.HasValue || string.IsNullOrWhiteSpace(participantToken) ||
                    !ParticipantTokenStore.IsValid(sessionEntity.Id, participantId.Value, participantToken))
                {
                    submitSuccess = false;
                    submitMessage = "Invalid or expired participant token. The token doesn't match. Please rejoin the session.";
                    showRejoinAction = true;
                    Console.WriteLine($"Token validation failed for participant {participantId.Value} in session {sessionEntity.Id}");
                    Console.WriteLine($"Expected: {storedAuth.Token.Substring(0, 8)}..., Got: {participantToken.Substring(0, Math.Min(8, participantToken.Length))}...");
                    return;
                }
            }

            // Submit response
            var response = await ResponseService.SubmitAsync(
                sessionEntity.Id,
                currentActivity.ActivityId,
                participantId.Value,
                payload,
                DateTimeOffset.UtcNow);

            await HubNotifications.PublishResponseReceivedAsync(
                sessionEntity.Code,
                currentActivity.ActivityId,
                response.Id,
                participantId.Value,
                response.CreatedAt);

            await HubNotifications.PublishDashboardUpdatedAsync(
                sessionEntity.Code,
                currentActivity.ActivityId,
                "response_submitted",
                new { ResponseId = response.Id, ActivityId = currentActivity.ActivityId });

            hasSubmittedResponse = true;
            totalResponsesSubmitted++;
            contributionsRemaining--;
            submitSuccess = true;
            submitMessage = "Response submitted successfully!";
            showRejoinAction = false;
        }
        catch (Exception ex)
        {
            submitSuccess = false;
            submitMessage = $"API Error: {ex.Message}";
            showRejoinAction = false;
        }
        finally
        {
            isSubmittingResponse = false;
            StateHasChanged();
        }
    }

    private Task RejoinSession()
    {
        Navigation.NavigateTo($"/participant/join?sessionCode={SessionCode}", true);
        return Task.CompletedTask;
    }
}
