@page "/participant/activity/{SessionCode}"
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject TechWayFit.Pulse.Web.Services.IPulseApiService ApiService
@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Requests
@using TechWayFit.Pulse.Contracts.Enums
@using TechWayFit.Pulse.Web.Hubs
@using Microsoft.AspNetCore.SignalR.Client
@using System.Diagnostics
@using System.Text.Json
@implements IAsyncDisposable

<PageTitle>Workshop Activity - @(session?.Title ?? "Loading...")</PageTitle>

<div class="activity-container">
  @if (isLoading)
    {
      <div class="loading-state">
            <div class="spinner"></div>
        <p>Loading activity...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-state">
      <div class="alert alert-danger">
      <strong>Error:</strong> @errorMessage
        </div>
 <button class="btn btn-primary" @onclick="LoadSession">Retry</button>
        </div>
    }
  else if (session != null)
    {
        <div class="activity-header">
       <div class="session-info">
        <h1>@session.Title</h1>
     <div class="session-meta">
              <span class="session-code">Code: @session.Code</span>
     <span class="session-status status-@session.Status.ToString().ToLower()">@session.Status</span>
         </div>
            </div>
          <div class="participant-info">
  @if (!string.IsNullOrEmpty(participantDisplayName))
        {
         <span class="participant-name">@participantDisplayName</span>
        }
   @if (contributionsRemaining >= 0)
   {
            <span class="contributions-remaining">@contributionsRemaining contributions remaining</span>
                }
    </div>
   </div>

     <div class="activity-content">
     @if (session.Status == SessionStatus.Draft)
          {
     <div class="waiting-state">
        <div class="waiting-icon">?</div>
      <h2>Waiting for facilitator to start...</h2>
      <p>The workshop hasn't started yet. Please wait for the facilitator to begin the session.</p>
           </div>
            }
       else if (session.Status == SessionStatus.Ended)
            {
      <div class="ended-state">
         <div class="ended-icon">?</div>
          <h2>Workshop completed!</h2>
          <p>Thank you for participating in this workshop. The session has ended.</p>
     <div class="final-stats">
            <div class="stat">
           <strong>@totalResponsesSubmitted</strong>
   <span>responses submitted</span>
      </div>
      <div class="stat">
     <strong>@activitiesParticipated</strong>
         <span>activities completed</span>
    </div>
        </div>
     </div>
  }
    else if (currentActivity != null)
       {
     <div class="current-activity">
    <div class="activity-info">
       <h2>@currentActivity.Title</h2>
      @if (!string.IsNullOrEmpty(currentActivity.Prompt))
      {
            <p class="activity-prompt">@currentActivity.Prompt</p>
            }
 <div class="activity-meta">
      <span class="activity-type badge bg-primary">@currentActivity.Type</span>
         <span class="activity-status badge bg-@GetStatusBadgeClass()">@currentActivity.Status</span>
   </div>
    </div>

  @if (currentActivity.Status == TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open)
       {
                  <div class="response-section mt-4">
     @if (currentActivity.Type == ActivityType.Poll)
  {
        @RenderPollActivity()
  }
              else if (currentActivity.Type == ActivityType.WordCloud)
            {
             @RenderWordCloudActivity()
        }
        else if (currentActivity.Type == ActivityType.Rating)
     {
   @RenderRatingActivity()
       }
           else if (currentActivity.Type == ActivityType.GeneralFeedback)
      {
      @RenderGeneralFeedbackActivity()
      }
   else
          {
                @RenderGenericActivity()
     }

     @if (!string.IsNullOrEmpty(submitMessage))
        {
 <div class="alert alert-@(submitSuccess ? "success" : "danger") mt-3">
  @submitMessage
   </div>
        }
   </div>
   }
        else
         {
    <div class="activity-locked alert alert-warning mt-4">
       <div class="locked-icon">??</div>
      <h3>Activity is not open</h3>
               <p>Wait for the facilitator to open this activity.</p>
              </div>
          }
   </div>
            }
          else
       {
  <div class="no-activity alert alert-info">
          <div class="waiting-icon">??</div>
    <h2>No active activity</h2>
<p>Wait for the facilitator to start an activity.</p>
           </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string SessionCode { get; set; } = "";
    [Parameter] [SupplyParameterFromQuery] public Guid? Pid { get; set; }

    private SessionSummaryResponse? session;
    private AgendaActivityResponse? currentActivity;
    private bool isLoading = true;
    private string errorMessage = "";
    private string participantDisplayName = "";
private int contributionsRemaining = -1;
    private int totalResponsesSubmitted = 0;
    private int activitiesParticipated = 0;
  
    // Response submission state
  private bool isSubmittingResponse = false;
    private bool hasSubmittedResponse = false;
    private string submitMessage = "";
    private bool submitSuccess = false;
 
    // Poll activity state
    private List<string> selectedPollOptionIds = new();
    private string? customPollText;
    private PollConfig? pollConfig;
    
    // WordCloud state
    private string? wordCloudText;
    
    // Rating state
    private int selectedRating = 0;
    
    // GeneralFeedback state
    private string? feedbackText;
    private string? selectedFeedbackCategory;
    private GeneralFeedbackConfig? feedbackConfig;
    
    // Generic state
    private string? genericResponseText;

  private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadSession();
        await InitializeSignalR();
    }

    private async Task LoadSession()
    {
    isLoading = true;
  errorMessage = "";

      try
        {
            session = await ApiService.GetSessionAsync(SessionCode);
   
         // Load current activity
          if (session.CurrentActivityId.HasValue)
            {
    var activities = await ApiService.GetAgendaAsync(SessionCode);
    currentActivity = activities.FirstOrDefault(a => a.ActivityId == session.CurrentActivityId);
         
          // Parse activity configuration
   if (currentActivity != null)
    {
           ParseActivityConfig();
 }
      }
            
    // TODO: Load participant dashboard/stats
      if (Pid.HasValue)
{
         // Load participant-specific data
        participantDisplayName = "Participant"; // Placeholder
        contributionsRemaining = 3; // Placeholder
  totalResponsesSubmitted = 0; // Placeholder
 activitiesParticipated = 0; // Placeholder
            }
        }
        catch (HttpRequestException ex)
        {
 errorMessage = $"Network error: {ex.Message}";
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
      }
        catch (Exception ex)
      {
            errorMessage = $"Unexpected error: {ex.Message}";
 }
        finally
        {
     isLoading = false;
       StateHasChanged();
        }
    }

    private void ParseActivityConfig()
    {
        if (currentActivity == null || string.IsNullOrEmpty(currentActivity.Config))
  return;

        try
        {
          switch (currentActivity.Type)
            {
        case ActivityType.Poll:
        pollConfig = JsonSerializer.Deserialize<PollConfig>(currentActivity.Config);
             break;
      case ActivityType.GeneralFeedback:
      feedbackConfig = JsonSerializer.Deserialize<GeneralFeedbackConfig>(currentActivity.Config);
  break;
   }
  }
        catch (JsonException ex)
        {
     Debug.WriteLine($"Failed to parse activity config: {ex.Message}");
   }
 }

    private async Task InitializeSignalR()
    {
        if (string.IsNullOrEmpty(SessionCode)) return;

     try
        {
    hubConnection = new HubConnectionBuilder()
     .WithUrl($"{Navigation.BaseUri}hubs/workshop")
            .WithAutomaticReconnect()
 .Build();

  hubConnection.On<SessionStateChangedEvent>("SessionStateChanged", async (sessionEvent) =>
  {
           await InvokeAsync(async () =>
     {
      if (sessionEvent.SessionCode == SessionCode)
           {
      await LoadSession();
       StateHasChanged();
       }
     });
            });

       hubConnection.On<ActivityStateChangedEvent>("ActivityStateChanged", async (activityEvent) =>
            {
    await InvokeAsync(async () =>
        {
          if (activityEvent.SessionCode == SessionCode)
    {
      await LoadSession();
        StateHasChanged();
    }
   });
       });

            hubConnection.On<DashboardUpdatedEvent>("DashboardUpdated", async (dashboardEvent) =>
            {
        await InvokeAsync(() =>
    {
               if (dashboardEvent.SessionCode == SessionCode)
        {
  Debug.WriteLine($"Dashboard updated for activity {dashboardEvent.ActivityId}");
       StateHasChanged();
          }
     });
 });

await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("Subscribe", SessionCode);
      }
        catch (Exception ex)
        {
            Debug.WriteLine($"SignalR connection error: {ex.Message}");
 }
    }

    // ===================
    // RENDER METHODS
    // ===================
    
    private RenderFragment RenderPollActivity() => __builder =>
    {
        <div class="poll-activity card p-4">
  <h3 class="mb-3">@(pollConfig?.AllowMultiple == true ? "Select one or more:" : "Make your choice:")</h3>
  
     @if (pollConfig != null && pollConfig.Options != null)
      {
        <div class="poll-options mb-3">
   @foreach (var option in pollConfig.Options)
        {
             var optionId = option.Id;
      <div class="form-check poll-option mb-2 p-3 border rounded">
            @if (pollConfig.AllowMultiple)
  {
       <input class="form-check-input" 
      type="checkbox" 
                 id="poll-@optionId"
                 checked="@selectedPollOptionIds.Contains(optionId)"
          @onchange="@((e) => TogglePollOption(optionId))" />
              }
         else
{
   <input class="form-check-input" 
                 type="radio" 
    name="pollChoice"
         id="poll-@optionId"
   checked="@selectedPollOptionIds.Contains(optionId)"
         @onchange="@((e) => SelectPollOption(optionId))" />
 }
     <label class="form-check-label w-100" for="poll-@optionId">
      <strong>@option.Label</strong>
        @if (!string.IsNullOrEmpty(option.Description))
         {
 <br /><small class="text-muted">@option.Description</small>
          }
            </label>
         </div>
   }
  
 @if (pollConfig.AllowCustomOption)
     {
      <div class="form-check poll-option mb-2 p-3 border rounded">
         @if (pollConfig.AllowMultiple)
    {
        <input class="form-check-input" 
  type="checkbox" 
   id="poll-custom"
              checked="@selectedPollOptionIds.Contains("custom")"
        @onchange="@((e) => TogglePollOption("custom"))" />
}
             else
    {
        <input class="form-check-input" 
      type="radio" 
name="pollChoice"
   id="poll-custom"
       checked="@selectedPollOptionIds.Contains("custom")"
    @onchange="@((e) => SelectPollOption("custom"))" />
    }
            <label class="form-check-label w-100" for="poll-custom">
   <strong>Other</strong>
@if (selectedPollOptionIds.Contains("custom"))
  {
              <input type="text" 
   class="form-control mt-2" 
      placeholder="@pollConfig.CustomOptionPlaceholder"
    @bind="customPollText"
       maxlength="100" />
    }
        </label>
           </div>
        }
     </div>
      }
            else
   {
         <div class="alert alert-warning">No poll options configured.</div>
     }
            
 <button class="btn btn-primary btn-lg w-100" 
        @onclick="SubmitPollResponse" 
   disabled="@(isSubmittingResponse || selectedPollOptionIds.Count == 0 || hasSubmittedResponse)">
     @GetSubmitButtonText()
          </button>
        </div>
    };

    private RenderFragment RenderWordCloudActivity() => __builder =>
    {
        <div class="wordcloud-activity card p-4">
         <h3 class="mb-3">Share your thoughts:</h3>
 <div class="mb-3">
      <textarea class="form-control" 
  @bind="wordCloudText" 
      rows="3"
         placeholder="Type your response here (1-3 words)..."
     maxlength="150"></textarea>
             <small class="text-muted">@((wordCloudText?.Length ?? 0)) / 150 characters</small>
   </div>
  <button class="btn btn-primary btn-lg w-100" 
         @onclick="SubmitWordCloudResponse" 
    disabled="@(isSubmittingResponse || string.IsNullOrWhiteSpace(wordCloudText) || hasSubmittedResponse)">
             @GetSubmitButtonText()
        </button>
        </div>
    };

    private RenderFragment RenderRatingActivity() => __builder =>
    {
        <div class="rating-activity card p-4">
   <h3 class="mb-3">Rate this:</h3>
   <div class="rating-scale d-flex justify-content-center gap-2 mb-4">
           @for (int i = 1; i <= 5; i++)
  {
       var rating = i;
  <button class="btn btn-outline-primary rating-button @(selectedRating == rating ? "active" : "")"
   style="width: 60px; height: 60px; font-size: 24px;"
    @onclick="() => SetRating(rating)">
    @rating
     </button>
       }
      </div>
         <button class="btn btn-primary btn-lg w-100" 
            @onclick="SubmitRatingResponse" 
       disabled="@(isSubmittingResponse || selectedRating == 0 || hasSubmittedResponse)">
       @GetSubmitButtonText()
     </button>
        </div>
    };

  private RenderFragment RenderGeneralFeedbackActivity() => __builder =>
    {
    <div class="feedback-activity card p-4">
      <h3 class="mb-3">Share your feedback:</h3>
      
    @if (feedbackConfig?.CategoriesEnabled == true && feedbackConfig.Categories != null)
     {
         <div class="mb-3">
     <label class="form-label">Category @(feedbackConfig.RequireCategory ? "*" : "(optional)")</label>
                 <div class="btn-group w-100" role="group">
          @foreach (var category in feedbackConfig.Categories)
          {
   var catId = category.Id;
    <button type="button" 
          class="btn btn-outline-secondary @(selectedFeedbackCategory == catId ? "active" : "")"
             @onclick="() => selectedFeedbackCategory = catId">
       @if (!string.IsNullOrEmpty(category.Icon))
     {
  <span>@category.Icon</span>
    }
        @category.Label
     </button>
             }
            </div>
          </div>
            }
      
     <div class="mb-3">
    <textarea class="form-control" 
   @bind="feedbackText" 
  rows="6"
      placeholder="@(feedbackConfig?.Placeholder ?? "Share your thoughts, problems, or suggestions...")"
  maxlength="@(feedbackConfig?.MaxLength ?? 1000)"></textarea>
   @if (feedbackConfig?.ShowCharacterCount == true)
     {
         <small class="text-muted">
     @((feedbackText?.Length ?? 0)) / @(feedbackConfig?.MaxLength ?? 1000) characters
          </small>
       }
       </div>
            
    <button class="btn btn-primary btn-lg w-100" 
           @onclick="SubmitGeneralFeedbackResponse" 
  disabled="@(isSubmittingResponse || IsGeneralFeedbackInvalid() || hasSubmittedResponse)">
         @GetSubmitButtonText()
            </button>
    </div>
    };

    private RenderFragment RenderGenericActivity() => __builder =>
    {
   <div class="generic-activity card p-4">
       <h3 class="mb-3">Activity type: @currentActivity?.Type</h3>
          <p class="text-muted">This activity type is not yet fully implemented.</p>
            <div class="mb-3">
       <textarea class="form-control" 
     @bind="genericResponseText" 
      rows="4"
        placeholder="Enter your response..."
      maxlength="1000"></textarea>
       </div>
            <button class="btn btn-primary btn-lg w-100" 
         @onclick="SubmitGenericResponse" 
              disabled="@(isSubmittingResponse || string.IsNullOrWhiteSpace(genericResponseText) || hasSubmittedResponse)">
 @GetSubmitButtonText()
            </button>
        </div>
    };

    // ===================
    // POLL METHODS
    // ===================

    private void SelectPollOption(string optionId)
    {
        selectedPollOptionIds.Clear();
        selectedPollOptionIds.Add(optionId);
        hasSubmittedResponse = false;
      submitMessage = "";
    }

    private void TogglePollOption(string optionId)
    {
        if (selectedPollOptionIds.Contains(optionId))
        {
            selectedPollOptionIds.Remove(optionId);
        }
        else
        {
        selectedPollOptionIds.Add(optionId);
        }
        hasSubmittedResponse = false;
        submitMessage = "";
    }

    private async Task SubmitPollResponse()
    {
    if (currentActivity == null || !Pid.HasValue) return;

        var payload = new
        {
      selectedOptionIds = selectedPollOptionIds,
        customOptionText = selectedPollOptionIds.Contains("custom") ? customPollText : null
        };

        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    // ===================
    // WORD CLOUD METHODS
    // ===================

    private async Task SubmitWordCloudResponse()
    {
   if (currentActivity == null || !Pid.HasValue || string.IsNullOrWhiteSpace(wordCloudText)) return;

  var payload = new { text = wordCloudText.Trim() };
        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    // ===================
    // RATING METHODS
// ===================

    private void SetRating(int rating)
    {
        selectedRating = rating;
  hasSubmittedResponse = false;
        submitMessage = "";
    }

    private async Task SubmitRatingResponse()
    {
        if (currentActivity == null || !Pid.HasValue) return;

    var payload = new { rating = selectedRating, scale = 5 };
        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    // ===================
    // GENERAL FEEDBACK METHODS
    // ===================

    private bool IsGeneralFeedbackInvalid()
    {
        if (string.IsNullOrWhiteSpace(feedbackText)) return true;
        
        var minLength = feedbackConfig?.MinLength ?? 10;
        if (feedbackText.Length < minLength) return true;
     
        if (feedbackConfig?.RequireCategory == true && string.IsNullOrEmpty(selectedFeedbackCategory))
            return true;
        
        return false;
    }

    private async Task SubmitGeneralFeedbackResponse()
    {
 if (currentActivity == null || !Pid.HasValue || IsGeneralFeedbackInvalid()) return;

        var payload = new
{
      text = feedbackText!.Trim(),
    category = selectedFeedbackCategory,
  isAnonymous = false,
      characterCount = feedbackText.Length
        };

        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    // ===================
    // GENERIC METHODS
    // ===================

    private async Task SubmitGenericResponse()
    {
        if (currentActivity == null || !Pid.HasValue || string.IsNullOrWhiteSpace(genericResponseText)) return;

        var payload = new { text = genericResponseText.Trim() };
        await SubmitResponse(JsonSerializer.Serialize(payload));
    }

    // ===================
    // COMMON METHODS
    // ===================

    private async Task SubmitResponse(string payload)
    {
        if (currentActivity == null || !Pid.HasValue) return;

        isSubmittingResponse = true;
 submitMessage = "";
        submitSuccess = false;

        try
        {
         var request = new SubmitResponseRequest
       {
       ParticipantId = Pid.Value,
     Payload = payload
            };

        await ApiService.SubmitResponseAsync(SessionCode, currentActivity.ActivityId, request);

            hasSubmittedResponse = true;
     totalResponsesSubmitted++;
         contributionsRemaining--;
      submitSuccess = true;
       submitMessage = "Response submitted successfully!";
  
            ResetFormFields();
        }
        catch (Exception ex)
        {
   submitSuccess = false;
      submitMessage = $"Failed to submit response: {ex.Message}";
     }
finally
        {
       isSubmittingResponse = false;
         StateHasChanged();
        }
    }

  private void ResetFormFields()
    {
     selectedPollOptionIds.Clear();
        customPollText = null;
        wordCloudText = "";
   selectedRating = 0;
        feedbackText = "";
    selectedFeedbackCategory = null;
genericResponseText = "";
    }

    private string GetSubmitButtonText()
{
        if (hasSubmittedResponse)
          return "Response Submitted ?";
        if (isSubmittingResponse)
            return "Submitting...";
        return "Submit Response";
  }

    private string GetStatusBadgeClass()
    {
    return currentActivity?.Status switch
    {
 TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending => "secondary",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open => "success",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Closed => "danger",
            _ => "secondary"
        };
}

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
   try
       {
     await hubConnection.InvokeAsync("Unsubscribe", SessionCode);
     await hubConnection.DisposeAsync();
            }
            catch (Exception ex)
            {
     Debug.WriteLine($"Error disposing SignalR connection: {ex.Message}");
   }
        }
    }

    // ===================
    // CONFIG CLASSES (Temporary - move to shared later)
    // ===================

    private class PollConfig
    {
        public List<PollOption> Options { get; set; } = new();
    public bool AllowMultiple { get; set; }
        public bool AllowCustomOption { get; set; }
   public string CustomOptionPlaceholder { get; set; } = "Other (please specify)";
    }

 private class PollOption
    {
        public string Id { get; set; } = "";
   public string Label { get; set; } = "";
        public string? Description { get; set; }
    }

    private class GeneralFeedbackConfig
    {
        public int MaxLength { get; set; } = 1000;
        public int MinLength { get; set; } = 10;
    public string Placeholder { get; set; } = "";
        public bool CategoriesEnabled { get; set; }
        public List<FeedbackCategory> Categories { get; set; } = new();
 public bool RequireCategory { get; set; }
        public bool ShowCharacterCount { get; set; } = true;
    }

    private class FeedbackCategory
    {
        public string Id { get; set; } = "";
        public string Label { get; set; } = "";
        public string? Icon { get; set; }
    }
}