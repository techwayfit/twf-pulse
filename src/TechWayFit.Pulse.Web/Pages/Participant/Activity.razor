@page "/participant/activity/{SessionCode}"
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject TechWayFit.Pulse.Web.Services.IPulseApiService ApiService
@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Requests
@using TechWayFit.Pulse.Contracts.Enums
@using TechWayFit.Pulse.Web.Hubs
@using TechWayFit.Pulse.Web.Components.Participant.Activities
@using Microsoft.AspNetCore.SignalR.Client
@using System.Diagnostics
@using System.Text.Json
@implements IAsyncDisposable

<PageTitle>Workshop Activity - @(session?.Title ?? "Loading...")</PageTitle>

<main class="py-5">
    <div class="container" style="max-width: 1200px;">

        <!-- Full-Screen Toggle Button -->
        <TechWayFit.Pulse.Web.Components.Shared.FullscreenToggle ShowInfoBanner="true" />

        @if (isLoading)
        {
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted mb-0">Loading activity...</p>
                </div>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="alert alert-danger mb-3" role="alert">
                        <strong>Error:</strong> @errorMessage
                    </div>
                    <button class="btn btn-primary pulse-btn-primary" @onclick="LoadSession">Retry</button>
                </div>
            </div>
        }
        else if (session != null)
        {
            <!-- Session Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
                        <div class="flex-grow-1">
                            <h1 class="h5 fw-semibold mb-2 text-break" style="line-height: 1.3;">@session.Title</h1>
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <span class="badge bg-light text-dark border px-2 py-1 small">
                                    <strong>Code:</strong> @session.Code
                                </span>
                                <span class="badge @GetSessionStatusClass() px-2 py-1 small">
                                    <span class="pulse-dot me-1"></span>
                                    @session.Status
                                </span>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(participantDisplayName))
                        {
                            <div class="text-end flex-shrink-0">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="fas fa-user text-muted small"></i>
                                    <span class="fw-semibold">@participantDisplayName</span>
                                </div>
                                @if (contributionsRemaining >= 0)
                                {
                                    <div class="text-primary small">
                                        @contributionsRemaining remaining
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Activity Content -->
            @if (session.Status == SessionStatus.Draft)
            {
                <div class="card border-0 shadow-lg" style="background: linear-gradient(145deg, #fff9e6, #ffffff);">
                    <div class="card-body text-center py-5">
                        <div class="display-1 text-warning mb-3">‚è±</div>
                        <h4 class="h4 fw-bold mb-3">Waiting for facilitator to start...</h4>
                        <p class="text-muted mb-0 fs-5">The workshop hasn't started yet. Please wait for the facilitator to begin the session.</p>
                    </div>
                </div>
            }
            else if (session.Status == SessionStatus.Ended)
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="display-1 text-success mb-3">‚úÖ</div>
                        <h4 class="h5 fw-semibold mb-3">Workshop completed!</h4>
                        <p class="text-muted mb-4">Thank you for participating in this workshop. The session has ended.</p>

                        <div class="row justify-content-center">
                            <div class="col-auto">
                                <div class="text-center p-3 border rounded">
                                    <div class="fw-bold fs-4 text-primary">@totalResponsesSubmitted</div>
                                    <div class="small text-muted">responses submitted</div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <div class="text-center p-3 border rounded">
                                    <div class="fw-bold fs-4 text-success">@activitiesParticipated</div>
                                    <div class="small text-muted">activities completed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (currentActivity != null)
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <!-- Activity Header -->
                        <div class="mb-4 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
                                <div class="flex-grow-1">
                                    <h2 class="h4 fw-bold mb-0 text-break" style="line-height: 1.4;">@currentActivity.Title</h2>
                                </div>
                                <div class="d-flex gap-2 flex-shrink-0">
                                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2">
                                        @currentActivity.Type
                                    </span>
                                    <span class="badge @GetActivityStatusClass() px-3 py-2">
                                        @currentActivity.Status
                                    </span>
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(currentActivity.Prompt))
                            {
                                <p class="text-muted mb-0 fs-6">@currentActivity.Prompt</p>
                            }
                        </div>

                        <div class="response-section mt-4">
                            @if (currentActivity.Status == TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open)
                            {
                                @if (currentActivity.Type == ActivityType.Poll)
                                {
                                    <PollActivity Parameters="@CreateActivityParameters()" />
                                }
                                else if (currentActivity.Type == ActivityType.WordCloud)
                                {
                                    <WordCloudActivity Parameters="@CreateActivityParameters()" />
                                }
                                else if (currentActivity.Type == ActivityType.Rating)
                                {
                                    <RatingActivity Parameters="@CreateActivityParameters()" />
                                }
                                else if (currentActivity.Type == ActivityType.GeneralFeedback)
                                {
                                    <GeneralFeedbackActivity Parameters="@CreateActivityParameters()" />
                                }
                                else
                                {
                                    <GenericActivity Parameters="@CreateActivityParameters()" ActivityType="@currentActivity.Type.ToString()" />
                                }
                            }
                            else
                            {
                                <div class="alert alert-warning d-flex align-items-center" role="alert">
                                    <div class="me-3 fs-4">üîí</div>
                                    <div>
                                        <h6 class="alert-heading mb-1">Activity is not open</h6>
                                        <div class="mb-0">Wait for the facilitator to open this activity.</div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="display-1 text-info mb-3">‚è≥</div>
                        <h4 class="h5 fw-semibold mb-3">No active activity</h4>
                        <p class="text-muted mb-0">Wait for the facilitator to start an activity.</p>
                    </div>
                </div>
            }
        }
    </div>
</main>

@code {
    [Parameter] public string SessionCode { get; set; } = "";
    [Parameter][SupplyParameterFromQuery] public Guid? Pid { get; set; }

    private SessionSummaryResponse? session;
    private AgendaActivityResponse? currentActivity;
    private bool isLoading = true;
    private string errorMessage = "";
    private string participantDisplayName = "";
    private int contributionsRemaining = -1;
    private int totalResponsesSubmitted = 0;
    private int activitiesParticipated = 0;

    // Response submission state
    private bool isSubmittingResponse = false;
    private bool hasSubmittedResponse = false;
    private string submitMessage = "";
    private bool submitSuccess = false;

    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadSession();
        await InitializeSignalR();
    }

    private ParticipantActivityParameters CreateActivityParameters()
    {
        return new ParticipantActivityParameters
        {
            SessionCode = SessionCode,
            ParticipantId = Pid!.Value,
            ActivityId = currentActivity!.ActivityId,
            Config = currentActivity.Config ?? "{}",
            HasSubmitted = hasSubmittedResponse,
            IsSubmitting = isSubmittingResponse,
            SubmitMessage = submitMessage,
            SubmitSuccess = submitSuccess,
            OnSubmit = SubmitResponse
        };
    }
    private async Task LoadSession()
    {
        isLoading = true;
        errorMessage = "";

        try
        {
            session = await ApiService.GetSessionAsync(SessionCode);

            // Load current activity
            if (session.CurrentActivityId.HasValue)
            {
                var activities = await ApiService.GetAgendaAsync(SessionCode);
                var newActivity = activities.FirstOrDefault(a => a.ActivityId == session.CurrentActivityId);

                // Reset submission state if activity changed
                if (newActivity != null && (currentActivity == null || currentActivity.ActivityId != newActivity.ActivityId))
                {
                    hasSubmittedResponse = false;
                    submitMessage = "";
                    submitSuccess = false;
                }

                currentActivity = newActivity;
            }

            // TODO: Load participant dashboard/stats
            if (Pid.HasValue)
            {
                // Load participant-specific data
                participantDisplayName = "Participant"; // Placeholder

                // Fetch how many responses this participant has already submitted for the current activity
                if (currentActivity != null)
                {
                    try
                    {
                        var count = await ApiService.GetParticipantActivityResponseCountAsync(SessionCode, currentActivity.ActivityId, Pid.Value);
                        // If any responses exist, consider the participant as having submitted
                        hasSubmittedResponse = count > 0;

                        // Try to derive per-activity max from activity config to compute remaining
                        int? maxResponses = null;
                        if (!string.IsNullOrWhiteSpace(currentActivity.Config))
                        {
                            try
                            {
                                using var doc = JsonDocument.Parse(currentActivity.Config);
                                if (doc.RootElement.TryGetProperty("MaxResponsesPerParticipant", out var maxProp) && maxProp.TryGetInt32(out var mr))
                                {
                                    maxResponses = mr;
                                }
                            }
                            catch { /* ignore parse issues */ }
                        }

                        if (maxResponses.HasValue)
                        {
                            contributionsRemaining = Math.Max(0, maxResponses.Value - count);
                        }
                        else
                        {
                            contributionsRemaining = -1; // unknown / unlimited
                        }
                        totalResponsesSubmitted = count;
                    }
                    catch (Exception ex)
                    {
                        // If API fails, fall back to placeholders
                        Debug.WriteLine($"Error fetching participant response count: {ex.Message}");
                        contributionsRemaining = -1;
                    }
                }
                else
                {
                    contributionsRemaining = -1;
                }
                activitiesParticipated = 0; // Placeholder
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Network error: {ex.Message}";
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task InitializeSignalR()
    {
        if (string.IsNullOrEmpty(SessionCode)) return;

        try
        {
            hubConnection = new HubConnectionBuilder()
             .WithUrl($"{Navigation.BaseUri}hubs/workshop")
                    .WithAutomaticReconnect()
         .Build();

            hubConnection.On<SessionStateChangedEvent>("SessionStateChanged", async (sessionEvent) =>
            {
                await InvokeAsync(async () =>
                {
                    if (sessionEvent.SessionCode == SessionCode)
                    {
                        await LoadSession();

                        // If session ended, clean up and redirect
                        if (session?.Status == SessionStatus.Ended)
                        {
                            await CleanupParticipantSession();
                            Navigation.NavigateTo($"/participant/done-view?session={SessionCode}");
                            return;
                        }

                        StateHasChanged();
                    }
                });
            });

            hubConnection.On<ActivityStateChangedEvent>("ActivityStateChanged", async (activityEvent) =>
                 {
                     await InvokeAsync(async () =>
                    {
                        if (activityEvent.SessionCode == SessionCode)
                        {
                            await LoadSession();
                            StateHasChanged();
                        }
                    });
                 });

            hubConnection.On<DashboardUpdatedEvent>("DashboardUpdated", async (dashboardEvent) =>
            {
                await InvokeAsync(() =>
            {
                if (dashboardEvent.SessionCode == SessionCode)
                {
                    Debug.WriteLine($"Dashboard updated for activity {dashboardEvent.ActivityId}");
                    StateHasChanged();
                }
            });
            });

            await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("Subscribe", SessionCode);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"SignalR connection error: {ex.Message}");
        }
    }

    // ===================
    // RENDER METHODS
    // ===================

    private string GetSubmitButtonText()
    {
        if (hasSubmittedResponse)
            return "Response Submitted ‚úì";
        if (isSubmittingResponse)
            return "Submitting...";
        return "Submit Response";
    }

    private string GetStatusBadgeClass()
    {
        return currentActivity?.Status switch
        {
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending => "secondary",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open => "success",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Closed => "danger",
            _ => "secondary"
        };
    }

    private string GetSessionStatusClass()
    {
        return session?.Status switch
        {
            SessionStatus.Draft => "bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25",
            SessionStatus.Live => "bg-success bg-opacity-10 text-success border border-success border-opacity-25",
            SessionStatus.Ended => "bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25",
            _ => "bg-light text-dark border"
        };
    }

    private string GetActivityStatusClass()
    {
        return currentActivity?.Status switch
        {
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending => "bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Open => "bg-success bg-opacity-10 text-success border border-success border-opacity-25",
            TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Closed => "bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25",
            _ => "bg-light text-dark border"
        };
    }

    private async Task CleanupParticipantSession()
    {
        try
        {
            await JS.InvokeVoidAsync("participantSession.removeFromSession", SessionCode);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error cleaning up participant session: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            try
            {
                await hubConnection.InvokeAsync("Unsubscribe", SessionCode);
                await hubConnection.DisposeAsync();
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Error disposing SignalR connection: {ex.Message}");
            }
        }

        // Clean up participant session when leaving
        await CleanupParticipantSession();
    }

    // ===================
    // COMMON METHODS
    // ===================

    private async Task SubmitResponse(string payload)
    {
        if (currentActivity == null || !Pid.HasValue)
        {
            submitMessage = "ERROR: Validation failed in SubmitResponse";
            StateHasChanged();
            return;
        }

        isSubmittingResponse = true;
        submitMessage = "";
        submitSuccess = false;
        StateHasChanged();

        try
        {
            // Convert to proper request type
            var request = new TechWayFit.Pulse.Contracts.Requests.SubmitResponseRequest
            {
                ParticipantId = Pid.Value,
                Payload = payload
            };

            await ApiService.SubmitResponseAsync(SessionCode, currentActivity.ActivityId, request);

            hasSubmittedResponse = true;
            totalResponsesSubmitted++;
            contributionsRemaining--;
            submitSuccess = true;
            submitMessage = "Response submitted successfully!";
        }
        catch (Exception ex)
        {
            submitSuccess = false;
            submitMessage = $"API Error: {ex.Message}";
        }
        finally
        {
            isSubmittingResponse = false;
            StateHasChanged();
        }
    }
}
