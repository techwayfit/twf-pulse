@using Microsoft.AspNetCore.SignalR.Client
@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Application.Abstractions.Services
@inject IWordCloudDashboardService DashboardService
@inject ISessionService SessionService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<div class="activity-display">
    <div class="activity-header">
        <div class="activity-title-section">
            <span class="activity-badge badge-wordcloud">Word Cloud</span>
            <h2>@ActivityTitle</h2>
            @if (!string.IsNullOrEmpty(ActivityPrompt))
            {
                <p class="activity-description">@ActivityPrompt</p>
            }
        </div>
        @if (DurationMinutes.HasValue && OpenedAt.HasValue)
        {
            <div class="activity-timer">
                <div class="timer-label">Time Remaining</div>
                <div class="timer-value" id="timer-display">@TimeRemaining</div>
            </div>
        }
    </div>

    <div class="activity-content">
        <!-- Response Stats -->
        <div class="response-stats">
            <div class="stat-card">
                <div class="stat-value">@ResponseCount</div>
                <div class="stat-label">Responses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@ParticipantCount</div>
                <div class="stat-label">Participants</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@TotalWords</div>
                <div class="stat-label">Total Words</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@UniqueWords</div>
                <div class="stat-label">Unique Words</div>
            </div>
        </div>

        <!-- Word Cloud Display -->
        <div class="word-cloud-container">
            @if (WordFrequencies != null && WordFrequencies.Any())
            {
                <div class="word-cloud-display">
                    @foreach (var word in WordFrequencies.Take(30))
                    {
                        var fontSize = CalculateFontSize(word.Count);
                        var color = GetWordColor(word.Count);
                        <span class="cloud-word" style="font-size: @(fontSize)px; color: @color;">@word.Text</span>
                    }
                </div>
            }
            else
            {
                <div class="word-cloud-placeholder">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4C9.11 4 6.6 5.64 5.35 8.04C2.34 8.36 0 10.91 0 14C0 17.31 2.69 20 6 20H19C21.76 20 24 17.76 24 15C24 12.36 21.95 10.22 19.35 10.04Z"/>
                    </svg>
                    <p>No words to display yet</p>
                    <p class="sub">Word cloud will appear as participants submit their responses</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public required string SessionCode { get; set; }

    [Parameter, EditorRequired]
    public required Guid ActivityId { get; set; }

    [Parameter]
    public string ActivityTitle { get; set; } = "Word Cloud";

    [Parameter]
    public string? ActivityPrompt { get; set; }

    [Parameter]
    public int? DurationMinutes { get; set; }

    [Parameter]
    public DateTimeOffset? OpenedAt { get; set; }

    private HubConnection? hubConnection;
    private List<WordCloudItem> WordFrequencies { get; set; } = new();
    private int ResponseCount { get; set; } = 0;
    private int ParticipantCount { get; set; } = 0;
    private int TotalWords { get; set; } = 0;
    private int UniqueWords { get; set; } = 0;
    private string TimeRemaining { get; set; } = "--:--";
    private System.Threading.Timer? timer;
    private System.Threading.Timer? dataRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await InitializeSignalR();
        StartTimer();
        StartDataRefresh();
    }

    private async Task LoadData()
    {
        try
        {
            var session = await SessionService.GetByCodeAsync(SessionCode);
            if (session == null) return;

            var dashboard = await DashboardService.GetWordCloudDashboardAsync(
                session.Id,
                ActivityId,
                new Dictionary<string, string?>(),
                CancellationToken.None);

            WordFrequencies = dashboard.WordFrequencies.ToList();
            ResponseCount = dashboard.TotalResponses;
            ParticipantCount = dashboard.ParticipantCount;
            TotalWords = dashboard.TotalWords;
            UniqueWords = dashboard.UniqueWords;

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading word cloud data: {ex.Message}");
        }
    }

    private async Task InitializeSignalR()
    {
        var hubUrl = Navigation.ToAbsoluteUri($"/hubs/workshop");
        hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl)
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<TechWayFit.Pulse.Web.Hubs.ResponseReceivedEvent>("ResponseReceived", async (e) =>
        {
            if (e.SessionCode == SessionCode && e.ActivityId == ActivityId)
            {
                await LoadData();
            }
        });

        try
        {
            await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("Subscribe", SessionCode);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error connecting to hub: {ex.Message}");
        }
    }

    private void StartTimer()
    {
        if (DurationMinutes.HasValue && OpenedAt.HasValue)
        {
            timer = new System.Threading.Timer(UpdateTimer, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
        }
    }

    private void StartDataRefresh()
    {
        // Refresh data every 5 seconds as a fallback
        dataRefreshTimer = new System.Threading.Timer(async _ => await LoadData(), null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private void UpdateTimer(object? state)
    {
        if (DurationMinutes.HasValue && OpenedAt.HasValue)
        {
            var endTime = OpenedAt.Value.AddMinutes(DurationMinutes.Value);
            var remaining = endTime - DateTimeOffset.UtcNow;

            if (remaining.TotalSeconds > 0)
            {
                TimeRemaining = $"{remaining.Minutes}:{remaining.Seconds:D2}";
            }
            else
            {
                TimeRemaining = "0:00";
            }

            InvokeAsync(StateHasChanged);
        }
    }

    private int CalculateFontSize(int frequency)
    {
        if (WordFrequencies == null || !WordFrequencies.Any()) return 24;

        var maxFreq = WordFrequencies.Max(w => w.Count);
        var minFreq = WordFrequencies.Min(w => w.Count);
        var range = maxFreq - minFreq;

        if (range == 0) return 36;

        var normalized = (frequency - minFreq) / (double)range;
        return (int)(26 + (normalized * 36)); // 26px to 62px
    }

    private string GetWordColor(int frequency)
    {
        var colors = new[] { "#0EA5E9", "#10B981", "#0284C7", "#059669", "#38BDF8", "#34D399" };
        var index = frequency % colors.Length;
        return colors[index];
    }

    public async ValueTask DisposeAsync()
    {
        timer?.Dispose();
        dataRefreshTimer?.Dispose();

        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
