@using Microsoft.AspNetCore.SignalR.Client
@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Application.Abstractions.Services
@inject IGeneralFeedbackDashboardService DashboardService
@inject ISessionService SessionService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<div class="activity-display">
    <div class="activity-header">
        <div class="activity-title-section">
            <span class="activity-badge badge-feedback">Feedback</span>
            <h2>@ActivityTitle</h2>
            @if (!string.IsNullOrEmpty(ActivityPrompt))
            {
                <p class="activity-description">@ActivityPrompt</p>
            }
        </div>
        @if (DurationMinutes.HasValue && OpenedAt.HasValue)
        {
            <div class="activity-timer">
                <div class="timer-label">Time Remaining</div>
                <div class="timer-value" id="timer-display">@TimeRemaining</div>
            </div>
        }
    </div>

    <div class="activity-content">
        @if (FeedbackItems != null && FeedbackItems.Any())
        {
            <div class="general-feedback-items">
                @foreach (var feedback in FeedbackItems.OrderByDescending(f => f.CreatedAt))
                {
                    <div class="general-feedback-item">
                        <div class="feedback-item-header">
                            <div class="feedback-item-avatar">
                                @(feedback.IsAnonymous ? "??" : GetInitials(feedback.Content))
                            </div>
                            <div class="feedback-item-meta">
                                <div class="feedback-item-name">@(feedback.IsAnonymous ? "Anonymous" : "Participant")</div>
                                <div class="feedback-item-time">@GetTimeAgo(feedback.CreatedAt)</div>
                            </div>
                        </div>
                        <div class="feedback-item-text">
                            @feedback.Content
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="waiting-state">
                <svg class="waiting-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H6L4 18V4H20V16Z"/>
                </svg>
                <h3>Waiting for feedback</h3>
                <p>Responses will appear as participants submit their feedback</p>
            </div>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public required string SessionCode { get; set; }

    [Parameter, EditorRequired]
    public required Guid ActivityId { get; set; }

    [Parameter]
    public string ActivityTitle { get; set; } = "General Feedback";

    [Parameter]
    public string? ActivityPrompt { get; set; }

    [Parameter]
    public int? DurationMinutes { get; set; }

    [Parameter]
    public DateTimeOffset? OpenedAt { get; set; }

    private HubConnection? hubConnection;
    private List<Contracts.Responses.FeedbackItem> FeedbackItems { get; set; } = new();
    private string TimeRemaining { get; set; } = "--:--";
    private System.Threading.Timer? timer;
    private System.Threading.Timer? dataRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await InitializeSignalR();
        StartTimer();
        StartDataRefresh();
    }

    private async Task LoadData()
    {
        try
        {
            var session = await SessionService.GetByCodeAsync(SessionCode);
            if (session == null) return;

            var dashboard = await DashboardService.GetGeneralFeedbackDashboardAsync(
                session.Id,
                ActivityId,
                new Dictionary<string, string?>(),
                CancellationToken.None);

            FeedbackItems = dashboard.Feedbacks.ToList();

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading general feedback data: {ex.Message}");
        }
    }

    private async Task InitializeSignalR()
    {
        var hubUrl = Navigation.ToAbsoluteUri($"/hubs/workshop");
        hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl)
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<TechWayFit.Pulse.Web.Hubs.ResponseReceivedEvent>("ResponseReceived", async (e) =>
        {
            if (e.SessionCode == SessionCode && e.ActivityId == ActivityId)
            {
                await LoadData();
            }
        });

        try
        {
            await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("Subscribe", SessionCode);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error connecting to hub: {ex.Message}");
        }
    }

    private void StartDataRefresh()
    {
        dataRefreshTimer = new System.Threading.Timer(async _ => await LoadData(), null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private void StartTimer()
    {
        if (DurationMinutes.HasValue && OpenedAt.HasValue)
        {
            timer = new System.Threading.Timer(UpdateTimer, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
        }
    }

    private void UpdateTimer(object? state)
    {
        if (DurationMinutes.HasValue && OpenedAt.HasValue)
        {
            var endTime = OpenedAt.Value.AddMinutes(DurationMinutes.Value);
            var remaining = endTime - DateTimeOffset.UtcNow;

            if (remaining.TotalSeconds > 0)
            {
                TimeRemaining = $"{remaining.Minutes}:{remaining.Seconds:D2}";
            }
            else
            {
                TimeRemaining = "0:00";
            }

            InvokeAsync(StateHasChanged);
        }
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        return name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }

    private string GetTimeAgo(DateTimeOffset dateTime)
    {
        var timeSpan = DateTimeOffset.UtcNow - dateTime;
        
        if (timeSpan.TotalSeconds < 60)
            return "Just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        
        return dateTime.ToString("MMM dd");
    }

    public async ValueTask DisposeAsync()
    {
        timer?.Dispose();
        dataRefreshTimer?.Dispose();

        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
