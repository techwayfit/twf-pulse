@using Microsoft.AspNetCore.SignalR.Client
@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Application.Abstractions.Services
@inject IRatingDashboardService DashboardService
@inject ISessionService SessionService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<div class="activity-display">
    <div class="activity-header">
        <div class="activity-title-section">
            <span class="activity-badge badge-rating">Rating</span>
            <h2>@ActivityTitle</h2>
            @if (!string.IsNullOrEmpty(ActivityPrompt))
            {
                <p class="activity-description">@ActivityPrompt</p>
            }
        </div>
        @if (DurationMinutes.HasValue && OpenedAt.HasValue)
        {
            <div class="activity-timer">
                <div class="timer-label">Time Remaining</div>
                <div class="timer-value" id="timer-display">@TimeRemaining</div>
            </div>
        }
    </div>

    <div class="activity-content">
        <div class="rating-display">
            @if (TotalRatings > 0)
            {
                <div class="rating-title">@ActivityTitle</div>
                <div class="rating-score-container">
                    <div class="rating-score">@AverageRating.ToString("F1")</div>
                    <div class="rating-scale">out of @MaxRating.0</div>
                </div>
                
                <div class="rating-stars">
                    @for (int i = 1; i <= MaxRating; i++)
                    {
                        <svg class="star @(i <= Math.Round(AverageRating) ? "" : "empty")" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                        </svg>
                    }
                </div>

                <div class="rating-breakdown">
                    @foreach (var item in RatingBreakdown.OrderByDescending(r => r.Rating))
                    {
                        var heightPercent = TotalRatings > 0 ? (item.Count * 100.0 / TotalRatings) : 0;
                        <div class="rating-bar">
                            <div class="rating-bar-label">@(new string('â˜…', item.Rating))</div>
                            <div class="rating-bar-visual">
                                <div class="rating-bar-fill" style="height: @(heightPercent)%;"></div>
                            </div>
                            <div class="rating-bar-count">@item.Count</div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="waiting-state">
                    <svg class="waiting-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                    </svg>
                    <h3>Waiting for ratings</h3>
                    <p>Results will appear as participants submit their ratings</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public required string SessionCode { get; set; }

    [Parameter, EditorRequired]
    public required Guid ActivityId { get; set; }

    [Parameter]
    public string ActivityTitle { get; set; } = "Rating";

    [Parameter]
    public string? ActivityPrompt { get; set; }

    [Parameter]
    public int? DurationMinutes { get; set; }

    [Parameter]
    public DateTimeOffset? OpenedAt { get; set; }

    [Parameter]
    public int MaxRating { get; set; } = 5;

    private HubConnection? hubConnection;
    private List<RatingDistributionItem> RatingBreakdown { get; set; } = new();
    private double AverageRating { get; set; } = 0;
    private int TotalRatings { get; set; } = 0;
    private string TimeRemaining { get; set; } = "--:--";
    private System.Threading.Timer? timer;
    private System.Threading.Timer? dataRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await InitializeSignalR();
        StartTimer();
        StartDataRefresh();
    }

    private async Task LoadData()
    {
        try
        {
            var session = await SessionService.GetByCodeAsync(SessionCode);
            if (session == null) return;

            var dashboard = await DashboardService.GetRatingDashboardAsync(
                session.Id,
                ActivityId,
                new Dictionary<string, string?>(),
                CancellationToken.None);

            AverageRating = dashboard.AverageRating;
            TotalRatings = dashboard.TotalResponses;
            RatingBreakdown = dashboard.Distribution.ToList();

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading rating data: {ex.Message}");
        }
    }

    private async Task InitializeSignalR()
    {
        var hubUrl = Navigation.ToAbsoluteUri($"/hubs/workshop");
        hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl)
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<TechWayFit.Pulse.Web.Hubs.ResponseReceivedEvent>("ResponseReceived", async (e) =>
        {
            if (e.SessionCode == SessionCode && e.ActivityId == ActivityId)
            {
                await LoadData();
            }
        });

        try
        {
            await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("Subscribe", SessionCode);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error connecting to hub: {ex.Message}");
        }
    }

    private void StartDataRefresh()
    {
        dataRefreshTimer = new System.Threading.Timer(async _ => await LoadData(), null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private void StartTimer()
    {
        if (DurationMinutes.HasValue && OpenedAt.HasValue)
        {
            timer = new System.Threading.Timer(UpdateTimer, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
        }
    }

    private void UpdateTimer(object? state)
    {
        if (DurationMinutes.HasValue && OpenedAt.HasValue)
        {
            var endTime = OpenedAt.Value.AddMinutes(DurationMinutes.Value);
            var remaining = endTime - DateTimeOffset.UtcNow;

            if (remaining.TotalSeconds > 0)
            {
                TimeRemaining = $"{remaining.Minutes}:{remaining.Seconds:D2}";
            }
            else
            {
                TimeRemaining = "0:00";
            }

            InvokeAsync(StateHasChanged);
        }
    }

    public async ValueTask DisposeAsync()
    {
        timer?.Dispose();

        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
