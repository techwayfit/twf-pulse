@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Enums
@using TechWayFit.Pulse.Web.Components.Dashboards

<!-- Current Activity (if open) -->
<div class="card border-0 shadow-sm mb-3 border-start border-success border-3">
    <div class="card-body p-3 p-md-4">
    <div class="d-flex justify-content-between align-items-start mb-2 flex-wrap gap-2">
    <div class="flex-grow-1">
     <h5 class="mb-1 h6 h5-md">
         <span class="badge bg-success me-2">
  <span class="pulse-dot me-1"></span>LIVE
            </span>
      @Activity.Title
            </h5>
         <p class="text-muted small mb-0">@(Activity.Prompt ?? "No prompt")</p>
       </div>
<div class="d-flex gap-2 align-items-center flex-wrap">
              @if (Activity.DurationMinutes.HasValue && Activity.OpenedAt.HasValue)
     {
              <div id="activity-timer"
             data-duration="@Activity.DurationMinutes.Value"
   data-opened-at="@Activity.OpenedAt.Value.ToString("o")"
  class="timer-display">
       <i class="fas fa-clock me-1"></i>
    <span class="timer-text">--:--</span>
          </div>
       }
      else if (Activity.DurationMinutes.HasValue)
           {
         <div class="text-muted small">
            <i class="fas fa-clock me-1"></i>
         <span>Duration: @Activity.DurationMinutes.Value min</span>
         </div>
       }
   else
        {
   <button class="btn btn-sm btn-outline-secondary" @onclick="OnShowSetTimer">
       <i class="fas fa-clock me-1"></i>Set Timer
           </button>
          }
        <span class="badge bg-light text-dark">#@Activity.Order</span>
      </div>
        </div>

        <!-- Live Activity Dashboard -->
        <div class="bg-light rounded-3 p-4 mb-3">
            @if (Activity.Type == ActivityType.Poll)
            {
     <PollDashboard
        SessionCode="@SessionCode"
 ActivityId="@Activity.ActivityId" />
 }
            else if (Activity.Type == ActivityType.WordCloud)
         {
       <WordCloudDashboard
          SessionCode="@SessionCode"
       ActivityId="@Activity.ActivityId" />
        }
            else if (Activity.Type == ActivityType.Rating)
            {
      <RatingDashboard
    SessionCode="@SessionCode"
          ActivityId="@Activity.ActivityId" />
   }
            else if (Activity.Type == ActivityType.GeneralFeedback)
            {
    <GeneralFeedbackDashboard
  SessionCode="@SessionCode"
         ActivityId="@Activity.ActivityId" />
       }
 else
        {
  <div class="text-center">
        <p class="text-muted mb-0">
       <i class="fas fa-chart-bar me-2"></i>
   Live dashboard for @Activity.Type activities coming soon
  </p>
            </div>
            }
        </div>

        <!-- Activity Controls -->
        <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
    <!-- Go Back Button -->
   @if (HasPrevious)
 {
         <button class="btn btn-sm btn-outline-secondary"
         @onclick="OnGoBack"
          disabled="@IsPerformingAction">
              <i class="fas fa-arrow-left"></i>
    <span class="d-none d-md-inline ms-1">@(IsPerformingAction ? "Moving..." : "Back")</span>
       </button>
    }

    <!-- Close Button -->
            <button class="btn btn-sm btn-warning"
  @onclick="OnClose"
      disabled="@IsPerformingAction">
                <i class="fas fa-stop"></i>
          <span class="d-none d-md-inline ms-1">@(IsPerformingAction ? "Closing..." : "Close")</span>
            </button>

            <!-- Move Next Button -->
      @if (HasNext)
            {
          <button class="btn btn-sm btn-primary"
      @onclick="OnMoveNext"
     disabled="@IsPerformingAction">
 <span class="d-none d-md-inline me-1">@(IsPerformingAction ? "Moving..." : "Next")</span>
      <i class="fas fa-arrow-right"></i>
 </button>
            }
            else
       {
           <span class="badge bg-info ms-auto">Last Activity</span>
            }

            <a class="btn btn-sm btn-outline-primary ms-auto" href="/facilitator/dashboards">
      <i class="fas fa-chart-bar me-1"></i>View Dashboard
         </a>
        </div>
    </div>
</div>

<!-- Activity Presenter Mode Component -->
<ActivityPresenterMode Activity="@Activity"
  SessionCode="@SessionCode"
 ParticipantCount="@ParticipantCount"
                ResponseCount="@ResponseCount"
   IsPerformingAction="@IsPerformingAction"
 HasPrevious="@HasPrevious"
               HasNext="@HasNext"
      OnClose="@OnClose"
    OnGoBack="@OnGoBack"
       OnMoveNext="@OnMoveNext" />

<style>
    .timer-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
 color: white;
     padding: 0.5rem 1rem;
   border-radius: 8px;
   font-weight: 600;
 font-size: 0.95rem;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
     min-width: 100px;
      text-align: center;
    }

    .timer-display.timer-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        animation: pulse-glow 2s ease-in-out infinite;
 }

    .timer-display.timer-expired {
     background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
 animation: pulse-glow 1s ease-in-out infinite;
    }

    @@keyframes pulse-glow {
        0%, 100% { box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3); }
      50% { box-shadow: 0 4px 16px rgba(245, 87, 108, 0.6); }
  }

    .timer-text {
        font-variant-numeric: tabular-nums;
    }
</style>

<script>
    let timerInterval = null;

    function startActivityTimer() {
     console.log('startActivityTimer called');
        const timerEl = document.getElementById('activity-timer');
      console.log('Timer element:', timerEl);

     if (!timerEl) {
     console.log('No timer element found');
 return;
        }

        const durationMinutes = parseInt(timerEl.dataset.duration);
        const openedAt = new Date(timerEl.dataset.openedAt);
 const timerText = timerEl.querySelector('.timer-text');

        console.log('Duration:', durationMinutes, 'OpenedAt:', openedAt, 'TimerText:', timerText);

        if (timerInterval) clearInterval(timerInterval);

        function updateTimer() {
      const now = new Date();
   const elapsedMs = now - openedAt;
            const elapsedSeconds = Math.floor(elapsedMs / 1000);
            const totalSeconds = durationMinutes * 60;
const remainingSeconds = Math.max(0, totalSeconds - elapsedSeconds);

       const minutes = Math.floor(remainingSeconds / 60);
const seconds = remainingSeconds % 60;

  timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Visual feedback
  if (remainingSeconds === 0) {
 timerEl.classList.add('timer-expired');
  timerText.textContent = 'Time\\'s Up!';
  } else if (remainingSeconds <= 60) {
         timerEl.classList.add('timer-warning');
     timerEl.classList.remove('timer-expired');
     } else {
      timerEl.classList.remove('timer-warning', 'timer-expired');
   }
      }

        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
    }

    // Auto-start timer when page loads
    if (document.readyState === 'loading') {
   document.addEventListener('DOMContentLoaded', startActivityTimer);
  } else {
        startActivityTimer();
    }

 // Restart timer on Blazor re-render - but only when timer element is added/removed
    let lastTimerElement = document.getElementById('activity-timer');
    const observer = new MutationObserver(() => {
  const currentTimerElement = document.getElementById('activity-timer');

  // Only restart timer if the element was added (wasn't there before, now it is)
  if (currentTimerElement && !lastTimerElement) {
     startActivityTimer();
   }
   // Clear timer if element was removed
   else if (!currentTimerElement && lastTimerElement && timerInterval) {
  clearInterval(timerInterval);
  timerInterval = null;
        }

        lastTimerElement = currentTimerElement;
    });

    observer.observe(document.body, { childList: true, subtree: true });
</script>

@code {
    [Parameter, EditorRequired]
    public AgendaActivityResponse Activity { get; set; } = default!;

    [Parameter, EditorRequired]
    public string SessionCode { get; set; } = default!;

    [Parameter]
    public bool IsPerformingAction { get; set; }

    [Parameter]
    public bool HasPrevious { get; set; }

    [Parameter]
    public bool HasNext { get; set; }

    [Parameter]
    public int ParticipantCount { get; set; }

    [Parameter]
    public int ResponseCount { get; set; }

    [Parameter]
    public EventCallback OnShowSetTimer { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback OnGoBack { get; set; }

    [Parameter]
    public EventCallback OnMoveNext { get; set; }
}
