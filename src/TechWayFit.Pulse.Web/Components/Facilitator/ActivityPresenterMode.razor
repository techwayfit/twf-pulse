@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Enums
@using TechWayFit.Pulse.Web.Components.Dashboards
@inject IJSRuntime JS

<!-- Activity Presenter Mode Toggle Button -->
<button class="btn btn-primary activity-presenter-toggle" 
  @onclick="TogglePresenterMode"
        title="@(isPresenterMode ? "Exit Presenter Mode (ESC)" : "Present Activity Full-Screen")">
  <span class="icon-expand">
        <i class="fas fa-tv me-2"></i>
        <span class="d-none d-md-inline">Presenter Mode</span>
    </span>
    <span class="icon-compress">
        <i class="fas fa-compress-alt me-2"></i>
        <span class="d-none d-md-inline">Exit Presenter</span>
    </span>
</button>

<!-- Presenter Mode Overlay -->
@if (isPresenterMode && Activity != null)
{
    <div class="activity-presenter-overlay" @onclick:stopPropagation="true">
     <div class="activity-presenter-container">
          <!-- Header Bar -->
     <div class="presenter-header">
    <div class="d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center gap-3">
  <span class="badge bg-success presenter-badge-live">
  <span class="pulse-dot me-2"></span>LIVE
             </span>
      <h1 class="mb-0 presenter-title">@Activity.Title</h1>
      @if (!string.IsNullOrEmpty(Activity.Prompt))
      {
         <span class="presenter-subtitle">• @Activity.Prompt</span>
    }
        </div>
  <div class="d-flex align-items-center gap-3">
       @if (Activity.DurationMinutes.HasValue && Activity.OpenedAt.HasValue)
  {
      <div id="activity-timer-presenter"
 data-duration="@Activity.DurationMinutes.Value"
       data-opened-at="@Activity.OpenedAt.Value.ToString("o")"
        class="timer-display-presenter">
         <i class="fas fa-clock me-2"></i>
 <span class="timer-text">--:--</span>
 </div>
  }
     <span class="badge bg-light text-dark presenter-badge-order">#@Activity.Order</span>
      <button class="btn btn-lg btn-outline-light presenter-exit-btn" @onclick="TogglePresenterMode">
    <i class="fas fa-times me-2"></i>Exit Presenter Mode
       </button>
         </div>
         </div>
   </div>

   <!-- Main Content Area: Full Width Dashboard -->
         <div class="presenter-content">
       <div class="presenter-main-content">
      <div class="presenter-dashboard-wrapper">
@if (Activity.Type == ActivityType.Poll)
    {
     <PollDashboard
       SessionCode="@SessionCode"
     ActivityId="@Activity.ActivityId" />
      }
  else if (Activity.Type == ActivityType.WordCloud)
      {
        <WordCloudDashboard
     SessionCode="@SessionCode"
          ActivityId="@Activity.ActivityId" />
          }
 else if (Activity.Type == ActivityType.Rating)
     {
   <RatingDashboard
 SessionCode="@SessionCode"
    ActivityId="@Activity.ActivityId" />
 }
    else if (Activity.Type == ActivityType.GeneralFeedback)
      {
      <GeneralFeedbackDashboard
   SessionCode="@SessionCode"
 ActivityId="@Activity.ActivityId" />
          }
        else
  {
    <div class="text-center py-5">
    <p class="presenter-empty-message">
   <i class="fas fa-chart-bar me-3"></i>
         Live dashboard for @Activity.Type activities coming soon
    </p>
        </div>
        }
  </div>
     
         <!-- Stats Sidebar - Fixed Position -->
      <div class="presenter-stats-sidebar">
      <div class="presenter-stats-card">
          <div class="presenter-stats-header">
      <i class="fas fa-users me-2"></i>Live Activity
    </div>
      <div class="presenter-stats-content">
       <div class="presenter-stat-item">
       <div class="presenter-stat-value">@ParticipantCount</div>
 <div class="presenter-stat-label">Participants</div>
      </div>
  <div class="presenter-stat-item">
 <div class="presenter-stat-value text-primary">@ResponseCount</div>
       <div class="presenter-stat-label">Responses</div>
  </div>
            </div>
  </div>
                   
<LiveSubmissionsFeed 
  SessionCode="@SessionCode"
     ActivityId="@Activity.ActivityId" />
   </div>
</div>

  <!-- Footer Controls -->
       <div class="presenter-footer">
      <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex gap-3">
             @if (HasPrevious)
          {
  <button class="btn btn-lg btn-outline-light presenter-control-btn"
                @onclick="OnGoBack"
       disabled="@IsPerformingAction">
         <i class="fas fa-arrow-left me-2"></i>Previous
     </button>
       }
    <button class="btn btn-lg btn-warning presenter-control-btn"
      @onclick="OnClose"
     disabled="@IsPerformingAction">
 <i class="fas fa-stop me-2"></i>Close Activity
</button>
 @if (HasNext)
     {
    <button class="btn btn-lg btn-primary presenter-control-btn"
       @onclick="OnMoveNext"
   disabled="@IsPerformingAction">
         Next<i class="fas fa-arrow-right ms-2"></i>
</button>
        }
          </div>
   <div class="presenter-footer-hint">
    Press <kbd>ESC</kbd> to exit presenter mode
   </div>
      </div>
 </div>
  </div>
    </div>
    </div>
}

<style>
    /* ========================================
       PRESENTER MODE - ENHANCED STYLES
       ======================================== */
    
    .activity-presenter-toggle {
        position: fixed;
 top: 1rem;
  right: 1rem;
        z-index: 1050;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
   transition: all 0.2s ease;
    }

    .activity-presenter-toggle:hover {
     transform: translateY(-2px);
   box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

 /* Show/hide icons based on state */
    body:not(.presenter-mode-active) .activity-presenter-toggle .icon-expand {
        display: inline;
    }

    body:not(.presenter-mode-active) .activity-presenter-toggle .icon-compress {
 display: none;
    }

    body.presenter-mode-active .activity-presenter-toggle .icon-expand {
    display: none;
    }

    body.presenter-mode-active .activity-presenter-toggle .icon-compress {
     display: inline;
    }

  /* Presenter Mode Overlay */
    .activity-presenter-overlay {
        position: fixed;
      top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from {
opacity: 0;
     }
     to {
      opacity: 1;
        }
    }

    .activity-presenter-container {
 display: flex;
        flex-direction: column;
 height: 100vh;
   width: 100%;
 }

    /* ========================================
       HEADER - ENHANCED
       ======================================== */
    .presenter-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
padding: 1.5rem 3rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 10;
    }

    .presenter-title {
        font-size: 2rem;
        font-weight: 700;
      letter-spacing: -0.5px;
    }

    .presenter-subtitle {
        font-size: 1.25rem;
  color: rgba(255, 255, 255, 0.9);
        font-weight: 400;
    }

    .presenter-badge-live {
        font-size: 1rem;
        padding: 0.75rem 1.25rem;
      font-weight: 600;
    }

    .presenter-badge-order {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
        font-weight: 600;
    }

    .presenter-exit-btn {
font-size: 1rem;
      padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    .timer-display-presenter {
      background: rgba(255, 255, 255, 0.2);
  color: white;
  padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1.5rem;
   min-width: 140px;
      text-align: center;
      backdrop-filter: blur(10px);
    }

    .timer-display-presenter .fa-clock {
    font-size: 1.25rem;
    }

    .timer-display-presenter.timer-warning {
        background: rgba(245, 87, 108, 0.3);
      animation: pulse-glow-presenter 2s ease-in-out infinite;
    }

    .timer-display-presenter.timer-expired {
      background: rgba(254, 225, 64, 0.3);
        animation: pulse-glow-presenter 1s ease-in-out infinite;
    }

    @@keyframes pulse-glow-presenter {
     0%, 100% {
 box-shadow: 0 2px 8px rgba(255, 255, 255, 0.3);
        }
 50% {
        box-shadow: 0 4px 16px rgba(255, 255, 255, 0.6);
  }
    }

    /* ========================================
       MAIN CONTENT - REDESIGNED LAYOUT
     ======================================== */
    .presenter-content {
 flex: 1;
      overflow: hidden;
   background: #f8f9fa;
  position: relative;
    }

    .presenter-main-content {
        height: 100%;
        display: flex;
      gap: 1.5rem;
        padding: 2rem;
    }

  /* Dashboard takes most space */
  .presenter-dashboard-wrapper {
     flex: 1;
        background: white;
        border-radius: 16px;
        padding: 2.5rem;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* Larger fonts for all dashboard content */
    .presenter-dashboard-wrapper h2,
    .presenter-dashboard-wrapper h3,
    .presenter-dashboard-wrapper h4,
    .presenter-dashboard-wrapper h5,
    .presenter-dashboard-wrapper .h2,
    .presenter-dashboard-wrapper .h3,
    .presenter-dashboard-wrapper .h4,
    .presenter-dashboard-wrapper .h5 {
      font-size: 2rem !important;
        font-weight: 700 !important;
        margin-bottom: 1.5rem !important;
    }

    .presenter-dashboard-wrapper .card-title {
      font-size: 2rem !important;
    }

    .presenter-dashboard-wrapper p,
    .presenter-dashboard-wrapper .text-muted,
    .presenter-dashboard-wrapper small,
    .presenter-dashboard-wrapper .small {
 font-size: 1.25rem !important;
    }

    .presenter-dashboard-wrapper .badge {
        font-size: 1.1rem !important;
        padding: 0.5rem 1rem !important;
    }

 /* Stat boxes larger */
    .presenter-dashboard-wrapper .bg-primary,
    .presenter-dashboard-wrapper .bg-info,
  .presenter-dashboard-wrapper .bg-success,
    .presenter-dashboard-wrapper .bg-warning {
        padding: 2rem !important;
    }

    .presenter-dashboard-wrapper .h4 {
        font-size: 3rem !important;
        font-weight: 800 !important;
    }

    /* Word Cloud specific enhancements */
    .presenter-dashboard-wrapper canvas {
    min-height: 500px !important;
    }

    .presenter-dashboard-wrapper .btn {
        font-size: 1.1rem !important;
        padding: 0.75rem 1.5rem !important;
    }

    .presenter-empty-message {
      font-size: 1.75rem !important;
    color: #6c757d;
        margin: 0;
    }

    /* ========================================
       STATS SIDEBAR - FIXED RIGHT SIDE
       ======================================== */
    .presenter-stats-sidebar {
        width: 320px;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
flex-shrink: 0;
    }

    .presenter-stats-card {
        background: white;
        border-radius: 16px;
     padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .presenter-stats-header {
  font-size: 1.25rem;
        font-weight: 700;
     color: #0F2438;
    margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    .presenter-stats-content {
        display: flex;
     flex-direction: column;
        gap: 1.5rem;
    }

    .presenter-stat-item {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .presenter-stat-value {
        font-size: 3rem;
        font-weight: 800;
        color: #2BC48A;
   line-height: 1;
     margin-bottom: 0.5rem;
    }

    .presenter-stat-label {
        font-size: 1rem;
     color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    font-weight: 600;
    }

    /* ========================================
       FOOTER - ENHANCED
       ======================================== */
    .presenter-footer {
        background: #343a40;
        color: white;
   padding: 1.5rem 3rem;
     box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
   z-index: 10;
  }

    .presenter-control-btn {
        font-size: 1.1rem;
        padding: 0.75rem 1.75rem;
        font-weight: 600;
    }

    .presenter-footer-hint {
  color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
    }

    .presenter-footer kbd {
        background: #495057;
        color: white;
        padding: 0.5rem 0.75rem;
 border-radius: 6px;
     border: 1px solid #6c757d;
        font-size: 1rem;
 }

    /* ========================================
       RESPONSIVE ADJUSTMENTS
       ======================================== */
    @@media (max-width: 1400px) {
        .presenter-stats-sidebar {
   width: 280px;
        }

        .presenter-title {
        font-size: 1.75rem;
        }

        .presenter-subtitle {
 font-size: 1.1rem;
        }
  }

  @@media (max-width: 1200px) {
        .presenter-main-content {
       flex-direction: column;
        }

        .presenter-stats-sidebar {
         width: 100%;
    flex-direction: row;
        }

        .presenter-stats-card {
    flex: 1;
        }
    }

    @@media (max-width: 768px) {
        .presenter-header {
   padding: 1rem 1.5rem;
        }

    .presenter-title {
            font-size: 1.5rem;
   }

        .presenter-subtitle {
  display: none;
        }

        .presenter-main-content {
            padding: 1rem;
        }

        .presenter-dashboard-wrapper {
     padding: 1.5rem;
        }

        .presenter-footer {
      padding: 1rem 1.5rem;
        }

.presenter-stats-sidebar {
            flex-direction: column;
        }
}

    /* Hide other elements when presenter mode is active */
    body.presenter-mode-active .pulse-navbar,
    body.presenter-mode-active footer,
    body.presenter-mode-active .fullscreen-toggle-btn {
  display: none !important;
 }
</style>

<script>
    let presenterTimerInterval = null;

    function startPresenterTimer() {
   console.log('startPresenterTimer called');
    const timerEl = document.getElementById('activity-timer-presenter');

        if (!timerEl) {
            console.log('No presenter timer element found');
  return;
  }

     const durationMinutes = parseInt(timerEl.dataset.duration);
        const openedAt = new Date(timerEl.dataset.openedAt);
        const timerText = timerEl.querySelector('.timer-text');

     if (presenterTimerInterval) clearInterval(presenterTimerInterval);

        function updateTimer() {
       const now = new Date();
            const elapsedMs = now - openedAt;
       const elapsedSeconds = Math.floor(elapsedMs / 1000);
  const totalSeconds = durationMinutes * 60;
 const remainingSeconds = Math.max(0, totalSeconds - elapsedSeconds);

     const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;

            timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Visual feedback
    if (remainingSeconds === 0) {
   timerEl.classList.add('timer-expired');
       timerText.textContent = 'Time\'s Up!';
            } else if (remainingSeconds <= 60) {
   timerEl.classList.add('timer-warning');
     timerEl.classList.remove('timer-expired');
   } else {
        timerEl.classList.remove('timer-warning', 'timer-expired');
  }
        }

        updateTimer();
        presenterTimerInterval = setInterval(updateTimer, 1000);
    }

    // ESC key handler
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && document.body.classList.contains('presenter-mode-active')) {
     // Trigger Blazor callback to close presenter mode
    const closeButton = document.querySelector('.activity-presenter-overlay .presenter-exit-btn');
   if (closeButton) {
    closeButton.click();
        }
      }
    });

    // Auto-start presenter timer when element appears
  const presenterObserver = new MutationObserver(() => {
   const presenterTimerElement = document.getElementById('activity-timer-presenter');
        if (presenterTimerElement && !presenterTimerInterval) {
            startPresenterTimer();
    } else if (!presenterTimerElement && presenterTimerInterval) {
  clearInterval(presenterTimerInterval);
      presenterTimerInterval = null;
        }
 });

presenterObserver.observe(document.body, { childList: true, subtree: true });
</script>

@code {
  [Parameter, EditorRequired]
    public AgendaActivityResponse? Activity { get; set; }

  [Parameter, EditorRequired]
    public string SessionCode { get; set; } = default!;

    [Parameter]
    public int ParticipantCount { get; set; }

    [Parameter]
  public int ResponseCount { get; set; }

    [Parameter]
    public bool IsPerformingAction { get; set; }

    [Parameter]
 public bool HasPrevious { get; set; }

    [Parameter]
    public bool HasNext { get; set; }

 [Parameter]
    public EventCallback OnClose { get; set; }

  [Parameter]
 public EventCallback OnGoBack { get; set; }

    [Parameter]
    public EventCallback OnMoveNext { get; set; }

    private bool isPresenterMode = false;

  private async Task TogglePresenterMode()
    {
  isPresenterMode = !isPresenterMode;

   // Add/remove body class for CSS styling
      if (isPresenterMode)
   {
        await JS.InvokeVoidAsync("eval", "document.body.classList.add('presenter-mode-active')");
        }
        else
        {
 await JS.InvokeVoidAsync("eval", "document.body.classList.remove('presenter-mode-active')");
     }

        StateHasChanged();
    }
}
