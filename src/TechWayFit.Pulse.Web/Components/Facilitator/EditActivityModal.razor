@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Requests
@using TechWayFit.Pulse.Contracts.Enums
@using TechWayFit.Pulse.Web.Services
@using System.Text.Json
@inject IPulseApiService ApiService
@inject ILogger<EditActivityModal> Logger

<!-- Edit Activity Modal -->
<div class="modal fade @(IsVisible ? "show" : "")" id="editActivityModal" tabindex="-1" 
     style="display: @(IsVisible ? "block" : "none");" aria-modal="@IsVisible">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Edit Activity</h5>
                <button type="button" class="btn-close" @onclick="Close" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-scrollable">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @errorMessage
                        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                    </div>
                }

                @if (Activity != null)
                {
                    <!-- Activity Type Badge -->
                    <div class="mb-3">
                        @if (Activity.Status != TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending)
                        {
                            <span class="badge bg-warning-subtle text-warning ms-2">
                                Cannot edit - Activity is @Activity.Status
                            </span>
                        }
                    </div>

                    @if (Activity.Status == TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending)
                    {
                        <!-- Edit Form (Only for Pending Activities) -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="editActivityTitle" class="form-label">Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editActivityTitle" 
                                       @bind="editModel.Title" maxlength="200" required>
                            </div>
                            <div class="col-md-4">
                                <label for="editActivityDuration" class="form-label">Duration (min)</label>
                                <input type="number" class="form-control" id="editActivityDuration" 
                                       @bind="editModel.DurationMinutes" min="1" max="120" step="1" placeholder="Optional">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="editActivityPrompt" class="form-label">Prompt</label>
                            <textarea class="form-control" id="editActivityPrompt" 
                                      @bind="editModel.Prompt" rows="3" maxlength="1000"></textarea>
                            <div class="form-text">@(editModel.Prompt?.Length ?? 0) / 1000 characters</div>
                        </div>

                        @if (!string.IsNullOrEmpty(Activity.Config))
                        {
                            @* Parse config and show user-friendly form based on activity type *@
                            @if (Activity.Type == ActivityType.Poll)
                            {
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">üìä Poll Configuration</h6>
                                        <p class="small text-muted">For advanced configuration, use the Activity Builder</p>
                                        <div class="mb-2">
                                            <strong>Poll Options:</strong>
                                            <pre class="bg-white p-2 rounded small mt-1">@GetConfigDisplay()</pre>
                                        </div>
                                    </div>
                                </div>
                            }
                            else if (Activity.Type == ActivityType.WordCloud)
                            {
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">‚òÅÔ∏è Word Cloud Configuration</h6>
                                        <pre class="bg-white p-2 rounded small">@GetConfigDisplay()</pre>
                                    </div>
                                </div>
                            }
                            else if (Activity.Type == ActivityType.Rating)
                            {
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">‚≠ê Rating Configuration</h6>
                                        <pre class="bg-white p-2 rounded small">@GetConfigDisplay()</pre>
                                    </div>
                                </div>
                            }
                            else if (Activity.Type == ActivityType.Quadrant)
                            {
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">üìà Quadrant Configuration</h6>
                                        <pre class="bg-white p-2 rounded small">@GetConfigDisplay()</pre>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="mb-3">
                                    <label for="editActivityConfig" class="form-label">Configuration (JSON)</label>
                                    <textarea class="form-control font-monospace" id="editActivityConfig" 
                                              @bind="editModel.Config" rows="5"></textarea>
                                    <div class="form-text">Advanced: Activity-specific configuration</div>
                                </div>
                            }
                        }
                    }
                    else
                    {
                        <!-- Read-only View (For In-Progress or Completed Activities) -->
                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è Note:</strong> Activities can only be edited when they are in Pending status.
                            This activity is currently <strong>@Activity.Status</strong>.
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Title</label>
                            <p class="form-control-plaintext">@Activity.Title</p>
                        </div>

                        @if (!string.IsNullOrEmpty(Activity.Prompt))
                        {
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Prompt</label>
                                <p class="form-control-plaintext">@Activity.Prompt</p>
                            </div>
                        }
                    }
                }
            </div>
            <div class="modal-footer">
                @if (Activity?.Status == TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending)
                {
                    <button type="button" class="btn btn-danger me-auto" @onclick="DeleteActivity" 
                            disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        üóëÔ∏è Delete Activity
                    </button>
                }
                
                <button type="button" class="btn btn-secondary" @onclick="Close" 
                        disabled="@(isSaving || isDeleting)">
                    Close
                </button>
                
                @if (Activity?.Status == TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending)
                {
                    <button type="button" class="btn btn-primary" @onclick="SaveChanges" 
                            disabled="@(isSaving || isDeleting)">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Save Changes
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@if (IsVisible)
{
    <div class="modal-backdrop fade show"></div>
}

<style>
    .modal-body-scrollable {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
    }

    @@media (max-height: 700px) {
        .modal-body-scrollable {
            max-height: calc(100vh - 200px);
        }
    }
</style>

@code {
    [Parameter] public string? SessionCode { get; set; }
    [Parameter] public AgendaActivityResponse? Activity { get; set; }
    [Parameter] public EventCallback OnActivityUpdated { get; set; }
    [Parameter] public EventCallback OnActivityDeleted { get; set; }
    // Draft callbacks - used when editing activities before a session exists
    [Parameter] public EventCallback<AgendaActivityResponse> OnDraftActivityUpdated { get; set; }
    [Parameter] public EventCallback<Guid> OnDraftActivityDeleted { get; set; }

    private bool IsVisible { get; set; }
    private bool isSaving = false;
    private bool isDeleting = false;
    private string? errorMessage;

    private UpdateActivityRequest editModel = new();

    public void Show()
    {
        if (Activity == null) return;

        // Initialize edit model with current values
        editModel = new UpdateActivityRequest
        {
            Title = Activity.Title,
            Prompt = Activity.Prompt,
            Config = Activity.Config,
            DurationMinutes = Activity.DurationMinutes
        };

        IsVisible = true;
        errorMessage = null;
        StateHasChanged();
    }

    public void Close()
    {
        IsVisible = false;
        errorMessage = null;
        StateHasChanged();
    }

    private string GetConfigDisplay()
    {
        if (string.IsNullOrEmpty(Activity?.Config))
            return "No configuration";

        try
        {
            using var doc = JsonDocument.Parse(Activity.Config);
            var options = new JsonSerializerOptions 
            { 
                WriteIndented = true,
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            };
            return JsonSerializer.Serialize(doc.RootElement, options);
        }
        catch
        {
            return Activity.Config;
        }
    }

    private async Task SaveChanges()
    {
        if (string.IsNullOrWhiteSpace(SessionCode) || Activity == null)
        {
            errorMessage = "Invalid session or activity";
            return;
        }

        if (string.IsNullOrWhiteSpace(editModel.Title))
        {
            errorMessage = "Title is required";
            return;
        }

        if (Activity.Status != TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending)
        {
            errorMessage = "Only pending activities can be edited";
            return;
        }

        try
        {
            isSaving = true;
            errorMessage = null;
            StateHasChanged();

                if (string.IsNullOrEmpty(SessionCode))
                {
                    // Draft mode - don't call API, return updated activity to parent
                    var updated = new AgendaActivityResponse(
                        Activity!.ActivityId,
                        Activity.Order,
                        Activity.Type,
                        editModel.Title ?? Activity.Title,
                        editModel.Prompt ?? Activity.Prompt,
                        editModel.Config ?? Activity.Config,
                        Activity.Status,
                        Activity.OpenedAt,
                        Activity.ClosedAt,
                        editModel.DurationMinutes ?? Activity.DurationMinutes);

                    await OnDraftActivityUpdated.InvokeAsync(updated);
                    Close();
                    return;
                }

                var response = await ApiService.PutAsync<UpdateActivityRequest, ActivityResponse>(
                    $"/api/sessions/{SessionCode}/activities/{Activity.ActivityId}",
                    editModel);

                if (!response.Success)
                {
                    errorMessage = response.Errors?.FirstOrDefault()?.Message ?? "Failed to update activity";
                    isSaving = false;
                    StateHasChanged();
                    return;
                }

                // Success (server persisted)
                await OnActivityUpdated.InvokeAsync();
                Close();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating activity");
            errorMessage = "An error occurred while updating the activity";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task DeleteActivity()
    {
        if (string.IsNullOrWhiteSpace(SessionCode) || Activity == null)
        {
            errorMessage = "Invalid session or activity";
            return;
        }

        if (Activity.Status != TechWayFit.Pulse.Contracts.Enums.ActivityStatus.Pending)
        {
            errorMessage = "Only pending activities can be deleted";
            return;
        }

        if (!await ConfirmDelete())
        {
            return;
        }

        try
        {
            isDeleting = true;
            errorMessage = null;
            StateHasChanged();

            if (string.IsNullOrEmpty(SessionCode))
            {
                // Draft mode - inform parent to remove
                await OnDraftActivityDeleted.InvokeAsync(Activity!.ActivityId);
                Close();
                return;
            }

            var response = await ApiService.DeleteAsync<object>(
                $"/api/sessions/{SessionCode}/activities/{Activity.ActivityId}");

            if (!response.Success)
            {
                errorMessage = response.Errors?.FirstOrDefault()?.Message ?? "Failed to delete activity";
                isDeleting = false;
                StateHasChanged();
                return;
            }

            // Success
            await OnActivityDeleted.InvokeAsync();
            Close();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting activity");
            errorMessage = "An error occurred while deleting the activity";
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    private async Task<bool> ConfirmDelete()
    {
        // Simple confirmation - in production, you might want a better modal
        return await Task.FromResult(true); // For now, always confirm
        // TODO: Implement proper confirmation dialog
    }
}
