@using TechWayFit.Pulse.Contracts.Responses
@using TechWayFit.Pulse.Contracts.Enums

<!-- All Activities -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="card-title fw-semibold mb-0">Workshop Activities</h5>
            <span class="badge bg-primary bg-opacity-10 text-primary">@Activities.Count total</span>
  </div>

 @if (Activities != null && Activities.Any())
        {
            <div class="d-flex flex-column gap-3">
    @foreach (var (activity, index) in Activities.OrderBy(a => a.Order).Select((a, i) => (a, i)))
   {
   <div class="card @(activity.Status == ActivityStatus.Open ? "border-success" : "") shadow-sm">
   <div class="card-body">
    <div class="d-flex justify-content-between align-items-start mb-2">
    <div class="d-flex align-items-center gap-2">
        <span class="badge bg-light text-dark">#@activity.Order</span>
             <strong class="fw-semibold">@activity.Type</strong>
  </div>
   @if (activity.Status == ActivityStatus.Open)
      {
      <span class="badge bg-success">
   <span class="pulse-dot me-1"></span>Live
        </span>
     }
        else if (activity.Status == ActivityStatus.Closed)
    {
  <span class="badge bg-secondary">Completed</span>
  }
      else
    {
    <span class="badge bg-light text-dark">Pending</span>
   }
    </div>
     <h6 class="mb-2">@activity.Title</h6>
          @if (!string.IsNullOrEmpty(activity.Prompt))
        {
      <p class="small text-muted mb-3">@activity.Prompt</p>
  }

    <!-- Activity Actions -->
     <div class="d-flex gap-2 align-items-center">
   @if (activity.Status == ActivityStatus.Pending)
     {
         <button class="btn btn-sm btn-outline-secondary"
     @onclick="@(() => OnEditActivity.InvokeAsync(activity))">
    <i class="fas fa-edit me-1"></i>Edit
     </button>
    <!-- Only show Open if no other activity is open -->
 @if (CurrentActivity == null)
        {
 <button class="btn btn-sm btn-success"
       @onclick="@(() => OnOpenActivity.InvokeAsync(activity.ActivityId))"
 disabled="@IsPerformingAction">
  <i class="fas fa-play me-1"></i>
         @(IsPerformingAction ? "Opening..." : "Start Activity")
     </button>
   }
    else
    {
       <span class="text-muted small">
       <i class="fas fa-lock me-1"></i>Close current activity first
            </span>
     }
    }
   else if (activity.Status == ActivityStatus.Open)
       {
    <!-- Current activity controls shown in top section -->
   <span class="text-success small">
<i class="fas fa-play-circle me-1"></i>Currently active
  </span>
     }
       else
       {
       <!-- Closed activity -->
      <button class="btn btn-sm btn-outline-primary"
 @onclick="@(() => OnReopenActivity.InvokeAsync(activity.ActivityId))"
   disabled="@IsPerformingAction">
        <i class="fas fa-redo me-1"></i>
@(IsPerformingAction ? "Reopening..." : "Reopen")
  </button>
 <a href="/facilitator/dashboards" class="btn btn-sm btn-outline-secondary">
<i class="fas fa-chart-bar me-1"></i>Results
  </a>
     }
        </div>
   </div>
       </div>
   }
 </div>
        }
  else
  {
  <div class="text-center py-5">
     <div class="mb-3">
  <i class="fas fa-clipboard-list fa-3x text-muted"></i>
  </div>
     <p class="text-muted mb-0">No activities yet. Create your first activity to get started.</p>
   </div>
  }
    </div>

    <!-- Add Activity Buttons -->
    <div class="border-top pt-4 mt-4 pb-3">
        <div class="text-center mb-4">
            <h6 class="text-muted mb-0">Add New Activity</h6>
        </div>
        <div class="d-flex flex-wrap gap-3 justify-content-center px-3">
            <button type="button" class="btn btn-outline-primary btn-sm px-3 py-2" data-bs-toggle="modal" data-bs-target="#pollModal" @onclick='() => OnAddActivity.InvokeAsync("Poll")'>
                <span class="me-1">üìä</span>Poll
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm px-3 py-2" data-bs-toggle="modal" data-bs-target="#wordcloudModal" @onclick='() => OnAddActivity.InvokeAsync("WordCloud")'>
                <span class="me-1">‚òÅÔ∏è</span>Word Cloud
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm px-3 py-2" data-bs-toggle="modal" data-bs-target="#quadrantModal" @onclick='() => OnAddActivity.InvokeAsync("Quadrant")'>
                <span class="me-1">üìà</span>Quadrant
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm px-3 py-2" data-bs-toggle="modal" data-bs-target="#fivewhysModal" @onclick='() => OnAddActivity.InvokeAsync("FiveWhys")'>
                <span class="me-1">üîç</span>5 Whys
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm px-3 py-2" data-bs-toggle="modal" data-bs-target="#ratingModal" @onclick='() => OnAddActivity.InvokeAsync("Rating")'>
                <span class="me-1">‚≠ê</span>Rating
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm px-3 py-2" data-bs-toggle="modal" data-bs-target="#feedbackModal" @onclick='() => OnAddActivity.InvokeAsync("Feedback")'>
                <span class="me-1">üí¨</span>Feedback
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public List<AgendaActivityResponse> Activities { get; set; } = new();

    [Parameter]
    public AgendaActivityResponse? CurrentActivity { get; set; }

    [Parameter, EditorRequired]
    public string SessionCode { get; set; } = default!;

    [Parameter]
  public bool IsPerformingAction { get; set; }

    [Parameter]
    public EventCallback<AgendaActivityResponse> OnEditActivity { get; set; }

    [Parameter]
 public EventCallback<Guid> OnOpenActivity { get; set; }

    [Parameter]
    public EventCallback<Guid> OnReopenActivity { get; set; }

    [Parameter]
    public EventCallback<string> OnAddActivity { get; set; }
}
