@using System.Text.Json

<div class="quadrant-activity">
    @if (Parameters.HasSubmitted && Parameters.SubmitSuccess)
    {
        <!-- Success confirmation -->
        <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
            <div class="me-3 fs-4">✓</div>
            <div>
                <strong>Response submitted successfully!</strong>
                <div class="small">Your feedback has been placed on the quadrant.</div>
            </div>
        </div>
    }
    else
    {
        <div class="mb-4">
            <!-- Feedback Text Input (Required) -->
            <div class="mb-4">
                <label class="form-label fw-semibold">Your Feedback <span class="text-danger">*</span></label>
                <input type="text" class="form-control" 
                       value="@labelText" 
                       @oninput="OnLabelChanged"
                       placeholder="Enter your feedback or idea..."
                       maxlength="@maxLabelLength"
                       disabled="@Parameters.HasSubmitted"
                       required />
                @if (showValidationError && string.IsNullOrWhiteSpace(labelText))
                {
                    <div class="text-danger small mt-1">Feedback is required</div>
                }
            </div>
            
            <p class="text-muted small mb-3">Rate your feedback from 1 to @scale on each dimension</p>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">@xAxisLabel</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range" 
                               min="1" max="@scale" step="1"
                               value="@xScore" 
                               @oninput="OnXChanged"
                               disabled="@Parameters.HasSubmitted" />
                        <span class="badge bg-primary fs-5" style="min-width: 50px;">@xScore</span>
                    </div>
                    <div class="d-flex justify-content-between text-muted small mt-1">
                        <span>Low</span>
                        <span>High</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">@yAxisLabel</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range" 
                               min="1" max="@scale" step="1"
                               value="@yScore" 
                               @oninput="OnYChanged"
                               disabled="@Parameters.HasSubmitted" />
                        <span class="badge bg-primary fs-5" style="min-width: 50px;">@yScore</span>
                    </div>
                    <div class="d-flex justify-content-between text-muted small mt-1">
                        <span>Low</span>
                        <span>High</span>
                    </div>
                </div>
            </div>
            
            <!-- Quadrant preview -->
            <div class="mt-3 p-3 bg-light border rounded">
                <div class="small text-muted mb-2">Your point will be placed in:</div>
                <div class="fw-semibold text-primary">@GetQuadrantLabel()</div>
            </div>
        </div>
    }
    
    <button class="@(Parameters.HasSubmitted && Parameters.SubmitSuccess ? "btn-success" : "btn-primary") btn-lg w-100 py-3" 
            tabindex="1"
            @onclick="HandleSubmit" 
            disabled="@(Parameters.IsSubmitting || Parameters.HasSubmitted)">
        @if (Parameters.HasSubmitted && Parameters.SubmitSuccess)
        {
            <text>✓ Response Submitted</text>
        }
        else
        {
            <text>@GetSubmitButtonText()</text>
        }
    </button>
    
    @if (!string.IsNullOrEmpty(Parameters.SubmitMessage) && !Parameters.SubmitSuccess)
    {
        <div class="alert alert-danger mt-3 mb-0">
            @Parameters.SubmitMessage
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public required ParticipantActivityParameters Parameters { get; set; }

    private int scale = 10;
    private int xScore = 5;
    private int yScore = 5;
    private string? labelText;
    private bool showValidationError = false;
    private int maxLabelLength = 100;
    
    private string xAxisLabel = "X Axis";
    private string yAxisLabel = "Y Axis";
    private string topLeftLabel = "Top Left";
    private string topRightLabel = "Top Right";
    private string bottomLeftLabel = "Bottom Left";
    private string bottomRightLabel = "Bottom Right";

    protected override void OnParametersSet()
    {
        // Parse config from activity
        if (!string.IsNullOrEmpty(Parameters.Config))
        {
            try
            {
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var config = JsonSerializer.Deserialize<QuadrantConfigDto>(Parameters.Config, options);
                
                if (config != null)
                {
                    xAxisLabel = config.XAxisLabel ?? "X Axis";
                    yAxisLabel = config.YAxisLabel ?? "Y Axis";
                    topLeftLabel = config.TopLeftLabel ?? "Top Left";
                    topRightLabel = config.TopRightLabel ?? "Top Right";
                    bottomLeftLabel = config.BottomLeftLabel ?? "Bottom Left";
                    bottomRightLabel = config.BottomRightLabel ?? "Bottom Right";
                    scale = config.Scale ?? 10;
                    maxLabelLength = config.MaxLabelLength ?? 100;
                    
                    // Set initial values to middle of scale
                    xScore = (scale + 1) / 2;
                    yScore = (scale + 1) / 2;
                }
            }
            catch
            {
                // Use defaults if parsing fails
            }
        }
    }

    private void OnXChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var value))
        {
            xScore = value;
            StateHasChanged();
        }
    }

    private void OnYChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var value))
        {
            yScore = value;
            StateHasChanged();
        }
    }

    private void OnLabelChanged(ChangeEventArgs e)
    {
        labelText = e.Value?.ToString();
        StateHasChanged();
    }

    private string GetQuadrantLabel()
    {
        var midpoint = (scale + 1) / 2.0;
        var isHighX = xScore >= midpoint;
        var isHighY = yScore >= midpoint;
        
        if (isHighY && !isHighX) return topLeftLabel;
        if (isHighY && isHighX) return topRightLabel;
        if (!isHighY && !isHighX) return bottomLeftLabel;
        return bottomRightLabel;
    }

    private async Task HandleSubmit()
    {
        // Validate required feedback text
        if (string.IsNullOrWhiteSpace(labelText))
        {
            showValidationError = true;
            StateHasChanged();
            return;
        }
        
        showValidationError = false;
        
        // Convert scores to 0-100 position coordinates
        var xPosition = (xScore / (double)scale) * 100;
        var yPosition = (yScore / (double)scale) * 100;
        
        var payload = new 
        { 
            x = xPosition,
            y = yPosition,
            label = labelText.Trim()
        };
        
        await Parameters.OnSubmit(JsonSerializer.Serialize(payload));
    }

    private string GetSubmitButtonText()
    {
        if (Parameters.HasSubmitted)
            return "Response Submitted ✓";
        if (Parameters.IsSubmitting)
            return "Submitting...";
        return "Submit Response";
    }

    private class QuadrantConfigDto
    {
        public string? XAxisLabel { get; set; }
        public string? YAxisLabel { get; set; }
        public string? TopLeftLabel { get; set; }
        public string? TopRightLabel { get; set; }
        public string? BottomLeftLabel { get; set; }
        public string? BottomRightLabel { get; set; }
        public int? Scale { get; set; }
        public bool? AllowLabels { get; set; }
        public int? MaxLabelLength { get; set; }
    }
}
