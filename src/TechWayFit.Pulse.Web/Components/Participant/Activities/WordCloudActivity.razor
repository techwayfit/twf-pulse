@using TechWayFit.Pulse.Domain.Models.ActivityConfigs
@using System.Text.Json
@using System.Diagnostics

<div class="wordcloud-activity">
    @if (Parameters.HasSubmitted && Parameters.SubmitSuccess)
    {
    <!-- Success confirmation overlay -->
    <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
      <i class="fas fa-check-circle me-3 fs-4" aria-hidden="true"></i>
    <div>
   <strong>Response submitted successfully!</strong>
           <div class="small">Your input has been recorded. Waiting for the next activity...</div>
          </div>
        </div>
    }
    else
    {
 <div class="mb-4">
      <h3 class="h5 fw-semibold text-secondary mb-3">Share your thoughts:</h3>
    <label class="form-label fw-semibold">Your words</label>
       <textarea class="form-control form-control-lg textarea-resizable" 
        value="@inputText" 
         @oninput="OnTextChanged"
     rows="4"
  placeholder="@(config?.Placeholder ?? "Enter your words here...")"
       maxlength="@(config?.MaxWordLength * config?.MaxWords ?? 150)"
           disabled="@Parameters.HasSubmitted"></textarea>
  <div class="form-text d-flex justify-content-between">
             <span>
               @((inputText?.Length ?? 0)) / @(config?.MaxWordLength * config?.MaxWords ?? 150) characters
      </span>
        @if (config != null)
        {
         <span>Max @config.MaxWords words</span>
     }
 </div>
   </div>
        @if (config != null && !IsInputValid() && !string.IsNullOrWhiteSpace(inputText))
      {
<div class="alert alert-warning mb-3">
           @GetValidationMessage()
         </div>
        }
    }
    
    <button class="@(Parameters.HasSubmitted && Parameters.SubmitSuccess ? "btn-success" : "btn-primary") btn-lg w-100 py-3" 
        tabindex="1"
        @onclick="HandleSubmit" 
 disabled="@(Parameters.IsSubmitting || string.IsNullOrWhiteSpace(inputText) || Parameters.HasSubmitted || !IsInputValid())">
        @if (Parameters.HasSubmitted && Parameters.SubmitSuccess)
        {
      <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
      <text>Response Submitted</text>
        }
        else
    {
     <text>@GetSubmitButtonText()</text>
        }
    </button>

    @if (!string.IsNullOrEmpty(Parameters.SubmitMessage) && !Parameters.SubmitSuccess)
    {
     <div class="alert alert-danger mt-3 mb-0">
     @Parameters.SubmitMessage
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
 public required ParticipantActivityParameters Parameters { get; set; }

    private WordCloudConfig? config;
    private string? inputText;

    protected override void OnParametersSet()
    {
    if (!string.IsNullOrEmpty(Parameters.Config))
        {
            try
    {
   var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
         config = JsonSerializer.Deserialize<WordCloudConfig>(Parameters.Config, options);
  Debug.WriteLine($"Word cloud config parsed. Max words: {config?.MaxWords ?? 0}");
 }
  catch (JsonException ex)
            {
    Debug.WriteLine($"Failed to parse word cloud config: {ex.Message}");
    }
        }
    }

    private void OnTextChanged(ChangeEventArgs e)
    {
        inputText = e.Value?.ToString();
        StateHasChanged();
    }

    private bool IsInputValid()
    {
     if (string.IsNullOrWhiteSpace(inputText))
 return false;
        
 if (config == null) 
          return true;

        var words = inputText.Trim().Split(new[] { ' ', '\t', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);

        if (words.Length > config.MaxWords)
            return false;
    
        foreach (var word in words)
        {
            if (word.Length < config.MinWordLength || word.Length > config.MaxWordLength)
  return false;
        }

      return true;
    }

    private string GetValidationMessage()
 {
        if (string.IsNullOrWhiteSpace(inputText) || config == null) 
      return "";

      var words = inputText.Trim().Split(new[] { ' ', '\t', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);
        
        if (words.Length > config.MaxWords)
  return $"Too many words. Maximum allowed: {config.MaxWords}, you have: {words.Length}";
            
        foreach (var word in words)
        {
            if (word.Length < config.MinWordLength)
         return $"Word '{word}' is too short. Minimum length: {config.MinWordLength} characters";
   if (word.Length > config.MaxWordLength)
        return $"Word '{word}' is too long. Maximum length: {config.MaxWordLength} characters";
        }

        return "";
    }

    private async Task HandleSubmit()
    {
  if (string.IsNullOrWhiteSpace(inputText)) return;

        var payload = new { text = inputText.Trim() };
   await Parameters.OnSubmit(JsonSerializer.Serialize(payload));
    }

    private string GetSubmitButtonText()
    {
        if (Parameters.HasSubmitted)
        return "Response Submitted";
        if (Parameters.IsSubmitting)
    return "Submitting...";
  return "Submit Response";
    }
}
