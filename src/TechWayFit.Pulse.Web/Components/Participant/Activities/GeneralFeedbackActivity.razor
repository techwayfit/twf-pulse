@using TechWayFit.Pulse.Domain.Models.ActivityConfigs
@using System.Text.Json
@using System.Diagnostics

<div class="feedback-activity">
    @if (Parameters.HasSubmitted && Parameters.SubmitSuccess)
    {
        <!-- Success confirmation -->
    <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
            <div class="me-3"><i class="ics ics-check-mark ic-lg"></i></div>
   <div>
           <strong>Feedback submitted successfully!</strong>
         <div class="small">Thank you for your input. Waiting for the next activity...</div>
 </div>
        </div>
    }
 else
    {
     <div class="mb-4">
            <h3 class="h5 fw-semibold text-secondary mb-3">Share your feedback:</h3>
  
            @if (config?.CategoriesEnabled == true && config.Categories != null)
            {
           <div class="mb-4">
       <label class="form-label fw-semibold">
  Category 
        @if (config.RequireCategory)
   {
   <span class='text-danger'>*</span>
       }
         else
          {
    <span class='text-muted'>(optional)</span>
      }
      </label>
   <div class="btn-group w-100" role="group">
        @foreach (var category in config.Categories)
     {
    var catId = category.Id;
   <button type="button" 
     class="btn btn-outline-secondary @(selectedCategory == catId ? "active" : "") px-3 py-2"
          disabled="@Parameters.HasSubmitted"
       @onclick="() => selectedCategory = catId">
          @if (!string.IsNullOrEmpty(category.Icon))
     {
          <span class="me-1">@category.Icon</span>
 }
       @category.Label
</button>
         }
       </div>
     </div>
}
            
     <div class="mb-4">
    <label class="form-label fw-semibold">Your feedback</label>
      <textarea class="form-control form-control-lg" 
   value="@feedbackText" 
          @oninput="OnTextChanged"
          rows="6"
            style="resize: vertical; min-height: 120px;"
       placeholder="@(config?.Placeholder ?? "Share your thoughts, problems, or suggestions...")"
       maxlength="@(config?.MaxLength ?? 1000)"
          disabled="@Parameters.HasSubmitted"></textarea>
                @if (config?.ShowCharacterCount == true)
             {
          <div class="form-text">
       @((feedbackText?.Length ?? 0)) / @(config?.MaxLength ?? 1000) characters
         </div>
      }
            </div>
        </div>
    }
    
    <button class="@(Parameters.HasSubmitted && Parameters.SubmitSuccess ? "btn-success" : "btn-primary") btn-lg w-100 py-3" 
       tabindex="1"
       @onclick="HandleSubmit" 
      disabled="@(Parameters.IsSubmitting || IsInputInvalid() || Parameters.HasSubmitted)">
        @if (Parameters.HasSubmitted && Parameters.SubmitSuccess)
   {
  <text>Feedback Submitted</text>
    }
    else
   {
     <text>@GetSubmitButtonText()</text>
    }
    </button>
    
    @if (!string.IsNullOrEmpty(Parameters.SubmitMessage) && !Parameters.SubmitSuccess)
    {
        <div class="alert alert-danger mt-3 mb-0">
@Parameters.SubmitMessage
 </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public required ParticipantActivityParameters Parameters { get; set; }

    private GeneralFeedbackConfig? config;
    private string? feedbackText;
    private string? selectedCategory;

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(Parameters.Config))
        {
      try
            {
         var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
  config = JsonSerializer.Deserialize<GeneralFeedbackConfig>(Parameters.Config, options);
     Debug.WriteLine($"Feedback config parsed. MaxLength: {config?.MaxLength}");
            }
       catch (JsonException ex)
 {
     Debug.WriteLine($"Failed to parse feedback config: {ex.Message}");
       }
        }
    }

    private void OnTextChanged(ChangeEventArgs e)
    {
 feedbackText = e.Value?.ToString();
        StateHasChanged();
    }

 private bool IsInputInvalid()
    {
    if (string.IsNullOrWhiteSpace(feedbackText)) 
    return true;

        var minLength = config?.MinLength ?? 10;
        if (feedbackText.Length < minLength) 
            return true;
      
        if (config?.RequireCategory == true && string.IsNullOrEmpty(selectedCategory))
            return true;
   
        return false;
    }

    private async Task HandleSubmit()
    {
  if (IsInputInvalid()) return;

        var payload = new
     {
            content = feedbackText!.Trim(),
       category = selectedCategory,
       isAnonymous = false,
        characterCount = feedbackText.Length
        };

        await Parameters.OnSubmit(JsonSerializer.Serialize(payload));
    }

    private string GetSubmitButtonText()
    {
        if (Parameters.HasSubmitted)
  return "Feedback Submitted ?";
        if (Parameters.IsSubmitting)
         return "Submitting...";
        return "Submit Feedback";
    }
}
