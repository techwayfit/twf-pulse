@using TechWayFit.Pulse.Domain.Models.ActivityConfigs
@using System.Text.Json
@using System.Diagnostics

<div class="poll-activity">
    @if (Parameters.HasSubmitted && Parameters.SubmitSuccess)
    {
        <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
            <i class="fas fa-check-circle me-3 fs-4" aria-hidden="true"></i>
            <div>
                <strong>Response submitted successfully!</strong>
                <div class="small">Your choice has been recorded. Waiting for the next activity...</div>
            </div>
        </div>
    }
    else
    {
    <div class="mb-4">
        <h3 class="h5 fw-semibold text-secondary mb-4">@(pollConfig?.AllowMultiple == true ? "Select one or more:" : "Make your choice:")</h3>

        @if (pollConfig != null && pollConfig.Options != null && pollConfig.Options.Count > 0)
        {
            <div class="poll-options mb-4">
                @foreach (var option in pollConfig.Options)
                {
                    var optionId = option.Id;
                    var isSelected = selectedOptionIds.Contains(optionId);
                    <div class="form-check poll-option mb-3 p-3 border rounded-3 position-relative
          @(isSelected ? "border-primary bg-primary bg-opacity-10 shadow-sm" : "border-2")
                 poll-option-interactive"
                         style="cursor: @(Parameters.HasSubmitted ? "not-allowed" : "pointer"); transition: all 0.2s ease-in-out;"
                         @onclick="@(async () => await HandleOptionClick(optionId))">
                        @if (pollConfig.AllowMultiple)
                        {
                            <input class="form-check-input position-absolute"
                                   type="checkbox"
                                   id="poll-@optionId"
                                   checked="@isSelected"
                                   style="top: 1rem; left: 1rem; width: 1.25rem; height: 1.25rem;"
                                   disabled="@Parameters.HasSubmitted"
                                   @onchange="@((e) => ToggleOption(optionId))" />
                        }
                        else
                        {
                            <input class="form-check-input position-absolute"
                                   type="radio"
                                   name="pollChoice"
                                   id="poll-@optionId"
                                   checked="@isSelected"
                                   style="top: 1rem; left: 1rem; width: 1.25rem; height: 1.25rem;"
                                   disabled="@Parameters.HasSubmitted"
                                   @onchange="@((e) => SelectOption(optionId))" />
                        }
                        <label class="form-check-label w-100 ps-4 ms-1" for="poll-@optionId" style="cursor: pointer;">
                            <strong class="d-block mb-1 fs-6">@option.Label</strong>
                            @if (!string.IsNullOrEmpty(option.Description))
                            {
                                <small class="text-muted d-block">@option.Description</small>
                            }
                        </label>
                    </div>
                }

                @if (pollConfig.AllowCustomOption)
                {
                    var isCustomSelected = selectedOptionIds.Contains("custom");
                    <div class="form-check poll-option mb-3 p-3 border rounded-3 position-relative
           @(isCustomSelected ? "border-primary bg-primary bg-opacity-10 shadow-sm" : "border-2")
                    poll-option-interactive"
                        style="cursor: @(Parameters.HasSubmitted ? "not-allowed" : "pointer"); transition: all 0.2s ease-in-out;"
                         @onclick="@(async () => await HandleOptionClick("custom"))">
                        @if (pollConfig.AllowMultiple)
                        {
                            <input class="form-check-input position-absolute"
                                   type="checkbox"
                                   id="poll-custom"
                                   checked="@isCustomSelected"
                                   style="top: 1rem; left: 1rem; width: 1.25rem; height: 1.25rem;"
                                   disabled="@Parameters.HasSubmitted"
                                   @onchange="@((e) => ToggleOption("custom"))" />
                        }
                        else
                        {
                            <input class="form-check-input position-absolute"
                                   type="radio"
                                   name="pollChoice"
                                   id="poll-custom"
                                   checked="@isCustomSelected"
                                   style="top: 1rem; left: 1rem; width: 1.25rem; height: 1.25rem;"
                                   disabled="@Parameters.HasSubmitted"
                                   @onchange="@((e) => SelectOption("custom"))" />
                        }
                        <label class="form-check-label w-100 ps-4 ms-1" for="poll-custom" style="cursor: pointer;">
                            <strong class="d-block mb-2 fs-6">Other</strong>
                            @if (isCustomSelected)
                            {
                                <input type="text"
                                       class="form-control"
                                       placeholder="@pollConfig.CustomOptionPlaceholder"
                                       @bind="customText"
                                       @onclick:stopPropagation="true"
                                       disabled="@Parameters.HasSubmitted"
                                       maxlength="100" />
                            }
                        </label>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-warning">
                <span>No poll options configured.</span>
            </div>
        }
    </div>
    }

    <button class="@(Parameters.HasSubmitted ? "btn-secondary" : "btn-primary") btn-lg w-100 py-3" tabindex="1"
            @onclick="HandleSubmit"
            disabled="@(Parameters.IsSubmitting || selectedOptionIds.Count == 0 || Parameters.HasSubmitted)">
        @if (Parameters.HasSubmitted)
        {
            <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
            <text>Response already submitted</text>
        }
        else
        {
            <text>@GetSubmitButtonText()</text>
        }
    </button>

    @if (!string.IsNullOrEmpty(Parameters.SubmitMessage) && !Parameters.SubmitSuccess)
    {
        <div class="alert @(Parameters.SubmitSuccess ? "alert-success" : "alert-danger") mt-3 mb-0">
            @Parameters.SubmitMessage
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public required ParticipantActivityParameters Parameters { get; set; }

    private PollConfig? pollConfig;
    private List<string> selectedOptionIds = new();
    private string? customText;

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(Parameters.Config))
        {
            try
            {
                pollConfig = ParsePollConfig(Parameters.Config);
            }
            catch (JsonException ex)
            {
                Debug.WriteLine($"Failed to parse poll config: {ex.Message}");
                Debug.WriteLine($"Config JSON: {Parameters.Config}");
            }
        }
    }

    private PollConfig? ParsePollConfig(string configJson)
    {
        using var document = JsonDocument.Parse(configJson);
        var root = document.RootElement;

        var options = new List<PollOption>();
        
        // Parse options - handle both string array (legacy/AI) and object array (standard) formats
        if (root.TryGetProperty("options", out var optionsElement) && optionsElement.ValueKind == JsonValueKind.Array)
        {
            var index = 0;
            foreach (var optionElement in optionsElement.EnumerateArray())
            {
                if (optionElement.ValueKind == JsonValueKind.String)
                {
                    // Legacy format: array of strings
                    var label = optionElement.GetString();
                    if (!string.IsNullOrEmpty(label))
                    {
                        options.Add(new PollOption($"option_{index}", label));
                    }
                }
                else if (optionElement.ValueKind == JsonValueKind.Object)
                {
                    // Standard format: {id, label, description?}
                    var id = optionElement.TryGetProperty("id", out var idElement) 
                        ? idElement.GetString() ?? $"option_{index}" 
                        : $"option_{index}";
                    var label = optionElement.TryGetProperty("label", out var labelElement) 
                        ? labelElement.GetString() ?? "" 
                        : "";
                    var description = optionElement.TryGetProperty("description", out var descElement) 
                        ? descElement.GetString() 
                        : null;

                    if (!string.IsNullOrEmpty(label))
                    {
                        options.Add(new PollOption(id, label, description));
                    }
                }
                index++;
            }
        }

        // Parse other properties with defaults
        var allowMultiple = root.TryGetProperty("allowMultiple", out var allowMultipleElement) 
            && allowMultipleElement.GetBoolean();
        var allowCustomOption = root.TryGetProperty("allowCustomOption", out var allowCustomElement) 
            && allowCustomElement.GetBoolean();
        var customPlaceholder = root.TryGetProperty("customOptionPlaceholder", out var placeholderElement) 
            ? placeholderElement.GetString() 
            : "Other (please specify)";
        var minSelections = root.TryGetProperty("minSelections", out var minElement) 
            ? minElement.GetInt32() 
            : 1;
        var maxSelections = root.TryGetProperty("maxSelections", out var maxElement) 
            ? (int?)maxElement.GetInt32() 
            : null;

        return new PollConfig(
            options,
            allowMultiple,
            minSelections,
            maxSelections,
            allowCustomOption,
            customPlaceholder);
    }

    private void SelectOption(string optionId)
    {
        if (Parameters.HasSubmitted) return;

        selectedOptionIds.Clear();
        selectedOptionIds.Add(optionId);
    }

    private void ToggleOption(string optionId)
    {
        if (Parameters.HasSubmitted) return;

        if (selectedOptionIds.Contains(optionId))
        {
            selectedOptionIds.Remove(optionId);
        }
        else
        {
            selectedOptionIds.Add(optionId);
        }
    }

    private async Task HandleOptionClick(string optionId)
    {
        if (Parameters.HasSubmitted)
        {
            return;
        }

        if (pollConfig?.AllowMultiple == true)
        {
            ToggleOption(optionId);
        }
        else
        {
            SelectOption(optionId);
        }
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleSubmit()
    {
        if (Parameters.HasSubmitted)
        {
            return;
        }

        var payload = new
        {
            selectedOptionIds = selectedOptionIds,
            customOptionText = selectedOptionIds.Contains("custom") ? customText : null
        };

        await Parameters.OnSubmit(JsonSerializer.Serialize(payload));
    }

    private string GetSubmitButtonText()
    {
        if (Parameters.HasSubmitted)
            return "Response already submitted";
        if (Parameters.IsSubmitting)
            return "Submitting...";
        return "Submit Response";
    }
}
