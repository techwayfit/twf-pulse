@{
    Layout = null;
}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facilitator Console</title>
  <link rel="stylesheet" href="/css/pulse-ui.css" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-mark"></div>
        <div>
          <h1>Facilitator Console</h1>
          <p>Moderate the session and move through activities.</p>
        </div>
      </div>
      <div class="nav-btns">
        <a class="btn secondary" href="/ui">All flows</a>
        <a class="btn secondary" href="/ui/create">Create session</a>
        <a class="btn secondary" href="/ui/participant">Participant</a>
      </div>
    </div>
  </header>

  <main class="shell">
    <section class="hero">
      <h2>Control the live workshop.</h2>
      <p>Load the session, start it, add questions, and open/close activities.</p>
      <div class="actions">
        <a class="btn secondary" href="/ui/create">Create session</a>
        <a class="btn secondary" href="/ui/participant">Participant view</a>
      </div>
    </section>

    <section class="panel" style="--delay: 0.05s;">
      <h3>Facilitator controls</h3>
      <p>Load the session and manage its lifecycle.</p>
      <div class="panel-grid">
        <div class="card">
          <h4>Facilitator access</h4>
          <form class="form" id="facilitatorForm">
            <div>
              <label for="facilitatorCode">Session code</label>
              <input class="field" id="facilitatorCode" name="facilitatorCode" placeholder="TW-2024" required />
            </div>
            <div class="row two">
              <button class="btn primary" type="submit">Load session</button>
              <button class="btn secondary" type="button" id="startSession">Start session</button>
            </div>
            <div>
              <button class="btn secondary" type="button" id="endSession">End session</button>
            </div>
          </form>
          <div class="status" id="facilitatorStatus" data-kind="info">Waiting for facilitator to load a session.</div>
        </div>

        <div class="card">
          <h4>Session overview</h4>
          <div class="summary">
            <div><strong>Session ID</strong><br /><span id="facilitatorSummaryId">Not loaded</span></div>
            <div><strong>Code</strong><br /><span id="facilitatorSummaryCode">Not loaded</span></div>
            <div><strong>Status</strong><br /><span id="facilitatorSummaryStatus">Not loaded</span></div>
            <div><strong>Current activity</strong><br /><span id="facilitatorSummaryActivity">Not set</span></div>
            <div><strong>Expires</strong><br /><span id="facilitatorSummaryExpires">Not loaded</span></div>
          </div>
        </div>
      </div>

      <div class="panel-grid">
        <div class="card">
          <h4>Activity builder</h4>
          <form class="form" id="activityForm">
            <div>
              <label for="activitySessionCode">Session code</label>
              <input class="field" id="activitySessionCode" name="activitySessionCode" placeholder="TW-2024" required />
            </div>
            <div class="row two">
              <div>
                <label for="activityOrder">Order</label>
                <input class="field" id="activityOrder" name="activityOrder" type="number" min="1" value="1" />
              </div>
              <div>
                <label for="activityType">Type</label>
                <select class="field" id="activityType" name="activityType">
                  <option>Poll</option>
                  <option>Quiz</option>
                  <option>WordCloud</option>
                  <option>QnA</option>
                  <option>Rating</option>
                  <option>Quadrant</option>
                  <option>FiveWhys</option>
                  <option>GeneralFeedback</option>
                </select>
              </div>
            </div>
            <div>
              <label for="activityTitle">Title</label>
              <input class="field" id="activityTitle" name="activityTitle" placeholder="How do you feel?" required />
            </div>
            <div>
              <label for="activityPrompt">Prompt (optional)</label>
              <input class="field" id="activityPrompt" name="activityPrompt" placeholder="Share one word" />
            </div>
            <div>
              <label for="activityConfig">Config (optional JSON)</label>
              <input class="field" id="activityConfig" name="activityConfig" placeholder="{&quot;scale&quot;:5}" />
            </div>
            <div>
              <button class="btn primary" type="submit">Add activity</button>
            </div>
          </form>
          <div class="status" id="activityStatus" data-kind="info">Add the first activity.</div>
        </div>

        <div class="card">
          <h4>Agenda + controls</h4>
          <ul class="list actions" id="activityList">
            <li><span>No activities yet</span><span>--</span></li>
          </ul>
          <div class="status" id="activityActionStatus" data-kind="info">Open or close activities to move through questions.</div>
        </div>
      </div>

      <div class="panel-grid">
        <div class="card">
          <h4>Dashboard snapshot</h4>
          <form class="form" id="dashboardForm">
            <div class="row two">
              <div>
                <label for="dashCode">Session code</label>
                <input class="field" id="dashCode" name="dashCode" placeholder="TW-2024" required />
              </div>
              <div>
                <label for="activityId">Activity ID (optional)</label>
                <input class="field" id="activityId" name="activityId" placeholder="Guid" />
              </div>
            </div>
            <div class="row two">
              <div>
                <label for="filterDepartment">Filter: Department</label>
                <input class="field" id="filterDepartment" name="filterDepartment" placeholder="Engineering" />
              </div>
              <div>
                <label for="filterRole">Filter: Role</label>
                <input class="field" id="filterRole" name="filterRole" placeholder="Lead" />
              </div>
            </div>
            <div>
              <button class="btn primary" type="submit">Fetch dashboard</button>
            </div>
          </form>
          <div class="status" id="dashStatus" data-kind="info">Waiting to fetch dashboard.</div>
        </div>

        <div class="card">
          <h4>Metrics</h4>
          <div class="metric-grid">
            <div class="metric">
              <strong id="metricResponses">0</strong>
              <span>Total responses</span>
            </div>
            <div class="metric">
              <strong id="metricParticipants">0</strong>
              <span>Participants</span>
            </div>
            <div class="metric">
              <strong id="metricResponded">0</strong>
              <span>Responded</span>
            </div>
          </div>
          <h4 style="margin-top: 16px;">Top words</h4>
          <ul class="list" id="wordCloudList">
            <li><span>No data yet</span><span>0</span></li>
          </ul>
          <h4 style="margin-top: 16px;">Quadrant points</h4>
          <div class="summary">
            <div><strong>Total points</strong><br /><span id="quadrantCount">0</span></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="/js/signalr.min.js"></script>
  <script>
    const facilitatorForm = document.getElementById("facilitatorForm");
    const activityForm = document.getElementById("activityForm");
    const dashboardForm = document.getElementById("dashboardForm");

    const facilitatorCode = document.getElementById("facilitatorCode");
    const activitySessionCode = document.getElementById("activitySessionCode");
    const dashCode = document.getElementById("dashCode");

    const facilitatorSummaryId = document.getElementById("facilitatorSummaryId");
    const facilitatorSummaryCode = document.getElementById("facilitatorSummaryCode");
    const facilitatorSummaryStatus = document.getElementById("facilitatorSummaryStatus");
    const facilitatorSummaryActivity = document.getElementById("facilitatorSummaryActivity");
    const facilitatorSummaryExpires = document.getElementById("facilitatorSummaryExpires");

    const activityOrder = document.getElementById("activityOrder");
    const activityType = document.getElementById("activityType");
    const activityTitle = document.getElementById("activityTitle");
    const activityPrompt = document.getElementById("activityPrompt");
    const activityConfig = document.getElementById("activityConfig");
    const activityList = document.getElementById("activityList");

    const startSession = document.getElementById("startSession");
    const endSession = document.getElementById("endSession");

    const dashboardActivityId = document.getElementById("activityId");
    const metricResponses = document.getElementById("metricResponses");
    const metricParticipants = document.getElementById("metricParticipants");
    const metricResponded = document.getElementById("metricResponded");
    const wordCloudList = document.getElementById("wordCloudList");
    const quadrantCount = document.getElementById("quadrantCount");

    const activityState = [];
    let facilitatorToken = "";
    let connection = null;

    function setStatus(id, message, kind) {
      const el = document.getElementById(id);
      el.textContent = message;
      el.dataset.kind = kind;
    }

    function withAuthHeaders(headers = {}) {
      if (facilitatorToken) {
        return { ...headers, "X-Facilitator-Token": facilitatorToken };
      }
      return headers;
    }

    async function parseJson(response) {
      const payload = await response.json();
      if (!response.ok || (payload.errors && payload.errors.length)) {
        const message = payload.errors && payload.errors.length
          ? payload.errors.map((error) => error.message).join(" ")
          : "Request failed.";
        throw new Error(message);
      }
      return payload.data;
    }

    async function joinFacilitator(code) {
      const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/facilitators/join`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ displayName: null })
      });
      const data = await parseJson(response);
      facilitatorToken = data.token;
      return data;
    }

    async function connectSignalR(code) {
      if (!window.signalR) {
        return;
      }

      if (connection) {
        await connection.stop();
      }

      connection = new signalR.HubConnectionBuilder()
        .withUrl("/hubs/workshop")
        .withAutomaticReconnect()
        .build();

      connection.on("SessionStateChanged", (payload) => {
        if (!payload || payload.sessionCode !== code) {
          return;
        }
        facilitatorSummaryStatus.textContent = payload.status || "-";
        facilitatorSummaryActivity.textContent = payload.currentActivityId || "Not set";
      });

      connection.on("ActivityStateChanged", (payload) => {
        if (!payload || payload.sessionCode !== code) {
          return;
        }
        dashboardActivityId.value = payload.activityId || "";
        loadAgenda(code).catch(() => {});
      });

      connection.on("ParticipantJoined", (payload) => {
        if (!payload || payload.sessionCode !== code) {
          return;
        }
        setStatus("facilitatorStatus", `Participant joined (${payload.participantCount}).`, "info");
      });

      connection.on("ResponseReceived", (payload) => {
        if (!payload || payload.sessionCode !== code) {
          return;
        }
        fetchDashboard(code).catch(() => {});
      });

      connection.on("DashboardUpdated", (payload) => {
        if (!payload || payload.sessionCode !== code) {
          return;
        }
        fetchDashboard(code).catch(() => {});
      });

      await connection.start();
      await connection.invoke("Subscribe", code);
    }

    function renderActivityList() {
      activityList.innerHTML = "";
      if (!activityState.length) {
        activityList.innerHTML = "<li><span>No activities yet</span><span>--</span></li>";
        return;
      }

      const sorted = [...activityState].sort((a, b) => a.order - b.order);
      sorted.forEach((activity) => {
        const li = document.createElement("li");
        const info = document.createElement("div");
        const title = document.createElement("div");
        title.textContent = `${activity.order}. ${activity.title}`;
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${activity.type} • ${activity.status} • ${activity.activityId}`;
        info.appendChild(title);
        info.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "action-row";
        const upBtn = document.createElement("button");
        upBtn.type = "button";
        upBtn.className = "btn small";
        upBtn.textContent = "Up";
        upBtn.addEventListener("click", () => {
          moveActivity(activity.activityId, -1);
        });
        const downBtn = document.createElement("button");
        downBtn.type = "button";
        downBtn.className = "btn small";
        downBtn.textContent = "Down";
        downBtn.addEventListener("click", () => {
          moveActivity(activity.activityId, 1);
        });
        const openBtn = document.createElement("button");
        openBtn.type = "button";
        openBtn.className = "btn small";
        openBtn.textContent = "Open";
        openBtn.addEventListener("click", () => {
          openActivity(activity.activityId);
        });
        const closeBtn = document.createElement("button");
        closeBtn.type = "button";
        closeBtn.className = "btn small";
        closeBtn.textContent = "Close";
        closeBtn.addEventListener("click", () => {
          closeActivity(activity.activityId);
        });
        actions.appendChild(upBtn);
        actions.appendChild(downBtn);
        actions.appendChild(openBtn);
        actions.appendChild(closeBtn);

        li.appendChild(info);
        li.appendChild(actions);
        activityList.appendChild(li);
      });
    }

    function getActivitySessionCode() {
      return activitySessionCode.value.trim() || facilitatorCode.value.trim();
    }

    async function fetchSessionSummary(code) {
      const response = await fetch(`/api/sessions/${encodeURIComponent(code)}`);
      const data = await parseJson(response);
      updateFacilitatorSummary(data);
      return data;
    }

    async function loadAgenda(code) {
      const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/activities`);
      const data = await parseJson(response);
      activityState.length = 0;
      data.forEach((activity) => activityState.push(activity));
      renderActivityList();
    }

    function updateFacilitatorSummary(session) {
      facilitatorSummaryId.textContent = session.sessionId || "-";
      facilitatorSummaryCode.textContent = session.code || "-";
      facilitatorSummaryStatus.textContent = session.status || "-";
      facilitatorSummaryActivity.textContent = session.currentActivityId || "Not set";
      facilitatorSummaryExpires.textContent = session.expiresAt || "-";
    }

    async function reorderActivities() {
      const code = getActivitySessionCode();
      if (!code) {
        setStatus("activityActionStatus", "Enter a session code first.", "error");
        return;
      }

      const ordered = [...activityState].sort((a, b) => a.order - b.order);
      const activityIds = ordered.map((activity) => activity.activityId);

      try {
        const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/activities/reorder`, {
          method: "PUT",
          headers: withAuthHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({ activityIds })
        });
        const data = await parseJson(response);
        activityState.length = 0;
        data.forEach((activity) => activityState.push(activity));
        renderActivityList();
        setStatus("activityActionStatus", "Agenda reordered.", "success");
      } catch (error) {
        setStatus("activityActionStatus", error.message, "error");
      }
    }

    function moveActivity(activityId, direction) {
      const sorted = [...activityState].sort((a, b) => a.order - b.order);
      const index = sorted.findIndex((activity) => activity.activityId === activityId);
      const swapIndex = index + direction;
      if (index < 0 || swapIndex < 0 || swapIndex >= sorted.length) {
        return;
      }

      const currentOrder = sorted[index].order;
      sorted[index].order = sorted[swapIndex].order;
      sorted[swapIndex].order = currentOrder;
      activityState.length = 0;
      sorted.forEach((activity) => activityState.push(activity));
      renderActivityList();
      reorderActivities();
    }

    async function fetchDashboard(code) {
      if (!code) {
        return;
      }

      const activityId = dashboardActivityId.value.trim();
      const filterDepartment = document.getElementById("filterDepartment").value.trim();
      const filterRole = document.getElementById("filterRole").value.trim();

      const params = new URLSearchParams();
      if (activityId) {
        params.set("activityId", activityId);
      }
      if (filterDepartment) {
        params.set("filters[department]", filterDepartment);
      }
      if (filterRole) {
        params.set("filters[role]", filterRole);
      }

      const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/dashboards?${params.toString()}`);
      const data = await parseJson(response);
      metricResponses.textContent = data.totalResponses;
      metricParticipants.textContent = data.participantCount;
      metricResponded.textContent = data.respondedParticipants;

      wordCloudList.innerHTML = "";
      if (data.wordCloud && data.wordCloud.length) {
        data.wordCloud.slice(0, 6).forEach((item) => {
          const li = document.createElement("li");
          const left = document.createElement("span");
          left.textContent = item.text;
          const right = document.createElement("span");
          right.textContent = item.count;
          li.appendChild(left);
          li.appendChild(right);
          wordCloudList.appendChild(li);
        });
      } else {
        wordCloudList.innerHTML = "<li><span>No responses yet</span><span>0</span></li>";
      }

      quadrantCount.textContent = data.quadrantPoints ? data.quadrantPoints.length : 0;
    }

    async function openActivity(activityId) {
      const code = getActivitySessionCode();
      if (!code) {
        setStatus("activityActionStatus", "Enter a session code first.", "error");
        return;
      }
      setStatus("activityActionStatus", "Opening activity...", "info");

      try {
        const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/activities/${activityId}/open`, {
          method: "POST",
          headers: withAuthHeaders()
        });
        await parseJson(response);
        await fetchSessionSummary(code);
        await loadAgenda(code);
        dashboardActivityId.value = activityId;
        setStatus("activityActionStatus", "Activity opened.", "success");
      } catch (error) {
        setStatus("activityActionStatus", error.message, "error");
      }
    }

    async function closeActivity(activityId) {
      const code = getActivitySessionCode();
      if (!code) {
        setStatus("activityActionStatus", "Enter a session code first.", "error");
        return;
      }
      setStatus("activityActionStatus", "Closing activity...", "info");

      try {
        const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/activities/${activityId}/close`, {
          method: "POST",
          headers: withAuthHeaders()
        });
        await parseJson(response);
        await fetchSessionSummary(code);
        await loadAgenda(code);
        setStatus("activityActionStatus", "Activity closed.", "success");
      } catch (error) {
        setStatus("activityActionStatus", error.message, "error");
      }
    }

    facilitatorForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setStatus("facilitatorStatus", "Loading session...", "info");
      const code = facilitatorCode.value.trim();

      try {
        await joinFacilitator(code);
        await fetchSessionSummary(code);
        activitySessionCode.value = code;
        dashCode.value = code;
        await loadAgenda(code);
        await connectSignalR(code);
        setStatus("facilitatorStatus", "Session loaded.", "success");
      } catch (error) {
        setStatus("facilitatorStatus", error.message, "error");
      }
    });

    startSession.addEventListener("click", async () => {
      const code = facilitatorCode.value.trim();
      if (!code) {
        setStatus("facilitatorStatus", "Enter a session code first.", "error");
        return;
      }
      setStatus("facilitatorStatus", "Starting session...", "info");

      try {
        const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/start`, {
          method: "POST",
          headers: withAuthHeaders()
        });
        const data = await parseJson(response);
        updateFacilitatorSummary(data);
        setStatus("facilitatorStatus", "Session started.", "success");
      } catch (error) {
        setStatus("facilitatorStatus", error.message, "error");
      }
    });

    endSession.addEventListener("click", async () => {
      const code = facilitatorCode.value.trim();
      if (!code) {
        setStatus("facilitatorStatus", "Enter a session code first.", "error");
        return;
      }
      setStatus("facilitatorStatus", "Ending session...", "info");

      try {
        const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/end`, {
          method: "POST",
          headers: withAuthHeaders()
        });
        const data = await parseJson(response);
        updateFacilitatorSummary(data);
        setStatus("facilitatorStatus", "Session ended.", "success");
      } catch (error) {
        setStatus("facilitatorStatus", error.message, "error");
      }
    });

    activityForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setStatus("activityStatus", "Adding activity...", "info");

      const code = getActivitySessionCode();
      if (!code) {
        setStatus("activityStatus", "Enter a session code first.", "error");
        return;
      }

      const order = Number(activityOrder.value || 1);
      const title = activityTitle.value.trim();
      const payload = {
        order,
        type: activityType.value,
        title,
        prompt: activityPrompt.value.trim() || null,
        config: activityConfig.value.trim() || null
      };

      try {
        const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/activities`, {
          method: "POST",
          headers: withAuthHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify(payload)
        });
        await parseJson(response);
        await loadAgenda(code);
        activityOrder.value = order + 1;
        activityTitle.value = "";
        activityPrompt.value = "";
        activityConfig.value = "";
        setStatus("activityStatus", "Activity added.", "success");
      } catch (error) {
        setStatus("activityStatus", error.message, "error");
      }
    });

    dashboardForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setStatus("dashStatus", "Fetching dashboard...", "info");

      try {
        await fetchDashboard(dashCode.value.trim());
        setStatus("dashStatus", "Dashboard loaded.", "success");
      } catch (error) {
        setStatus("dashStatus", error.message, "error");
      }
    });
  </script>
</body>
</html>
