@{
    Layout = null;
}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Participant Join</title>
  <link rel="stylesheet" href="/css/pulse-ui.css" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-mark"></div>
        <div>
          <h1>Participant Flow</h1>
          <p>Join the session and submit responses.</p>
        </div>
      </div>
      <div class="nav-btns">
        <a class="btn secondary" href="/ui">All flows</a>
        <a class="btn secondary" href="/ui/create">Create session</a>
        <a class="btn secondary" href="/ui/facilitator">Facilitator</a>
      </div>
    </div>
  </header>

  <main class="shell">
    <section class="hero">
      <h2>Join fast, respond easily.</h2>
      <p>Enter your code, join the session, and answer the active question.</p>
      <div class="actions">
        <a class="btn secondary" href="/ui/facilitator">Facilitator console</a>
      </div>
    </section>

    <section class="panel" style="--delay: 0.05s;">
      <h3>Join the session</h3>
      <p>Participants join with a session code and optional details.</p>
      <div class="panel-grid">
        <div class="card">
          <h4>Join form</h4>
          <form class="form" id="participantForm">
            <div>
              <label for="participantCode">Session code</label>
              <input class="field" id="participantCode" name="participantCode" placeholder="TW-2024" required />
            </div>
            <div class="row two">
              <div>
                <label for="displayName">Display name</label>
                <input class="field" id="displayName" name="displayName" placeholder="Alex" />
              </div>
              <div class="toggle">
                <input type="checkbox" id="isAnonymous" />
                <label for="isAnonymous">Join as anonymous</label>
              </div>
            </div>
            <div class="row two">
              <div>
                <label for="department">Department</label>
                <select class="field" id="department" name="department">
                  <option value="">Select</option>
                  <option>Engineering</option>
                  <option>Product</option>
                  <option>Design</option>
                  <option>Operations</option>
                </select>
              </div>
              <div>
                <label for="role">Role</label>
                <input class="field" id="role" name="role" placeholder="Lead, IC, Manager" />
              </div>
            </div>
            <div>
              <button class="btn primary" type="submit">Join session</button>
            </div>
          </form>
          <div class="status" id="participantStatus" data-kind="info">Waiting for participant join.</div>
        </div>

        <div class="card">
          <h4>Participant status</h4>
          <div class="summary">
            <div><strong>Participant ID</strong><br /><span id="summaryParticipant">Not joined</span></div>
            <div><strong>Bound session</strong><br /><span id="summaryParticipantSession">Not linked</span></div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" style="--delay: 0.1s;">
      <h3>Submit response</h3>
      <p>Send your feedback for the open activity.</p>
      <div class="panel-grid">
        <div class="card">
          <h4>Response form</h4>
          <form class="form" id="responseForm">
            <div>
              <label for="responseSessionCode">Session code</label>
              <input class="field" id="responseSessionCode" name="responseSessionCode" placeholder="TW-2024" required />
            </div>
            <div>
              <label for="responseActivityId">Activity ID</label>
              <input class="field" id="responseActivityId" name="responseActivityId" placeholder="Guid" required />
            </div>
            <div>
              <label for="responseParticipantId">Participant ID</label>
              <input class="field" id="responseParticipantId" name="responseParticipantId" placeholder="Guid" required />
            </div>
            <div>
              <label for="responsePayload">Response payload</label>
              <textarea class="field" id="responsePayload" name="responsePayload" rows="4" placeholder="Type your response (text or JSON)"></textarea>
            </div>
            <div>
              <button class="btn primary" type="submit">Submit response</button>
            </div>
          </form>
          <div class="status" id="responseStatus" data-kind="info">Waiting for a response submission.</div>
        </div>

        <div class="card">
          <h4>My dashboard</h4>
          <div class="metric-grid">
            <div class="metric">
              <strong id="participantTotalResponses">0</strong>
              <span>Total responses</span>
            </div>
            <div class="metric">
              <strong id="participantDistinctActivities">0</strong>
              <span>Activities answered</span>
            </div>
            <div class="metric">
              <strong id="participantLastResponse">-</strong>
              <span>Last response</span>
            </div>
          </div>
          <h4 style="margin-top: 16px;">My responses</h4>
          <ul class="list" id="participantResponses">
            <li><span>No responses yet</span><span>--</span></li>
          </ul>
          <div style="margin-top: 12px;">
            <button class="btn secondary" type="button" id="loadParticipantDashboard">Load my dashboard</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="/js/signalr.min.js"></script>
  <script>
    const participantForm = document.getElementById("participantForm");
    const responseForm = document.getElementById("responseForm");

    const participantCode = document.getElementById("participantCode");
    const responseSessionCode = document.getElementById("responseSessionCode");
    const responseActivityId = document.getElementById("responseActivityId");
    const responseParticipantId = document.getElementById("responseParticipantId");
    const responsePayload = document.getElementById("responsePayload");

    const summaryParticipant = document.getElementById("summaryParticipant");
    const summaryParticipantSession = document.getElementById("summaryParticipantSession");

    const participantTotalResponses = document.getElementById("participantTotalResponses");
    const participantDistinctActivities = document.getElementById("participantDistinctActivities");
    const participantLastResponse = document.getElementById("participantLastResponse");
    const participantResponses = document.getElementById("participantResponses");
    const loadParticipantDashboard = document.getElementById("loadParticipantDashboard");

    let connection = null;

    function setStatus(id, message, kind) {
      const el = document.getElementById(id);
      el.textContent = message;
      el.dataset.kind = kind;
    }

    async function parseJson(response) {
      const payload = await response.json();
      if (!response.ok || (payload.errors && payload.errors.length)) {
        const message = payload.errors && payload.errors.length
          ? payload.errors.map((error) => error.message).join(" ")
          : "Request failed.";
        throw new Error(message);
      }
      return payload.data;
    }

    async function connectSignalR(code) {
      if (!window.signalR) {
        return;
      }

      if (connection) {
        await connection.stop();
      }

      connection = new signalR.HubConnectionBuilder()
        .withUrl("/hubs/workshop")
        .withAutomaticReconnect()
        .build();

      connection.on("ActivityStateChanged", (payload) => {
        if (!payload || payload.sessionCode !== code) {
          return;
        }
        if (payload.status === "Open" && payload.activityId) {
          responseActivityId.value = payload.activityId;
        }
      });

      connection.on("ResponseReceived", (payload) => {
        if (!payload || payload.sessionCode !== code) {
          return;
        }
        loadDashboard().catch(() => {});
      });

      await connection.start();
      await connection.invoke("Subscribe", code);
    }

    async function loadDashboard() {
      const code = responseSessionCode.value.trim();
      const participantId = responseParticipantId.value.trim();
      if (!code || !participantId) {
        return;
      }

      const dashboardResponse = await fetch(`/api/sessions/${encodeURIComponent(code)}/participants/${participantId}/dashboard`);
      const dashboard = await parseJson(dashboardResponse);
      participantTotalResponses.textContent = dashboard.totalResponses;
      participantDistinctActivities.textContent = dashboard.distinctActivities;
      participantLastResponse.textContent = dashboard.lastResponseAt
        ? new Date(dashboard.lastResponseAt).toLocaleString()
        : "-";

      const responsesResponse = await fetch(`/api/sessions/${encodeURIComponent(code)}/participants/${participantId}/responses`);
      const responsesData = await parseJson(responsesResponse);
      participantResponses.innerHTML = "";
      if (responsesData.responses && responsesData.responses.length) {
        responsesData.responses.slice(-6).forEach((item) => {
          const li = document.createElement("li");
          const left = document.createElement("span");
          left.textContent = item.payload;
          const right = document.createElement("span");
          right.textContent = new Date(item.createdAt).toLocaleTimeString();
          li.appendChild(left);
          li.appendChild(right);
          participantResponses.appendChild(li);
        });
      } else {
        participantResponses.innerHTML = "<li><span>No responses yet</span><span>--</span></li>";
      }
    }

    const params = new URLSearchParams(window.location.search);
    const codeParam = params.get("code");
    if (codeParam) {
      participantCode.value = codeParam;
      responseSessionCode.value = codeParam;
      connectSignalR(codeParam);
    }

    participantForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setStatus("participantStatus", "Joining session...", "info");

      const code = participantCode.value.trim();
      const dimensions = {};
      const department = document.getElementById("department").value.trim();
      const role = document.getElementById("role").value.trim();
      if (department) {
        dimensions.department = department;
      }
      if (role) {
        dimensions.role = role;
      }

      const payload = {
        displayName: document.getElementById("displayName").value.trim() || null,
        isAnonymous: document.getElementById("isAnonymous").checked,
        dimensions
      };

      try {
        const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/participants/join`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await parseJson(response);
        summaryParticipant.textContent = data.participantId;
        summaryParticipantSession.textContent = code;
        responseParticipantId.value = data.participantId;
        responseSessionCode.value = code;
        await connectSignalR(code);
        await loadDashboard();
        setStatus("participantStatus", "Participant joined successfully.", "success");
      } catch (error) {
        setStatus("participantStatus", error.message, "error");
      }
    });

    responseForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setStatus("responseStatus", "Submitting response...", "info");

      const code = responseSessionCode.value.trim();
      const activityId = responseActivityId.value.trim();
      const participantId = responseParticipantId.value.trim();
      const payloadText = responsePayload.value.trim();

      if (!code || !activityId || !participantId) {
        setStatus("responseStatus", "Session, activity, and participant IDs are required.", "error");
        return;
      }

      if (!payloadText) {
        setStatus("responseStatus", "Response payload is required.", "error");
        return;
      }

      const payload = {
        participantId,
        payload: payloadText
      };

      try {
        const response = await fetch(`/api/sessions/${encodeURIComponent(code)}/activities/${activityId}/responses`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await parseJson(response);
        setStatus("responseStatus", `Response submitted (${data.responseId}).`, "success");
        responsePayload.value = "";
        await loadDashboard();
      } catch (error) {
        setStatus("responseStatus", error.message, "error");
      }
    });

    loadParticipantDashboard.addEventListener("click", async () => {
      try {
        await loadDashboard();
      } catch (error) {
        setStatus("responseStatus", error.message, "error");
      }
    });
  </script>
</body>
</html>
