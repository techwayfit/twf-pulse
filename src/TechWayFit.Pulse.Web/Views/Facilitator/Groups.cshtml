@model IReadOnlyCollection<TechWayFit.Pulse.Web.Models.GroupWithSessionsViewModel>

@{
    ViewData["Title"] = "Manage Groups - TechWayFit Pulse";
    var userEmail = ViewData["UserEmail"] as string;
    var userName = ViewData["UserName"] as string;
    var returnUrl = Context.Request.Query["returnUrl"].ToString();
    var isFromCreateSession = !string.IsNullOrEmpty(returnUrl) && returnUrl.Contains("create", StringComparison.OrdinalIgnoreCase);
    
    // Store all groups in ViewData for recursive rendering
    ViewData["AllGroups"] = Model;
}

@section Styles {
    <style>
        /* Tree View Card Styling */
        .group-tree-card {
            transition: all 0.2s ease;
            border: 1px solid #e3e8ef !important;
            background: #ffffff;
        }
        .group-tree-card:hover {
            border-color: #cbd5e0 !important;
        }
        
        /* Expand/Collapse Icon */
        .expand-icon {
            display: inline-block;
            transition: transform 0.2s ease;
            font-size: 0.75rem;
            color: #94a3b8;
            width: 20px;
            text-align: center;
        }
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        /* Cursor for clickable header */
        .cursor-pointer {
            cursor: pointer;
            user-select: none;
        }
        .cursor-pointer:hover {
            background-color: #f8fafc !important;
        }
        
        /* Card Header Styling */
        .group-tree-card .card-header {
            border-bottom: 1px solid #f1f5f9;
            background: linear-gradient(to bottom, #ffffff, #fafbfc);
        }
        
        /* Sessions List Styling */
        .sessions-list {
            max-height: 240px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        .sessions-list::-webkit-scrollbar {
            width: 4px;
        }
        .sessions-list::-webkit-scrollbar-track {
            background: transparent;
        }
        .sessions-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 2px;
        }
        .sessions-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .session-item {
            background: #f8fafc;
            border-radius: 0.375rem;
            transition: all 0.15s ease;
        }
        .session-item:hover {
            background: #f1f5f9 !important;
            transform: translateX(2px);
        }
        
        .session-status-icon {
            font-size: 0.875rem;
            line-height: 1;
        }
        
        /* Session Status Styling */
        .session-status-live {
            color: #10b981;
            font-weight: 600;
        }
        .session-status-live::before {
            content: 'üü¢ ';
        }
        
        /* Child Groups Indentation */
        .child-groups {
            margin-top: 0.75rem;
        }
        .child-groups .group-tree-card {
            margin-bottom: 0.5rem;
        }
        
        /* Level Badge Colors - More subtle */
        .badge.bg-success { 
            background-color: #10b981 !important; 
            color: white;
            font-weight: 600;
        }
        .badge.bg-warning { 
            background-color: #f59e0b !important; 
            color: white;
            font-weight: 600;
        }
        .badge.bg-danger { 
            background-color: #ef4444 !important; 
            color: white;
            font-weight: 600;
        }
        .badge.bg-secondary {
            background-color: #64748b !important;
            color: white;
            font-weight: 500;
        }
        
        /* Action Buttons - More subtle */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .action-buttons .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.625rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border-width: 1px;
        }
        .action-buttons .btn-outline-primary {
            color: #3b82f6;
            border-color: #bfdbfe;
            background: white;
        }
        .action-buttons .btn-outline-primary:hover {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }
        .action-buttons .btn-outline-success {
            color: #10b981;
            border-color: #a7f3d0;
            background: white;
        }
        .action-buttons .btn-outline-success:hover {
            background: #ecfdf5;
            border-color: #10b981;
            color: #047857;
        }
        
        /* Dropdown menu styling */
        .dropdown-menu {
            z-index: 1050 !important;
            border: 1px solid #e3e8ef;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .dropdown.show {
            z-index: 1050;
        }
        .dropdown-toggle {
            color: #64748b;
            border-color: #e3e8ef;
        }
        .dropdown-toggle:hover {
            color: #334155;
            border-color: #cbd5e0;
        }
    </style>
}

<main class="py-4">
    <div class="container container-wide">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h2 class="mb-1" style="font-weight: 700; color: #1e293b;">Session Groups</h2>
                <p class="text-muted mb-0" style="font-size: 0.9rem;">Organize your workshop sessions into groups for better management</p>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal" style="font-weight: 600;">
                    ‚ûï Create Group
                </button>
                @if (isFromCreateSession)
                {
                    <a href="@Url.Action("CreateSession", "Facilitator")" class="btn btn-outline-secondary">
                        ‚Üê Back to Create Session
                    </a>
                }
                else
                {
                    <a href="@Url.Action("Dashboard", "Facilitator")" class="btn btn-outline-secondary">
                        ‚Üê Back to Dashboard
                    </a>
                }
            </div>
        </div>

        <!-- Info Alert -->
        @if (!Model.Any())
        {
            <div class="alert alert-info border-0 shadow-sm mb-4">
                <div class="d-flex align-items-center">
                    <div class="me-3 fs-4">üí°</div>
                    <div>
                        <h6 class="alert-heading mb-1">Get Started with Session Groups</h6>
                        <p class="mb-0">Create hierarchical groups to organize your workshop sessions. You can have up to 3 levels: Group ‚Üí Sub Group ‚Üí Sub Sub Group</p>
                    </div>
                </div>
            </div>
        }

        <!-- Groups List -->
        <div id="groupsList">
            @foreach (var group in Model.Where(g => g.Group.Level == 1).OrderBy(g => g.Group.Name))
            {
                @await Html.PartialAsync("_GroupCard", group)
            }
        </div>
    </div>
</main>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createGroupModalLabel">Create Session Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createGroupForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">Group Name *</label>
                        <input type="text" class="form-control" id="groupName" name="name" required maxlength="200">
                    </div>
                    
                    <div class="mb-3">
                        <label for="groupDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="groupDescription" name="description" rows="3" maxlength="1000" placeholder="Optional description for this group"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Icon & Color</label>
                        <div class="d-flex align-items-start gap-3 flex-wrap">
                            <div class="d-flex flex-column align-items-center gap-2">
                                <button type="button" id="groupIcon-display" class="btn btn-outline-secondary" style="font-size: 1.5rem; width: 60px; height: 60px;">üìÅ</button>
                                <button type="button" id="groupIcon-change" class="btn btn-sm btn-outline-primary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; white-space: nowrap;">Change Icon</button>
                                <input type="hidden" id="groupIcon" name="icon" value="üìÅ">
                            </div>
                            <div class="d-flex flex-column align-items-center gap-2">
                                <div id="groupColor-preview" class="border rounded" style="width: 60px; height: 60px; background: #f8fafc; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.65rem; text-align: center; padding: 0.25rem;">No Color</div>
                                <button type="button" id="groupColor-change" class="btn btn-sm btn-outline-success" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; white-space: nowrap;">Change Color</button>
                                <input type="hidden" id="groupColor" name="color">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="groupLevel" class="form-label">Level *</label>
                        <select class="form-select" id="groupLevel" name="level" required>
                            <option value="1">Level 1 (Main Group)</option>
                            <option value="2">Level 2 (Sub Group)</option>
                            <option value="3">Level 3 (Sub Sub Group)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="parentGroupContainer" style="display: none;">
                        <label for="parentGroup" class="form-label">Parent Group *</label>
                        <select class="form-select" id="parentGroup" name="parentGroupId">
                            <option value="">Select parent group...</option>
                            @foreach (var group in Model.Where(g => g.Group.Level <= 2))
                            {
                                <option value="@group.Group.Id" data-level="@group.Group.Level">
                                    @(new string('‚Äî', (group.Group.Level - 1) * 2)) @group.Group.Name
                                </option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Group Modal -->
<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGroupModalLabel">Edit Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editGroupForm">
                <input type="hidden" id="editGroupId" name="id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editGroupName" class="form-label">Group Name *</label>
                        <input type="text" class="form-control" id="editGroupName" name="name" required maxlength="200">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editGroupDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editGroupDescription" name="description" rows="3" maxlength="1000"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Icon & Color</label>
                        <div class="d-flex align-items-start gap-3 flex-wrap">
                            <div class="d-flex flex-column align-items-center gap-2">
                                <button type="button" id="editGroupIcon-display" class="btn btn-outline-secondary" style="font-size: 1.5rem; width: 60px; height: 60px;">üìÅ</button>
                                <button type="button" id="editGroupIcon-change" class="btn btn-sm btn-outline-primary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; white-space: nowrap;">Change Icon</button>
                                <input type="hidden" id="editGroupIcon" name="icon" value="üìÅ">
                            </div>
                            <div class="d-flex flex-column align-items-center gap-2">
                                <div id="editGroupColor-preview" class="border rounded" style="width: 60px; height: 60px; background: #f8fafc; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.65rem; text-align: center; padding: 0.25rem;">No Color</div>
                                <button type="button" id="editGroupColor-change" class="btn btn-sm btn-outline-success" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; white-space: nowrap;">Change Color</button>
                                <input type="hidden" id="editGroupColor" name="color">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Group</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/icon-picker.js"></script>
    <script>
        // Initialize icon and color pickers
        let createIconPicker, createColorPicker, editIconPicker, editColorPicker;
        let initialized = false;
        
        document.addEventListener('DOMContentLoaded', () => {
            if (initialized) {
                console.log('Already initialized, skipping');
                return;
            }
            initialized = true;
            
            console.log('Initializing icon and color pickers...');
            
            // Initialize CREATE icon picker (icon-only mode)
            createIconPicker = new IconPicker('groupIcon', { 
                displayId: 'groupIcon-display',
                triggerButtonId: 'groupIcon-change',
                pickerContainerId: 'groupIcon-picker',
                mode: 'icon-only'
            });
            
            // Initialize CREATE color picker (color-only mode)
            createColorPicker = new IconPicker('groupColor', { 
                displayId: 'groupColor-preview',
                triggerButtonId: 'groupColor-change',
                pickerContainerId: 'groupColor-picker',
                mode: 'color-only',
                onColorChange: updateColorPreview.bind(null, 'groupColor-preview', 'groupColor')
            });
            
            // Initialize EDIT icon picker (icon-only mode)
            editIconPicker = new IconPicker('editGroupIcon', { 
                displayId: 'editGroupIcon-display',
                triggerButtonId: 'editGroupIcon-change',
                pickerContainerId: 'editGroupIcon-picker',
                mode: 'icon-only'
            });
            
            // Initialize EDIT color picker (color-only mode)
            editColorPicker = new IconPicker('editGroupColor', { 
                displayId: 'editGroupColor-preview',
                triggerButtonId: 'editGroupColor-change',
                pickerContainerId: 'editGroupColor-picker',
                mode: 'color-only',
                onColorChange: updateColorPreview.bind(null, 'editGroupColor-preview', 'editGroupColor')
            });
            
            console.log('Icon and color pickers initialized');
        });
        
        // Update color preview box
        function updateColorPreview(previewId, inputId, color) {
            console.log('updateColorPreview called:', { previewId, inputId, color });
            
            const preview = document.getElementById(previewId);
            const input = document.getElementById(inputId);
            
            console.log('Preview element:', preview);
            console.log('Input element:', input);
            
            if (color) {
                preview.style.background = color;
                preview.textContent = '';
                input.value = color;
                console.log('Color set to:', color);
            } else {
                preview.style.background = '#f8fafc';
                preview.textContent = 'No Color';
                preview.style.color = '#94a3b8';
                input.value = '';
                console.log('Color cleared');
            }
        }
        
        // Reset modal when it's closed
        document.getElementById('createGroupModal').addEventListener('hidden.bs.modal', function () {
            const levelSelect = document.getElementById('groupLevel');
            const parentSelect = document.getElementById('parentGroup');
            const createModalLabel = document.getElementById('createGroupModalLabel');
            const parentContainer = document.getElementById('parentGroupContainer');
            
            // Reset modal title
            createModalLabel.textContent = 'Create Session Group';
            
            // Re-enable fields
            levelSelect.disabled = false;
            parentSelect.disabled = false;
            
            // Reset form
            document.getElementById('createGroupForm').reset();
            
            // Hide parent container
            parentContainer.style.display = 'none';
            parentSelect.required = false;
            
            // Reset icon and color
            if (createIconPicker) {
                createIconPicker.updateDisplay('üìÅ');
                document.getElementById('groupIcon').value = 'üìÅ';
            }
            updateColorPreview('groupColor-preview', 'groupColor', null);
        });
        
        // Ensure pickers are visible when modal is shown
        document.getElementById('createGroupModal').addEventListener('shown.bs.modal', function () {
            if (!createIconPicker || !document.getElementById('groupIcon-picker')) {
                createIconPicker = new IconPicker('groupIcon', { 
                    displayId: 'groupIcon-display',
                    triggerButtonId: 'groupIcon-change',
                    pickerContainerId: 'groupIcon-picker',
                    mode: 'icon-only'
                });
            }
            if (!createColorPicker || !document.getElementById('groupColor-picker')) {
                createColorPicker = new IconPicker('groupColor', { 
                    displayId: 'groupColor-preview',
                    triggerButtonId: 'groupColor-change',
                    pickerContainerId: 'groupColor-picker',
                    mode: 'color-only',
                    onColorChange: updateColorPreview.bind(null, 'groupColor-preview', 'groupColor')
                });
            }
        });
        
        // Ensure edit pickers are visible when modal is shown
        document.getElementById('editGroupModal').addEventListener('shown.bs.modal', function () {
            if (!editIconPicker || !document.getElementById('editGroupIcon-picker')) {
                editIconPicker = new IconPicker('editGroupIcon', { 
                    displayId: 'editGroupIcon-display',
                    triggerButtonId: 'editGroupIcon-change',
                    pickerContainerId: 'editGroupIcon-picker',
                    mode: 'icon-only'
                });
            }
            if (!editColorPicker || !document.getElementById('editGroupColor-picker')) {
                editColorPicker = new IconPicker('editGroupColor', { 
                    displayId: 'editGroupColor-preview',
                    triggerButtonId: 'editGroupColor-change',
                    pickerContainerId: 'editGroupColor-picker',
                    mode: 'color-only',
                    onColorChange: updateColorPreview.bind(null, 'editGroupColor-preview', 'editGroupColor')
                });
            }
        });

        // Group level change handler
        document.getElementById('groupLevel').addEventListener('change', function() {
            // Skip if field is disabled (sub-group creation mode)
            if (this.disabled) return;
            
            const level = parseInt(this.value);
            const parentContainer = document.getElementById('parentGroupContainer');
            const parentSelect = document.getElementById('parentGroup');
            
            if (level > 1) {
                parentContainer.style.display = 'block';
                parentSelect.required = true;
                
                // Filter parent options based on level
                const options = parentSelect.querySelectorAll('option[data-level]');
                options.forEach(option => {
                    const optionLevel = parseInt(option.getAttribute('data-level'));
                    option.style.display = optionLevel < level ? 'block' : 'none';
                });
            } else {
                parentContainer.style.display = 'none';
                parentSelect.required = false;
                parentSelect.value = '';
            }
        });

        // Create group form
        document.getElementById('createGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Handle disabled fields manually (disabled fields are not included in FormData)
            const levelSelect = document.getElementById('groupLevel');
            const parentSelect = document.getElementById('parentGroup');
            
            if (levelSelect.disabled && levelSelect.value) {
                data.level = levelSelect.value;
            }
            if (parentSelect.disabled && parentSelect.value) {
                data.parentGroupId = parentSelect.value;
            }
            
            console.log('Form data before processing:', data);
            console.log('Icon value:', data.icon);
            console.log('Color value:', data.color);
            
            // Convert empty parentGroupId to null
            if (!data.parentGroupId) {
                data.parentGroupId = null;
            }
            
            data.level = parseInt(data.level);
            
            // Ensure icon has a default value if not set
            if (!data.icon) {
                data.icon = 'üìÅ';
            }
            
            console.log('Final data to send:', data);
            
            try {
                const response = await fetch('/api/session-groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    location.reload();
                } else {
                    let errorMessage = 'Unknown error';
                    try {
                        const error = await response.json();
                        console.error('Error response:', error);
                        errorMessage = error.message || error.title || JSON.stringify(error);
                    } catch (parseErr) {
                        const errorText = await response.text();
                        console.error('Error response (text):', errorText);
                        errorMessage = errorText || `HTTP ${response.status}`;
                    }
                    alert('Error creating group: ' + errorMessage);
                }
            } catch (err) {
                console.error('Error creating group:', err);
                alert('Error creating group: ' + (err.message || 'Network error'));
            }
        });

        // Edit group
        function editGroup(id, name, description, icon, color) {
            event.preventDefault();
            document.getElementById('editGroupId').value = id;
            document.getElementById('editGroupName').value = name;
            document.getElementById('editGroupDescription').value = description || '';
            document.getElementById('editGroupIcon').value = icon || 'üìÅ';
            
            if (editIconPicker) {
                editIconPicker.updateDisplay(icon || 'üìÅ');
            }
            
            // Update color preview
            updateColorPreview('editGroupColor-preview', 'editGroupColor', color);
            
            new bootstrap.Modal(document.getElementById('editGroupModal')).show();
            return false;
        }

        // Edit group form
        document.getElementById('editGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            const groupId = data.id;
            
            try {
                const response = await fetch(`/api/session-groups/${groupId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: data.name,
                        description: data.description,
                        icon: data.icon,
                        color: data.color
                    })
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error updating group: ' + (error.message || 'Unknown error'));
                }
            } catch (err) {
                alert('Error updating group: ' + (err.message || 'Network error'));
            }
        });

        // Delete group
        async function deleteGroup(id, name) {
            event.preventDefault();
            if (!confirm(`Are you sure you want to delete the group "${name}"? This action cannot be undone.`)) {
                return false;
            }
            
            try {
                const response = await fetch(`/api/session-groups/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error deleting group: ' + (error.message || 'Unknown error'));
                }
            } catch (err) {
                alert('Error deleting group: ' + (err.message || 'Network error'));
            }
            return false;
        }
        
        // ===== EXPAND/COLLAPSE WITH LOCALSTORAGE =====
        const STORAGE_KEY = 'groupsExpandedState';
        
        // Get expanded state from localStorage
        function getExpandedState() {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }
        
        // Save expanded state to localStorage
        function saveExpandedState(groupId, isExpanded) {
            const state = getExpandedState();
            state[groupId] = isExpanded;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }
        
        // Toggle group expand/collapse
        window.toggleGroupExpand = function(groupId) {
            const content = document.getElementById(`content-${groupId}`);
            const icon = document.getElementById(`expand-icon-${groupId}`);
            
            if (!content || !icon) return;
            
            const isExpanding = !content.classList.contains('show');
            
            // Toggle Bootstrap collapse
            if (isExpanding) {
                content.classList.add('show');
                icon.classList.add('expanded');
            } else {
                content.classList.remove('show');
                icon.classList.remove('expanded');
            }
            
            // Save state to localStorage
            saveExpandedState(groupId, isExpanding);
        };
        
        // Initialize expand/collapse state on page load
        function initializeExpandedState() {
            const state = getExpandedState();
            const allCards = document.querySelectorAll('[data-group-id]');
            
            // If no saved state, expand the first top-level group
            if (Object.keys(state).length === 0 && allCards.length > 0) {
                const firstGroupId = allCards[0].getAttribute('data-group-id');
                toggleGroupExpand(firstGroupId);
                return;
            }
            
            // Restore saved state
            allCards.forEach(card => {
                const groupId = card.getAttribute('data-group-id');
                if (state[groupId]) {
                    const content = document.getElementById(`content-${groupId}`);
                    const icon = document.getElementById(`expand-icon-${groupId}`);
                    if (content && icon) {
                        content.classList.add('show');
                        icon.classList.add('expanded');
                    }
                }
            });
        }
        
        // Initialize on page load
        initializeExpandedState();
    </script>
}