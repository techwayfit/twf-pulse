@model TechWayFit.Pulse.Domain.Entities.SessionTemplate

@{
    ViewData["Title"] = $"Customize {Model.Name} - TechWayFit Pulse";
    var userEmail = ViewData["UserEmail"] as string;
    var userName = ViewData["UserName"] as string;
    var groups = ViewData["Groups"] as IEnumerable<TechWayFit.Pulse.Domain.Entities.SessionGroup>;
    var config = System.Text.Json.JsonSerializer.Deserialize<TechWayFit.Pulse.Domain.Models.SessionTemplateConfig>(Model.ConfigJson);
}

<main class="dashboard-main">
    <div class="container" style="max-width: 900px;">
        <!-- Header -->
        <div class="dashboard-header mb-4">
            <div class="dashboard-header-text">
                <div class="d-flex align-items-center mb-2">
                    <span class="fs-1 me-3">@Model.IconEmoji</span>
                    <div>
                        <h2 class="dashboard-title mb-0">@Model.Name</h2>
                        <p class="text-muted mb-0">@Model.Description</p>
                    </div>
                </div>
            </div>
            <div class="dashboard-header-actions">
                <a href="@Url.Action("Templates", "Facilitator")" class="btn btn-pulse-outline">
                    ‚Üê Back to Templates
                </a>
            </div>
        </div>

        <!-- Customization Form -->
        <form id="customizeTemplateForm">
            <input type="hidden" name="templateId" value="@Model.Id" />

            <!-- Session Details -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üìù Session Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Session Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="@config?.Title" maxlength="200" required>
                        <div class="form-text">Give your session a descriptive title</div>
                    </div>

                    <div class="mb-3">
                        <label for="goal" class="form-label">Session Goal</label>
                        <textarea class="form-control" id="goal" name="goal" rows="2">@config?.Goal</textarea>
                        <div class="form-text">What do you hope to achieve in this session?</div>
                    </div>

                    <div class="mb-3">
                        <label for="context" class="form-label">Session Context</label>
                        <textarea class="form-control" id="context" name="context" rows="2">@config?.Context</textarea>
                        <div class="form-text">Any background information participants should know</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="groupId" class="form-label">Session Group (Optional)</label>
                            @{
                                var treeItems = new List<TechWayFit.Pulse.Web.ViewComponents.TreeDropdown.TreeDropdownItem>();
                                
                                if (groups != null)
                                {
                                    foreach (var group in groups)
                                    {
                                        treeItems.Add(new TechWayFit.Pulse.Web.ViewComponents.TreeDropdown.TreeDropdownItem
                                        {
                                            Value = group.Id.ToString(),
                                            Text = group.Name,
                                            ParentValue = group.ParentGroupId?.ToString(),
                                            Level = group.Level - 1,
                                            HasChildren = groups.Any(g => g.ParentGroupId == group.Id),
                                            Icon = group.Level == 1 ? "üìÅ" : group.Level == 2 ? "üìÇ" : "üìÑ"
                                        });
                                    }
                                }
                            }
                            @await Component.InvokeAsync("TreeDropdown", new {
                                id = "groupId",
                                name = "groupId",
                                placeholder = "No group (ungrouped)",
                                items = treeItems,
                                allowClear = true
                            })
                            @if (groups == null || !groups.Any())
                            {
                                <div class="form-text">
                                    No groups yet. Click "Create New Folder" in the dropdown to organize sessions.
                                </div>
                            }
                            else
                            {
                                <div class="form-text">Organize sessions into folders</div>
                            }
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="ttlMinutes" class="form-label">Session Duration (minutes)</label>
                            <input type="number" class="form-control" id="ttlMinutes" name="ttlMinutes" 
                                   value="@(config?.Settings?.DurationMinutes ?? 120)" min="30" max="480">
                            <div class="form-text">Auto-expire after this duration</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Session Settings -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">‚öôÔ∏è Session Settings</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="maxParticipants" class="form-label">Max Participants</label>
                            <input type="number" class="form-control" id="maxParticipants" 
                                   name="maxParticipants" 
                                   value="@(config?.Settings?.MaxParticipants ?? 0)" min="0">
                            <div class="form-text">0 = unlimited</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="allowAnonymous" 
                                       name="allowAnonymous" 
                                       @(config?.Settings?.AllowAnonymous == true ? "checked" : "")>
                                <label class="form-check-label" for="allowAnonymous">
                                    Allow Anonymous Participation
                                </label>
                                <div class="form-text">Participants can join without providing their name</div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Join Form Schema -->
            @if (config?.JoinFormSchema?.Fields?.Any() == true)
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">üìã Join Form Fields</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">These fields will be shown when participants join the session</p>
                        @foreach (var field in config.JoinFormSchema.Fields)
                        {
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-secondary-subtle text-secondary me-2">@field.Type</span>
                                <span class="fw-medium">@field.Label</span>
                                @if (field.Required)
                                {
                                    <span class="badge bg-danger-subtle text-danger ms-2">Required</span>
                                }
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Activities Preview -->
            @if (config?.Activities?.Any() == true)
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">üìã Activities (@config.Activities.Count)</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">The following activities will be created with this session</p>
                        <div class="list-group list-group-flush">
                            @for (int i = 0; i < config.Activities.Count; i++)
                            {
                                var activity = config.Activities[i];
                                <div class="list-group-item px-0">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-primary-subtle text-primary me-2">@(i + 1)</span>
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="fw-medium me-2">@activity.Title</span>
                                                <span class="badge bg-secondary-subtle text-secondary">@activity.Type</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(activity.Prompt))
                                            {
                                                <p class="text-muted small mb-0">@activity.Prompt</p>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Actions -->
            <div class="d-flex gap-3 mb-4">
                <button type="submit" class="btn btn-pulse-primary btn-lg flex-grow-1" id="createSessionBtn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="createSpinner"></span>
                    ‚ú® Create Session
                </button>
                <a href="@Url.Action("Templates", "Facilitator")" class="btn btn-outline-secondary btn-lg">
                    Cancel
                </a>
            </div>
        </form>

        <!-- Alert Container -->
        <div id="alertContainer"></div>
    </div>
</main>

@section Scripts {
    <script>
        // Initialize Tree Dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all tree dropdowns with proper configuration
            document.querySelectorAll('.tree-dropdown [data-bs-toggle="dropdown"]').forEach(function(dropdownToggle) {
                const dropdown = new bootstrap.Dropdown(dropdownToggle, {
                    autoClose: 'outside',
                    popperConfig: {
                        strategy: 'absolute',
                        modifiers: [
                            {
                                name: 'flip',
                                options: {
                                    fallbackPlacements: ['bottom', 'top'],
                                }
                            },
                            {
                                name: 'preventOverflow',
                                options: {
                                    boundary: 'clippingParents',
                                    altAxis: true,
                                    padding: 8
                                }
                            },
                            {
                                name: 'offset',
                                options: {
                                    offset: [0, 4]
                                }
                            }
                        ]
                    }
                });
                
                // Add show class to tree-dropdown container when dropdown opens
                const treeDropdown = dropdownToggle.closest('.tree-dropdown');
                dropdownToggle.addEventListener('shown.bs.dropdown', function() {
                    if (treeDropdown) treeDropdown.classList.add('show');
                });
                
                // Remove show class when dropdown closes
                dropdownToggle.addEventListener('hidden.bs.dropdown', function() {
                    if (treeDropdown) treeDropdown.classList.remove('show');
                });
            });
            
            // Handle tree toggle clicks - prevent dropdown from closing
            document.addEventListener('click', function(e) {
                const toggleBtn = e.target.closest('.tree-toggle');
                if (toggleBtn) {
                    const targetId = toggleBtn.getAttribute('data-target');
                    const target = document.getElementById(targetId);
                    const icon = toggleBtn.querySelector('i');
                    
                    if (target) {
                        const isHidden = target.style.display === 'none' || target.style.display === '';
                        target.style.display = isHidden ? 'block' : 'none';
                        if (icon) {
                            icon.className = isHidden ? 'fas fa-chevron-down' : 'fas fa-chevron-right';
                        }
                    }
                    
                    e.stopPropagation();
                    e.preventDefault();
                }
            });
            
            // Handle tree item selection
            document.addEventListener('click', function(e) {
                const treeItem = e.target.closest('.tree-item');
                if (treeItem && !e.target.closest('.tree-toggle')) {
                    const value = treeItem.getAttribute('data-value');
                    const textEl = treeItem.querySelector('.tree-item-text');
                    if (!textEl) return;
                    
                    const text = textEl.textContent;
                    const dropdown = treeItem.closest('.tree-dropdown');
                    if (!dropdown) return;
                    
                    const hiddenInput = dropdown.querySelector('input[type="hidden"]');
                    const dropdownText = dropdown.querySelector('.dropdown-text');
                    
                    // Update value
                    if (hiddenInput) hiddenInput.value = value;
                    if (dropdownText) dropdownText.textContent = value ? text : 'No group (ungrouped)';
                    
                    // Close dropdown
                    const dropdownBtn = dropdown.querySelector('[data-bs-toggle="dropdown"]');
                    if (dropdownBtn) {
                        const dropdownElement = bootstrap.Dropdown.getInstance(dropdownBtn);
                        if (dropdownElement) {
                            dropdownElement.hide();
                        }
                    }
                    
                    // Remove selected class from all items
                    dropdown.querySelectorAll('.tree-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked item
                    if (value) {
                        treeItem.classList.add('selected');
                    }
                }
            });
        });
        
        const form = document.getElementById('customizeTemplateForm');
        const createBtn = document.getElementById('createSessionBtn');
        const spinner = document.getElementById('createSpinner');
        const alertContainer = document.getElementById('alertContainer');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading state
            createBtn.disabled = true;
            spinner.classList.remove('d-none');
            alertContainer.innerHTML = '';

            const formData = new FormData(form);
            const templateId = formData.get('templateId');
            
            // Build customization payload
            const customization = {
                title: formData.get('title'),
                goal: formData.get('goal') || null,
                context: formData.get('context') || null,
                groupId: formData.get('groupId') || null,
                settings: {
                    maxContributionsPerParticipantPerSession: parseInt(formData.get('maxContributionsPerSession')) || 0,
                    maxContributionsPerParticipantPerActivity: parseInt(formData.get('maxContributionsPerActivity')) || 0,
                    strictCurrentActivityOnly: formData.get('strictCurrentActivityOnly') === 'on',
                    allowAnonymous: formData.get('allowAnonymous') === 'on',
                    ttlMinutes: parseInt(formData.get('ttlMinutes')) || 120
                }
            };

            try {
                const response = await fetch(`/api/templates/create-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        templateId: templateId,
                        customization: customization
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Success - redirect to live facilitator view
                    alertContainer.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Success!</strong> Session created successfully. Redirecting...
                        </div>
                    `;
                    
                    setTimeout(() => {
                        window.location.href = `/facilitator/live?code=${result.code}`;
                    }, 1000);
                } else {
                    const result = await response.json();
                    const errorMessage = result.message || 'Failed to create session';
                    alertContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå Error:</strong> ${errorMessage}
                        </div>
                    `;
                    createBtn.disabled = false;
                    spinner.classList.add('d-none');
                }
            } catch (error) {
                alertContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Error:</strong> Network error. Please try again.
                    </div>
                `;
                createBtn.disabled = false;
                spinner.classList.add('d-none');
            }
        });
    </script>
}
