@{
    ViewData["Title"] = "TechWayFit Pulse — Create Session";
}

@section Styles {
    <link rel="stylesheet" href="~/css/create-session.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
}

<main class="py-5">
    <!-- Constrained Container -->
    <div class="container container-wide">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h2 class="mb-2">Create session</h2>
                <p class="text-muted mb-0">Context → Join Form (max 5 fields) → Launch</p>
            </div>
            <span class="badge bg-white text-dark border px-3 py-2">TTL: <strong>6h</strong></span>
        </div>

   

        <!-- Form -->
        <form id="sessionCreateForm" action="/api/sessions" method="post">
            <!-- Hidden field for templateId if coming from template selection -->
            @if (ViewData["TemplateId"] != null)
            {
                <input type="hidden" id="templateId" value="@ViewData["TemplateId"]" />
            }
            
            <!-- Session Context Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title fw-semibold mb-4">Session context</h5>

                    <!-- No tabs needed - single section -->

                    <!-- Session Group (First field to avoid data loss on page refresh) -->
                    <div class="mb-4">
                        <label class="form-label fw-medium">Session Group</label>
                        @{
                            var groups = ViewData["Groups"] as IReadOnlyCollection<TechWayFit.Pulse.Domain.Entities.SessionGroup> ?? new List<TechWayFit.Pulse.Domain.Entities.SessionGroup>();
                            var selectedGroupId = ViewData["SelectedGroupId"] as Guid?;
                            var treeItems = new List<TechWayFit.Pulse.Web.ViewComponents.TreeDropdown.TreeDropdownItem>();
                            
                            foreach (TechWayFit.Pulse.Domain.Entities.SessionGroup group in groups)
                            {
                                treeItems.Add(new TechWayFit.Pulse.Web.ViewComponents.TreeDropdown.TreeDropdownItem
                                {
                                    Value = group.Id.ToString(),
                                    Text = group.Name,
                                    ParentValue = group.ParentGroupId?.ToString(),
                                    Level = group.Level - 1,
                                    HasChildren = groups.Any(g => g.ParentGroupId == group.Id),
                                    Icon = group.Level == 1 ? "📁" : group.Level == 2 ? "📂" : "📄"
                                });
                            }
                        }
                        @await Component.InvokeAsync("TreeDropdown", new {
                            id = "groupId",
                            name = "groupId",
                            value = selectedGroupId?.ToString() ?? string.Empty,
                            placeholder = "No group (ungrouped)",
                            items = treeItems,
                            allowClear = true
                        })
                        @if (!groups.Any())
                        {
                            <div class="form-text">
                                No groups yet. <a href="#" data-bs-toggle="modal" data-bs-target="#createGroupModal">Create your first group</a> to organize sessions.
                            </div>
                        }
                        else
                        {
                            <div class="form-text">
                                Optional: Organize your session into a group · 
                                <a href="@Url.Action("Groups", "Facilitator", new { returnUrl = Url.Action("CreateSession", "Facilitator") })">Manage Groups</a>
                            </div>
                        }
                    </div>

                    <!-- Session Details -->
                    <div class="mb-4">
                                <label class="form-label fw-medium" for="sessionTitle">Session title</label>
                                <input class="form-control" name="sessionTitle" id="sessionTitle" required
                                       maxlength="150"
                                       value="@(ViewData["TemplateName"] ?? "")"
                                       placeholder="e.g., Sprint Retrospective - Team Alpha" />
                                <div class="text-end">
                                    <span class="text-muted fs-7" id="titleCharCount">0 / 150</span>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-medium" for="sessionGoal">Goal</label>
                                <textarea class="form-control" name="sessionGoal" id="sessionGoal" rows="2"
                                          maxlength="250"
                                          placeholder="What do you want to achieve in this session?">@(ViewData["TemplateDescription"] ?? "")</textarea>
                                <div class="text-end">
                                    <span class="text-muted fs-7" id="goalCharCount">0 / 250</span>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-medium" for="sessionContext">Context</label>
                                <textarea class="form-control" name="sessionContext" id="sessionContext" rows="4"
                                          maxlength="2000"
                                          placeholder="Provide detailed context to help AI generate relevant session content and activities (1000-2000 characters recommended)..."></textarea>
                                <div class="text-end">
                                    <span class="text-muted fs-7" id="contextCharCount">0 / 2000</span>
                                </div>
                            </div>
                            
                            <!-- Session Schedule -->
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label class="form-label fw-medium" for="sessionStart">Start date & time</label>
                                    <input type="text" class="form-control" name="sessionStart" id="sessionStart" placeholder="Select date & time" />
                                    <div class="form-text">Optional: When workshop is planned to start</div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label class="form-label fw-medium" for="sessionEnd">End date & time</label>
                                    <input type="text" class="form-control" name="sessionEnd" id="sessionEnd" placeholder="Select date & time" />
                                    <div class="form-text">Optional: When workshop is planned to end</div>
                                </div>
                            </div>
                </div>
            </div>

            <!-- Participant Fields Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <!-- Header -->
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-primary" viewBox="0 0 16 16">
                                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                                <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                            </svg>
                        </div>
                        <div>
                            <h6 class="fw-semibold mb-1">Participant Fields</h6>
                            <p class="text-muted small mb-0">
                                Configure what information to collect from participants when they join.
                            </p>
                        </div>
                    </div>

                    <!-- Default Field: Name (Always Collected) -->
                    <div class="mb-4">
                        <h6 class="small text-uppercase text-muted mb-3">Default Fields (Always Collected)</h6>
                        <div class="border rounded-3 p-3 bg-light">
                            <div class="d-flex align-items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-primary" viewBox="0 0 16 16">
                                    <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                                </svg>
                                <div class="flex-grow-1">
                                    <div class="fw-medium">Participant Name</div>
                                    <small class="text-muted">Display name (optional) with anonymous join option</small>
                                </div>
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">Default Field</span>
                            </div>
                        </div>
                    </div>

                    <!-- Optional: Additional Fields Toggle -->
                    <div class="form-check mb-3">
                        <input type="checkbox" 
                               class="form-check-input" 
                               id="needMoreInfoToggle" 
                               onchange="document.getElementById('additionalFieldsSection').style.display = this.checked ? 'block' : 'none';" />
                        <label class="form-check-label fw-medium" for="needMoreInfoToggle">
                            Need more info from participants before they join
                        </label>
                        <small class="d-block text-muted ms-4">Add custom fields like team name, role, department, etc.</small>
                    </div>

                    <!-- Additional Fields Section (Hidden by Default) -->
                    <div id="additionalFieldsSection" style="display: none;">
                        <hr class="my-4" />
                        
                        <h6 class="small text-uppercase text-muted mb-3">Custom Fields Builder</h6>
                        <p class="text-muted small mb-3">Add up to 5 custom fields. This data helps filter and group responses.</p>

                        <!-- Form Builder Content -->
                        <div class="form-builder-container" id="joinFormBuilder">
                            <!-- Left: Field Types -->
                            <div>
                                <div class="d-flex align-items-center mb-3">
                                    <h6 class="fw-semibold mb-0 text-uppercase small text-muted">Available Field Types</h6>
                                </div>
                                
                                <!-- Mobile: Dropdown + Add Button -->
                                <div class="mobile-field-selector d-none">
                                    <div class="d-flex gap-2">
                                        <select class="form-select" id="mobileFieldTypeSelect">
                                            <option value="">Select field type...</option>
                                            <option value="text">📝 Text Box</option>
                                            <option value="checkbox">☑️ Checkbox</option>
                                            <option value="dropdown">📋 Dropdown</option>
                                            <option value="textarea">📄 Text Area</option>
                                            <option value="radio">◉ Radio Button</option>
                                        </select>
                                        <button type="button" class="btn btn-primary" id="mobileAddFieldBtn" style="white-space: nowrap;">
                                            + Add
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Desktop: Draggable Field Types -->
                                <div class="d-flex flex-column gap-2" id="fieldTypes">
                                    <div class="field-type" draggable="true" data-type="text">
                                        <span class="icon">📝</span>
                                        <span class="label">Text Box</span>
                                    </div>
                                    <div class="field-type" draggable="true" data-type="checkbox">
                                        <span class="icon">☑️</span>
                                        <span class="label">Checkbox</span>
                                    </div>
                                    <div class="field-type" draggable="true" data-type="dropdown">
                                        <span class="icon">📋</span>
                                        <span class="label">Dropdown</span>
                                    </div>
                                    <div class="field-type" draggable="true" data-type="textarea">
                                        <span class="icon">📄</span>
                                        <span class="label">Text Area</span>
                                    </div>
                                    <div class="field-type" draggable="true" data-type="radio">
                                        <span class="icon">◉</span>
                                        <span class="label">Radio Button</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Drop Zone -->
                            <div class="form-drop-zone" id="formDropZone">
                                <div class="drop-zone-placeholder">
                                    <div class="text-center text-muted">
                                        <div class="fs-1 mb-2">⬇️</div>
                                        <div class="fw-medium">Drag field types here to build your join form</div>
                                        <small class="d-block mt-2">Maximum 5 fields allowed</small>
                                    </div>
                                </div>
                                <!-- Dynamic fields will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Hidden input to store form fields as JSON -->
                    <input type="hidden" id="joinFormFields" name="joinFormFields" value="[]" />
                </div>
            </div>

            <!-- Error Alert -->
            <div id="errorMessage" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <!-- Action Buttons -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <a class="btn btn-outline-secondary px-4" href="/">Cancel</a>
                        <button type="submit" class="btn btn-primary pulse-btn-primary px-4 py-2" id="submitBtn">
                            <span class="btn-text">Next: Add Activities →</span>
                            <span class="btn-loading d-none">
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                Creating session...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</main>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createGroupModalLabel">Create Session Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createGroupForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">Group Name *</label>
                        <input type="text" class="form-control" id="groupName" name="name" required maxlength="200">
                    </div>
                    
                    <div class="mb-3">
                        <label for="groupDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="groupDescription" name="description" rows="2" maxlength="1000" placeholder="Optional description"></textarea>
                    </div>
                    
                    <input type="hidden" name="level" value="1">
                    <input type="hidden" name="parentGroupId" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <!-- External JavaScript -->
    <script src="~/js/create-session-form.js" asp-append-version="true"></script>

    <!-- Character Counter -->
    <script>
        // Update character counters
        function updateCharCount(inputId, counterId, maxLength) {
            const input = document.getElementById(inputId);
            const counter = document.getElementById(counterId);
            if (input && counter) {
                const currentLength = input.value.length;
                counter.textContent = `${currentLength} / ${maxLength}`;
                
                // Change color when approaching limit
                if (currentLength > maxLength * 0.9) {
                    counter.classList.add('text-warning');
                    counter.classList.remove('text-muted');
                } else {
                    counter.classList.remove('text-warning');
                    counter.classList.add('text-muted');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Initialize character counters
            const titleInput = document.getElementById('sessionTitle');
            const goalInput = document.getElementById('sessionGoal');
            const contextInput = document.getElementById('sessionContext');
            
            if (titleInput) {
                titleInput.addEventListener('input', () => updateCharCount('sessionTitle', 'titleCharCount', 150));
                updateCharCount('sessionTitle', 'titleCharCount', 150); // Initial update
            }
            
            if (goalInput) {
                goalInput.addEventListener('input', () => updateCharCount('sessionGoal', 'goalCharCount', 250));
                updateCharCount('sessionGoal', 'goalCharCount', 250); // Initial update
            }
            
            if (contextInput) {
                contextInput.addEventListener('input', () => updateCharCount('sessionContext', 'contextCharCount', 2000));
                updateCharCount('sessionContext', 'contextCharCount', 2000); // Initial update
            }
        });
    </script>

    <!-- Tree Dropdown functionality -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Tree Dropdown
        initializeTreeDropdown();
        
        function initializeTreeDropdown() {
            // Handle tree toggle clicks first with capture phase
            document.addEventListener('click', function(e) {
                // Tree toggle functionality - handle in capture phase to prevent dropdown from closing
                if (e.target.closest('.tree-toggle')) {
                    const toggle = e.target.closest('.tree-toggle');
                    const targetId = toggle.getAttribute('data-target');
                    const target = document.getElementById(targetId);
                    const icon = toggle.querySelector('i');
                    
                    if (target) {
                        if (target.style.display === 'none' || target.style.display === '') {
                            target.style.display = 'block';
                            icon.className = 'fas fa-chevron-down';
                        } else {
                            target.style.display = 'none';
                            icon.className = 'fas fa-chevron-right';
                        }
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true); // Use capture phase
            
            // Handle tree item selection in normal phase
            document.addEventListener('click', function(e) {
                // Only handle tree item selection if not clicking on toggle
                if (e.target.closest('.tree-item') && !e.target.closest('.tree-toggle')) {
                    const treeItem = e.target.closest('.tree-item');
                    const value = treeItem.getAttribute('data-value');
                    const text = treeItem.querySelector('.tree-item-text').textContent;
                    const dropdown = treeItem.closest('.tree-dropdown');
                    const hiddenInput = dropdown.querySelector('input[type="hidden"]');
                    const dropdownText = dropdown.querySelector('.dropdown-text');
                    
                    // Update value
                    hiddenInput.value = value;
                    dropdownText.textContent = value ? text : 'No group (ungrouped)';
                    
                    // Close dropdown only when selecting an item
                    const dropdownElement = new bootstrap.Dropdown(dropdown.querySelector('[data-bs-toggle="dropdown"]'));
                    dropdownElement.hide();
                    
                    // Remove selected class from all items
                    dropdown.querySelectorAll('.tree-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked item
                    if (value) {
                        treeItem.classList.add('selected');
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        }

        // Create group form handler
        const createGroupForm = document.getElementById('createGroupForm');
        if (createGroupForm) {
            createGroupForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                data.level = 1; // Always create top-level groups from this modal
                data.parentGroupId = null;
                
                try {
                    const response = await fetch('/api/session-groups', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        const error = await response.json();
                        alert('Error creating group: ' + (error.message || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error creating group: ' + err.message);
                }
            });
        }
        
        // Initialize Flatpickr for datetime inputs
        flatpickr('#sessionStart', {
            enableTime: true,
            dateFormat: 'Y-m-d h:i K',
            time_24hr: false,
            allowInput: true
        });
        
        flatpickr('#sessionEnd', {
            enableTime: true,
            dateFormat: 'Y-m-d h:i K',
            time_24hr: false,
            allowInput: true
        });
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
}
