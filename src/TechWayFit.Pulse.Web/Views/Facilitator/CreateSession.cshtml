@{
    ViewData["Title"] = "TechWayFit Pulse — Create Session";
}

@section Styles {
    <link rel="stylesheet" href="~/css/create-session.css" asp-append-version="true" />
}

<main class="py-5">
    <!-- Constrained Container -->
    <div class="container" style="max-width: 1200px;">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h2 class="mb-2">Create session</h2>
                <p class="text-muted mb-0">Context → Join Form (max 5 fields) → Launch</p>
            </div>
            <span class="badge bg-white text-dark border px-3 py-2">TTL: <strong>6h</strong></span>
        </div>

        <!-- Alternative Creation Methods -->
        <div class="alert alert-light border d-flex align-items-center gap-3 mb-4">
            <div class="flex-grow-1">
                <div class="fw-semibold mb-1">Looking for other ways to create a session?</div>
                <small class="text-muted">Try our templates or AI-powered session creator</small>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <a href="@Url.Action("Templates", "Facilitator")" class="btn btn-sm btn-outline-primary">
                    <span class="me-1">📋</span>Use Template
                </a>
                <a href="/facilitator/create-workshop" class="btn btn-sm btn-outline-primary">
                    <span class="me-1">🧠</span>AI Generate
                </a>
            </div>
        </div>

        <!-- Form -->
        <form id="sessionCreateForm" action="/api/sessions" method="post">
            <!-- Session Context Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title fw-semibold mb-4">Session context</h5>

                    <!-- No tabs needed - single section -->

                    <!-- Session Details -->
                    <div class="mb-4">
                                <label class="form-label fw-medium">Session title</label>
                                <input class="form-control" name="sessionTitle" id="sessionTitle" required
                                       placeholder="e.g., Sprint Retrospective - Team Alpha" />
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-medium">Goal</label>
                                <textarea class="form-control" name="sessionGoal" rows="3"
                                          placeholder="What do you want to achieve in this session?"></textarea>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Session Group</label>
                                    @{
                                        var groups = ViewData["Groups"] as IReadOnlyCollection<TechWayFit.Pulse.Domain.Entities.SessionGroup> ?? new List<TechWayFit.Pulse.Domain.Entities.SessionGroup>();
                                        var treeItems = new List<TechWayFit.Pulse.Web.ViewComponents.TreeDropdown.TreeDropdownItem>();
                                        
                                        foreach (TechWayFit.Pulse.Domain.Entities.SessionGroup group in groups)
                                        {
                                            treeItems.Add(new TechWayFit.Pulse.Web.ViewComponents.TreeDropdown.TreeDropdownItem
                                            {
                                                Value = group.Id.ToString(),
                                                Text = group.Name,
                                                ParentValue = group.ParentGroupId?.ToString(),
                                                Level = group.Level - 1,
                                                HasChildren = groups.Any(g => g.ParentGroupId == group.Id),
                                                Icon = group.Level == 1 ? "📁" : group.Level == 2 ? "📂" : "📄"
                                            });
                                        }
                                    }
                                    @await Component.InvokeAsync("TreeDropdown", new {
                                        id = "groupId",
                                        name = "groupId",
                                        placeholder = "No group (ungrouped)",
                                        items = treeItems,
                                        allowClear = true
                                    })
                                    @if (!groups.Any())
                                    {
                                        <div class="form-text">
                                            No groups yet. <a href="#" data-bs-toggle="modal" data-bs-target="#createGroupModal">Create your first group</a> to organize sessions.
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="form-text">Optional: Organize your session into a group</div>
                                    }
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Max contributions per activity</label>
                                    <select class="form-select" name="maxContributions">
                                        <option value="3">3</option>
                                        <option value="5" selected>5</option>
                                        <option value="8">8</option>
                                        <option value="10">10</option>
                                        <option value="15">15</option>
                                        <option value="20">20</option>
                                    </select>
                                    <div class="form-text">Maximum responses allowed per participant in each activity</div>
                                </div>
                            </div>
                </div>
            </div>

            <!-- Join Form Builder Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <!-- Header -->
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-primary" viewBox="0 0 16 16">
                                <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z" />
                            </svg>
                        </div>
                        <div>
                            <h6 class="fw-semibold mb-1">Join form builder</h6>
                            <p class="text-muted small mb-0">
                                Add up to 5 fields for participant registration. This data helps filter and group responses.
                            </p>
                        </div>
                    </div>

                    <!-- Form Builder Content -->
                    <div class="form-builder-container" id="joinFormBuilder">
                        <!-- Left: Field Types -->
                        <div>
                            <div class="d-flex align-items-center mb-3">
                                <h6 class="fw-semibold mb-0 text-uppercase small text-muted">Available Field Types</h6>
                            </div>
                            
                            <!-- Mobile: Dropdown + Add Button -->
                            <div class="mobile-field-selector d-none">
                                <div class="d-flex gap-2">
                                    <select class="form-select" id="mobileFieldTypeSelect">
                                        <option value="">Select field type...</option>
                                        <option value="text">📝 Text Box</option>
                                        <option value="checkbox">☑️ Checkbox</option>
                                        <option value="dropdown">📋 Dropdown</option>
                                        <option value="textarea">📄 Text Area</option>
                                        <option value="radio">◉ Radio Button</option>
                                    </select>
                                    <button type="button" class="btn btn-primary" id="mobileAddFieldBtn" style="white-space: nowrap;">
                                        + Add
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Desktop: Draggable Field Types -->
                            <div class="d-flex flex-column gap-2" id="fieldTypes">
                                <div class="field-type" draggable="true" data-type="text">
                                    <span class="icon">📝</span>
                                    <span class="label">Text Box</span>
                                </div>
                                <div class="field-type" draggable="true" data-type="checkbox">
                                    <span class="icon">☑️</span>
                                    <span class="label">Checkbox</span>
                                </div>
                                <div class="field-type" draggable="true" data-type="dropdown">
                                    <span class="icon">📋</span>
                                    <span class="label">Dropdown</span>
                                </div>
                                <div class="field-type" draggable="true" data-type="textarea">
                                    <span class="icon">📄</span>
                                    <span class="label">Text Area</span>
                                </div>
                                <div class="field-type" draggable="true" data-type="radio">
                                    <span class="icon">◉</span>
                                    <span class="label">Radio Button</span>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Drop Zone -->
                        <div class="form-drop-zone" id="formDropZone">
                            <div class="drop-zone-placeholder">
                                <div class="text-center text-muted">
                                    <div class="fs-1 mb-2">⬇️</div>
                                    <div class="fw-medium">Drag field types here to build your join form</div>
                                    <small class="d-block mt-2">Maximum 5 fields allowed</small>
                                </div>
                            </div>
                            <!-- Dynamic fields will be added here by JavaScript -->
                        </div>
                    </div>

                    <!-- Hidden input to store form fields as JSON -->
                    <input type="hidden" id="joinFormFields" name="joinFormFields" value="[]" />
                </div>
            </div>

            <!-- Error Alert -->
            <div id="errorMessage" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <!-- Action Buttons -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <a class="btn btn-outline-secondary px-4" href="/">Cancel</a>
                        <button type="submit" class="btn btn-primary pulse-btn-primary px-4 py-2" id="submitBtn">
                            <span class="btn-text">Save & Go Live</span>
                            <span class="btn-loading d-none">
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                Creating session...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</main>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createGroupModalLabel">Create Session Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createGroupForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">Group Name *</label>
                        <input type="text" class="form-control" id="groupName" name="name" required maxlength="200">
                    </div>
                    
                    <div class="mb-3">
                        <label for="groupDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="groupDescription" name="description" rows="2" maxlength="1000" placeholder="Optional description"></textarea>
                    </div>
                    
                    <input type="hidden" name="level" value="1">
                    <input type="hidden" name="parentGroupId" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <!-- External JavaScript -->
    <script src="~/js/create-session-form.js" asp-append-version="true"></script>

    <!-- Tree Dropdown functionality -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Tree Dropdown
        initializeTreeDropdown();
        
        function initializeTreeDropdown() {
            // Handle tree toggle clicks first with capture phase
            document.addEventListener('click', function(e) {
                // Tree toggle functionality - handle in capture phase to prevent dropdown from closing
                if (e.target.closest('.tree-toggle')) {
                    const toggle = e.target.closest('.tree-toggle');
                    const targetId = toggle.getAttribute('data-target');
                    const target = document.getElementById(targetId);
                    const icon = toggle.querySelector('i');
                    
                    if (target) {
                        if (target.style.display === 'none' || target.style.display === '') {
                            target.style.display = 'block';
                            icon.className = 'fas fa-chevron-down';
                        } else {
                            target.style.display = 'none';
                            icon.className = 'fas fa-chevron-right';
                        }
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true); // Use capture phase
            
            // Handle tree item selection in normal phase
            document.addEventListener('click', function(e) {
                // Only handle tree item selection if not clicking on toggle
                if (e.target.closest('.tree-item') && !e.target.closest('.tree-toggle')) {
                    const treeItem = e.target.closest('.tree-item');
                    const value = treeItem.getAttribute('data-value');
                    const text = treeItem.querySelector('.tree-item-text').textContent;
                    const dropdown = treeItem.closest('.tree-dropdown');
                    const hiddenInput = dropdown.querySelector('input[type="hidden"]');
                    const dropdownText = dropdown.querySelector('.dropdown-text');
                    
                    // Update value
                    hiddenInput.value = value;
                    dropdownText.textContent = value ? text : 'No group (ungrouped)';
                    
                    // Close dropdown only when selecting an item
                    const dropdownElement = new bootstrap.Dropdown(dropdown.querySelector('[data-bs-toggle="dropdown"]'));
                    dropdownElement.hide();
                    
                    // Remove selected class from all items
                    dropdown.querySelectorAll('.tree-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked item
                    if (value) {
                        treeItem.classList.add('selected');
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        }

        // Create group form handler
        const createGroupForm = document.getElementById('createGroupForm');
        if (createGroupForm) {
            createGroupForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                data.level = 1; // Always create top-level groups from this modal
                data.parentGroupId = null;
                
                try {
                    const response = await fetch('/api/session-groups', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        const error = await response.json();
                        alert('Error creating group: ' + (error.message || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error creating group: ' + err.message);
                }
            });
        }
    });
    </script>
}
