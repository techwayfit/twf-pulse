@{
    ViewData["Title"] = "Add Activities — TechWayFit Pulse";
}

@section Styles {
    <link rel="stylesheet" href="~/css/add-activities.css" asp-append-version="true" />
    <!-- Tom Select for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
}

<main class="py-5">
    <div class="container container-wide">
        <!-- Header -->
        <div class="mb-4">
            <div class="d-flex align-items-center gap-2 text-muted mb-2">
                <a href="/facilitator/dashboard" class="text-decoration-none text-muted">← Back to Dashboard</a>
            </div>
            <h2 class="mb-2">Add Activities</h2>
            <p class="text-muted mb-0">Choose how you want to create activities for your session</p>
        </div>

        <!-- Session Info Badge -->
        <div class="card border-0 shadow-sm mb-4 bg-success-subtle border-start border-success border-4">
            <div class="card-body d-flex align-items-center gap-3 py-3">
                <div><i class="ics ics-clipboard ic-md"></i></div>
                <div class="flex-grow-1">
                    <div class="fw-semibold mb-1 text-primary">Session: <span id="sessionTitle">@ViewData["SessionTitle"]</span></div>
                    <small class="text-muted">Code: <strong id="sessionCode" class="text-primary">@ViewData["SessionCode"]</strong></small>
                </div>
            </div>
        </div>

        <!-- Hidden fields for JavaScript -->
        <input type="hidden" id="hiddenSessionCode" value="@ViewData["SessionCode"]" />
        <input type="hidden" id="hiddenSessionId" value="@ViewData["SessionId"]" />
        @if (ViewData["TemplateId"] != null)
        {
            <input type="hidden" id="hiddenTemplateId" value="@ViewData["TemplateId"]" />
        }

        <!-- Activity Creation Modes (Tabs) -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom pt-4 px-4">
                <div class="row g-2" role="tablist">
                    <div class="col-4">
                        <button class="btn btn-outline-primary w-100 active add-mode-tab" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-panel" type="button" role="tab" aria-controls="manual-panel" aria-selected="true">
                            <i class="ics ics-pencil ic-sm ic-mr"></i>Manual
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-primary w-100 add-mode-tab" id="template-tab" data-bs-toggle="tab" data-bs-target="#template-panel" type="button" role="tab" aria-controls="template-panel" aria-selected="false">
                            <i class="ics ics-clipboard ic-sm ic-mr"></i>Template
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-primary w-100 add-mode-tab" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-panel" type="button" role="tab" aria-controls="ai-panel" aria-selected="false">
                            <i class="ics ics-robot ic-sm ic-mr"></i>AI Create
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body p-4">
                <div class="tab-content" id="activityModeTabContent">
                    <!-- Manual Mode -->
                    <div class="tab-pane fade show active" id="manual-panel" role="tabpanel">
                        <div class="py-3">
                            <div class="text-center mb-4 tab-intro">
                                <h5 class="mb-2 d-flex align-items-center justify-content-center gap-2">
                                    <i class="ics ics-pencil ic-md"></i>
                                    <span>Add Activities Manually</span>
                                </h5>
                                <p class="text-muted mb-0">Build your session by adding activities one by one</p>
                            </div>

                            <!-- Activity List -->
                            <div id="manualActivityList" class="mb-4">
                                <div class="text-muted text-center small py-3">No activities yet. Choose an activity type below to add one.</div>
                            </div>

                            <div class="manual-actions-sticky pt-3 border-top mt-3">
                                <p class="text-muted text-center mb-3">Choose an activity type to add</p>

                                <div class="row g-2 mb-3">
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#pollModal">
                                            <i class="ics ics-chart ic-sm ic-mr"></i>Poll
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#wordcloudModal">
                                            <i class="ics ics-thought-balloon ic-sm ic-mr"></i>Word Cloud
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#quadrantModal">
                                            <i class="ics ics-chart-increasing ic-sm ic-mr"></i>Quadrant
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#ratingModal">
                                            <i class="ics ics-star ic-sm ic-mr"></i>Rating
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                                            <i class="ics ics-chat ic-sm ic-mr"></i>Feedback
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Template Mode -->
                    <div class="tab-pane fade" id="template-panel" role="tabpanel">
                        <div class="py-4">
                            <div class="text-center mb-4 tab-intro">
                                <h5 class="mb-2 d-flex align-items-center justify-content-center gap-2">
                                    <i class="ics ics-clipboard ic-md"></i>
                                    <span>Choose a Template</span>
                                </h5>
                                <p class="text-muted mb-0">Select a pre-configured activity set for your session</p>
                            </div>
                            
                            <!-- Category Filter -->
                            <div class="mb-4">
                                <!-- Mobile: Dropdown -->
                                <select class="form-select d-md-none" id="templateCategoryFilterMobile" aria-label="Filter templates by category">
                                    <option value="all">All Templates</option>
                                    <option value="Retrospective">Retrospective</option>
                                    <option value="ProductDiscovery">Product Discovery</option>
                                    <option value="IncidentReview">Incident Review</option>
                                    <option value="TeamBuilding">Team Building</option>
                                    <option value="Training">Training</option>
                                </select>
                                
                                <!-- Desktop: Buttons -->
                                <div class="d-none d-md-flex flex-wrap gap-2 justify-content-center" role="group" aria-label="Filter templates by category">
                                    <button type="button" class="btn btn-sm btn-outline-secondary active" data-template-filter="all">
                                        All Templates
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="Retrospective">
                                        <i class="ics ics-memo ic-xs ic-mr"></i>Retrospective
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="ProductDiscovery">
                                        <i class="ics ics-lightbulb ic-xs ic-mr"></i>Product Discovery
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="IncidentReview">
                                        <i class="ics ics-warning ic-xs ic-mr"></i>Incident Review
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="TeamBuilding">
                                        <i class="ics ics-handshake ic-xs ic-mr"></i>Team Building
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="Training">
                                        <i class="ics ics-books ic-xs ic-mr"></i>Training
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Template Grid -->
                            <div id="templateList" class="row g-3">
                                <div class="col-12 text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    Loading templates...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Mode -->
                    <div class="tab-pane fade" id="ai-panel" role="tabpanel">
                        <div class="py-4">
                            <div class="text-center mb-4 tab-intro">
                                <h5 class="mb-2 d-flex align-items-center justify-content-center gap-2">
                                    <i class="ics ics-robot ic-md"></i>
                                    <span>AI Activity Generator</span>
                                </h5>
                                <p class="text-muted mb-0">AI will use your session title and goal to generate contextual activities</p>
                            </div>

                            <!-- Session Context Info -->
                            <div class="alert alert-light border mb-4">
                                <div class="small text-muted mb-2"><strong>Session Context:</strong></div>
                                <div class="mb-1"><strong>Title:</strong> <span id="aiSessionTitle">@ViewData["SessionTitle"]</span></div>
                                <div class="text-muted small">AI will generate activities based on this context</div>
                            </div>

                            <form id="aiGenerateForm">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Workshop Type</label>
                                        <select class="form-select" id="aiWorkshopType">
                                            <option value="">Auto-detect from session</option>
                                            <option value="retrospective">Retrospective</option>
                                            <option value="ops">Ops / Process Improvement</option>
                                            <option value="discovery">Discovery</option>
                                            <option value="incident">Incident Review</option>
                                            <option value="feedback">Feedback Session</option>
                                            <option value="planning">Planning</option>
                                            <option value="brainstorming">Brainstorming</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Session Duration <span class="text-danger">*</span></label>
                                        <select class="form-select" id="aiDuration" required>
                                            <option value="">-- Select Duration --</option>
                                            <option value="15">15 minutes (2-3 activities)</option>
                                            <option value="20">20 minutes (3-4 activities)</option>
                                            <option value="30">30 minutes (4-6 activities)</option>
                                            <option value="45">45 minutes (6-9 activities)</option>
                                            <option value="60" selected>60 minutes (8-12 activities)</option>
                                            <option value="75">75 minutes (10-15 activities)</option>
                                        </select>
                                        <small class="text-muted d-block">Max 15 activities per AI call. You can generate multiple times.</small>
                                        <small class="text-muted">Sessions should have no more than 30 activities total.</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Number of Participants</label>
                                        <select class="form-select" id="aiParticipantCount">
                                            <option value="">Not specified</option>
                                            <option value="5">Small team (3-5)</option>
                                            <option value="10">Medium team (6-10)</option>
                                            <option value="20">Large team (11-20)</option>
                                            <option value="50">Large group (20+)</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-medium">Participant Types (Optional)</label>
                                        <div class="form-text small mb-2">Filter by industry, then search and select multiple participant types</div>
                                        
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-4">
                                                <label class="form-label small">Filter by Industry</label>
                                                <select class="form-select" id="participantTypeFilter">
                                                    <option value="">All Industries</option>
                                                    <!-- Options will be populated by JavaScript -->
                                                </select>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label small">Select Participant Types</label>
                                                <select class="form-select" id="participantTypeDropdown" multiple placeholder="Search and select...">
                                                    <!-- Options will be populated by JavaScript -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-medium">Additional Context (Optional)</label>
                                        <textarea class="form-control" id="aiAdditionalContext" rows="3" 
                                                  placeholder="Add extra context to help AI generate better activities (e.g., team size, specific challenges, recent events...)"></textarea>
                                        <div class="form-text">This helps AI create more relevant and targeted activities</div>
                                    </div>
                                </div>

                                <div class="text-center mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg px-5" id="aiGenerateBtn">
                                        <span class="btn-text d-inline">
                                            <i class="ics ics-robot ic-sm ic-mr"></i>Generate Activities
                                        </span>
                                        <span class="btn-loading d-none">
                                            <span class="spinner-border spinner-border-sm me-2" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                            Generating with AI...
                                        </span>
                                    </button>
                                </div>

                                <!-- Status Messages -->
                                <div id="aiStatusMessage" class="mt-3 text-center d-none"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card border-0 shadow-sm mt-4" id="saveSessionSection">
            <div class="card-body p-4">
                <div class="d-flex justify-content-center align-items-center flex-wrap gap-3">
                    <button type="button" class="btn btn-primary px-5" onclick="goLive()" id="goLiveBtn" disabled>
                        <i class="ics ics-save ic-sm ic-mr"></i>Save Session
                    </button>
                </div>
          
            </div>
        </div>
    </div>
</main>

<!-- Activity Creation Modals -->
@await Html.PartialAsync("_ActivityFormModals")

<!-- Template Confirmation Modal -->
<div class="modal fade" id="templateConfirmModal" tabindex="-1" aria-labelledby="templateConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="templateConfirmModalLabel">Add Template Activities</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 pb-4">
                <div class="text-center mb-3">
                    <div class="d-inline-flex align-items-center justify-content-center icon-circle icon-circle-64 bg-primary-subtle"> 
                        <span id="templateModalIcon"><i class="ics ics-clipboard ic-xl"></i></span>
                    </div>
                </div>
                <h6 class="text-center mb-3" id="templateModalName"></h6>
                <p class="text-muted text-center mb-3" id="templateModalDescription"></p>
                
                <!-- Activities List -->
                <div class="mb-3">
                    <h6 class="mb-2">Activities to be added:</h6>
                    <div id="templateActivitiesList" class="list-group list-scroll">
                        <!-- Activities will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="alert alert-info border-0 mb-0 bg-info-subtle">
                    <div class="d-flex align-items-start gap-2">
                        <span><i class="ics ics-info ic-md"></i></span>
                        <small class="mb-0">
                            These activities will be <strong>added to your existing activities</strong>. Your current activities will not be removed.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0 pb-4 px-4 justify-content-center gap-2">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary px-4" id="confirmTemplateBtn">
                    Add Activities
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 pb-4 text-center">
                <div class="d-inline-flex align-items-center justify-content-center mb-3 icon-circle icon-circle-64" 
                     id="notificationIconContainer">
                    <span class="fs-1" id="notificationIcon"></span>
                </div>
                <h5 class="mb-3" id="notificationTitle"></h5>
                <p class="text-muted mb-0" id="notificationMessage"></p>
            </div>
            <div class="modal-footer border-0 pt-0 pb-4 px-4 justify-content-center">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal (Reusable) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 pb-4 text-center">
                <div class="d-inline-flex align-items-center justify-content-center mb-3 icon-circle icon-circle-64 bg-warning-subtle"> 
                    <span id="confirmIcon"><i class="ics ics-warning ic-xl"></i></span>
                </div>
                <h5 class="mb-3" id="confirmTitle">Confirm Action</h5>
                <p class="text-muted mb-0" id="confirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer border-0 pt-0 pb-4 px-4 justify-content-center gap-2">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal" id="confirmCancelBtn">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary px-4" id="confirmOkBtn">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Tom Select for searchable dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script src="~/js/activity-types.js" asp-append-version="true"></script>
    <script src="~/js/add-activities.js" asp-append-version="true"></script>
    <script src="~/js/activity-modals.js" asp-append-version="true"></script>
}
