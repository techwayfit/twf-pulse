@{
    ViewData["Title"] = "Add Activities ‚Äî TechWayFit Pulse";
}

@section Styles {
    <link rel="stylesheet" href="~/css/add-activities.css" asp-append-version="true" />
    <!-- Tom Select for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
}

<main class="py-5">
    <div class="container container-wide">
        <!-- Header -->
        <div class="mb-4">
            <div class="d-flex align-items-center gap-2 text-muted mb-2">
                <a href="/facilitator/dashboard" class="text-decoration-none text-muted">‚Üê Back to Dashboard</a>
            </div>
            <h2 class="mb-2">Add Activities</h2>
            <p class="text-muted mb-0">Choose how you want to create activities for your session</p>
        </div>

        <!-- Session Info Badge -->
        <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #3b82f6 !important;">
            <div class="card-body d-flex align-items-center gap-3 py-3">
                <div class="fs-4">üìã</div>
                <div class="flex-grow-1">
                    <div class="fw-semibold mb-1" style="color: #1e40af;">Session: <span id="sessionTitle">@ViewData["SessionTitle"]</span></div>
                    <small class="text-muted">Code: <strong id="sessionCode" style="color: #3b82f6;">@ViewData["SessionCode"]</strong></small>
                </div>
            </div>
        </div>

        <!-- Hidden fields for JavaScript -->
        <input type="hidden" id="hiddenSessionCode" value="@ViewData["SessionCode"]" />
        <input type="hidden" id="hiddenSessionId" value="@ViewData["SessionId"]" />
        @if (ViewData["TemplateId"] != null)
        {
            <input type="hidden" id="hiddenTemplateId" value="@ViewData["TemplateId"]" />
        }

        <!-- Activity Creation Modes (Tabs) -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom pt-4 px-4">
                <div class="row g-2" role="tablist">
                    <div class="col-4">
                        <button class="btn btn-outline-primary w-100 active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-panel" type="button" role="tab" aria-controls="manual-panel" aria-selected="true">
                            <span class="me-1">‚úèÔ∏è</span>Manual
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-primary w-100" id="template-tab" data-bs-toggle="tab" data-bs-target="#template-panel" type="button" role="tab" aria-controls="template-panel" aria-selected="false">
                            <span class="me-1">üìã</span>Template
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-primary w-100" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-panel" type="button" role="tab" aria-controls="ai-panel" aria-selected="false">
                            <span class="me-1">üß†</span>AI Create
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body p-4">
                <div class="tab-content" id="activityModeTabContent">
                    <!-- Manual Mode -->
                    <div class="tab-pane fade show active" id="manual-panel" role="tabpanel">
                        <div class="py-3">
                            <!-- Activity List -->
                            <div id="manualActivityList" class="mb-4">
                                <div class="text-muted text-center small py-3">No activities yet. Choose an activity type below to add one.</div>
                            </div>
                            
                            <div class="text-center mb-3">
                                <h5 class="mb-2"><span class="me-2">‚úèÔ∏è</span>Add Activities Manually</h5>
                                <p class="text-muted mb-0">Choose from different activity types to build your session</p>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#pollModal">
                                        <span class="me-1">üìä</span>Poll
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#wordcloudModal">
                                        <span class="me-1">‚òÅÔ∏è</span>Word Cloud
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#quadrantModal">
                                        <span class="me-1">üìà</span>Quadrant
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#fivewhysModal">
                                        <span class="me-1">üîç</span>5 Whys
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#ratingModal">
                                        <span class="me-1">‚≠ê</span>Rating
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                                        <span class="me-1">üí¨</span>Feedback
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Template Mode -->
                    <div class="tab-pane fade" id="template-panel" role="tabpanel">
                        <div class="py-4">
                            <div class="text-center mb-4">
                                <div class="fs-1 mb-3">üìã</div>
                                <h5 class="mb-2">Choose a Template</h5>
                                <p class="text-muted mb-0">Select a pre-configured activity set for your session</p>
                            </div>
                            
                            <!-- Category Filter -->
                            <div class="mb-4">
                                <!-- Mobile: Dropdown -->
                                <select class="form-select d-md-none" id="templateCategoryFilterMobile" aria-label="Filter templates by category">
                                    <option value="all">All Templates</option>
                                    <option value="Retrospective">üîÑ Retrospective</option>
                                    <option value="ProductDiscovery">üí° Product Discovery</option>
                                    <option value="IncidentReview">üö® Incident Review</option>
                                    <option value="TeamBuilding">ü§ù Team Building</option>
                                    <option value="Training">üìö Training</option>
                                </select>
                                
                                <!-- Desktop: Buttons -->
                                <div class="d-none d-md-flex flex-wrap gap-2 justify-content-center" role="group" aria-label="Filter templates by category">
                                    <button type="button" class="btn btn-sm btn-outline-secondary active" data-template-filter="all">
                                        All Templates
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="Retrospective">
                                        üîÑ Retrospective
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="ProductDiscovery">
                                        üí° Product Discovery
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="IncidentReview">
                                        üö® Incident Review
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="TeamBuilding">
                                        ü§ù Team Building
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-template-filter="Training">
                                        üìö Training
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Template Grid -->
                            <div id="templateList" class="row g-3">
                                <div class="col-12 text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    Loading templates...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Mode -->
                    <div class="tab-pane fade" id="ai-panel" role="tabpanel">
                        <div class="py-4">
                            <div class="text-center mb-4">
                                <h5 class="mb-2"><span class="me-2">üß†</span>AI Activity Generator <span class="text-muted fw-normal small">‚Äî AI will use your session title and goal to generate contextual activities</span></h5>
                            </div>

                            <!-- Session Context Info -->
                            <div class="alert alert-light border mb-4">
                                <div class="small text-muted mb-2"><strong>Session Context:</strong></div>
                                <div class="mb-1"><strong>Title:</strong> <span id="aiSessionTitle">@ViewData["SessionTitle"]</span></div>
                                <div class="text-muted small">AI will generate activities based on this context</div>
                            </div>

                            <form id="aiGenerateForm">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Workshop Type</label>
                                        <select class="form-select" id="aiWorkshopType">
                                            <option value="">Auto-detect from session</option>
                                            <option value="retrospective">Retrospective</option>
                                            <option value="ops">Ops / Process Improvement</option>
                                            <option value="discovery">Discovery</option>
                                            <option value="incident">Incident Review</option>
                                            <option value="feedback">Feedback Session</option>
                                            <option value="planning">Planning</option>
                                            <option value="brainstorming">Brainstorming</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Session Duration <span class="text-danger">*</span></label>
                                        <select class="form-select" id="aiDuration" required>
                                            <option value="">-- Select Duration --</option>
                                            <option value="15">15 minutes (2-3 activities)</option>
                                            <option value="20">20 minutes (3-4 activities)</option>
                                            <option value="30">30 minutes (4-6 activities)</option>
                                            <option value="45">45 minutes (6-9 activities)</option>
                                            <option value="60" selected>60 minutes (8-12 activities)</option>
                                            <option value="75">75 minutes (10-15 activities)</option>
                                        </select>
                                        <small class="text-muted d-block">Max 15 activities per AI call. You can generate multiple times.</small>
                                        <small class="text-muted">Sessions should have no more than 30 activities total.</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Number of Participants</label>
                                        <select class="form-select" id="aiParticipantCount">
                                            <option value="">Not specified</option>
                                            <option value="5">Small team (3-5)</option>
                                            <option value="10">Medium team (6-10)</option>
                                            <option value="20">Large team (11-20)</option>
                                            <option value="50">Large group (20+)</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-medium">Participant Types (Optional)</label>
                                        <div class="form-text small mb-2">Filter by industry, then search and select multiple participant types</div>
                                        
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-4">
                                                <label class="form-label small">Filter by Industry</label>
                                                <select class="form-select" id="participantTypeFilter">
                                                    <option value="">All Industries</option>
                                                    <!-- Options will be populated by JavaScript -->
                                                </select>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label small">Select Participant Types</label>
                                                <select class="form-select" id="participantTypeDropdown" multiple placeholder="Search and select...">
                                                    <!-- Options will be populated by JavaScript -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-medium">Additional Context (Optional)</label>
                                        <textarea class="form-control" id="aiAdditionalContext" rows="3" 
                                                  placeholder="Add extra context to help AI generate better activities (e.g., team size, specific challenges, recent events...)"></textarea>
                                        <div class="form-text">This helps AI create more relevant and targeted activities</div>
                                    </div>
                                </div>

                                <div class="text-center mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg px-5" id="aiGenerateBtn">
                                        <span class="btn-text d-inline">
                                            <span class="me-2">üß†</span>Generate Activities
                                        </span>
                                        <span class="btn-loading d-none">
                                            <span class="spinner-border spinner-border-sm me-2" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                            Generating with AI...
                                        </span>
                                    </button>
                                </div>

                                <!-- Status Messages -->
                                <div id="aiStatusMessage" class="mt-3 text-center d-none"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-center align-items-center flex-wrap gap-3">
                    <button type="button" class="btn btn-primary px-5" onclick="goLive()" id="goLiveBtn" disabled>
                        <span class="me-2">üíæ</span>Save Session
                    </button>
                </div>
          
            </div>
        </div>
    </div>
</main>

<!-- Activity Creation Modals -->
@await Html.PartialAsync("_ActivityFormModals")

<!-- Template Confirmation Modal -->
<div class="modal fade" id="templateConfirmModal" tabindex="-1" aria-labelledby="templateConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="templateConfirmModalLabel">Add Template Activities</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 pb-4">
                <div class="text-center mb-3">
                    <div class="d-inline-flex align-items-center justify-content-center" 
                         style="width: 64px; height: 64px; background: linear-gradient(135deg, #ede9fe 0%, #f3e8ff 100%); border-radius: 50%;">
                        <span style="font-size: 32px;" id="templateModalIcon">üìã</span>
                    </div>
                </div>
                <h6 class="text-center mb-3" id="templateModalName"></h6>
                <p class="text-muted text-center mb-3" id="templateModalDescription"></p>
                
                <!-- Activities List -->
                <div class="mb-3">
                    <h6 class="mb-2">Activities to be added:</h6>
                    <div id="templateActivitiesList" class="list-group" style="max-height: 300px; overflow-y: auto;">
                        <!-- Activities will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="alert alert-info border-0 mb-0" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                    <div class="d-flex align-items-start gap-2">
                        <span style="font-size: 1.2rem;">‚ÑπÔ∏è</span>
                        <small class="mb-0">
                            These activities will be <strong>added to your existing activities</strong>. Your current activities will not be removed.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0 pb-4 px-4 justify-content-center gap-2">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary px-4" id="confirmTemplateBtn">
                    Add Activities
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 pb-4 text-center">
                <div class="d-inline-flex align-items-center justify-content-center mb-3" 
                     style="width: 64px; height: 64px; border-radius: 50%;"
                     id="notificationIconContainer">
                    <span style="font-size: 32px;" id="notificationIcon"></span>
                </div>
                <h5 class="mb-3" id="notificationTitle"></h5>
                <p class="text-muted mb-0" id="notificationMessage"></p>
            </div>
            <div class="modal-footer border-0 pt-0 pb-4 px-4 justify-content-center">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal (Reusable) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 pb-4 text-center">
                <div class="d-inline-flex align-items-center justify-content-center mb-3" 
                     style="width: 64px; height: 64px; background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%); border-radius: 50%;">
                    <span style="font-size: 32px;" id="confirmIcon">‚ö†Ô∏è</span>
                </div>
                <h5 class="mb-3" id="confirmTitle">Confirm Action</h5>
                <p class="text-muted mb-0" id="confirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer border-0 pt-0 pb-4 px-4 justify-content-center gap-2">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal" id="confirmCancelBtn">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary px-4" id="confirmOkBtn">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Tom Select for searchable dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script src="~/js/activity-types.js" asp-append-version="true"></script>
    <script src="~/js/add-activities.js" asp-append-version="true"></script>
    <script src="~/js/activity-modals.js" asp-append-version="true"></script>
}
