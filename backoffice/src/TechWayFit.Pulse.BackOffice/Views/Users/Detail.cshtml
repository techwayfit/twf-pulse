@model TechWayFit.Pulse.BackOffice.Core.Models.Users.UserDetailViewModel
@{
    ViewBag.Title = $"User — {Model.Email}";
    bool isSuperAdmin = User.IsInRole("SuperAdmin");
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0 fw-semibold">
        <i class="fa-solid fa-user me-2 text-primary"></i>@Model.DisplayName
    </h1>
    <a asp-action="Index" class="btn btn-sm btn-outline-secondary">
        <i class="fa-solid fa-arrow-left me-1"></i>Back
    </a>
</div>

@* ── Account details ──────────────────────────────────────────────────────── *@
<div class="row g-3 mb-4">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-bottom fw-semibold">Account Details</div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">ID</dt>
                    <dd class="col-sm-8"><code class="small">@Model.Id</code></dd>
                    <dt class="col-sm-4">Email</dt>
                    <dd class="col-sm-8">@Model.Email</dd>
                    <dt class="col-sm-4">Display Name</dt>
                    <dd class="col-sm-8">@Model.DisplayName</dd>
                    <dt class="col-sm-4">Status</dt>
                    <dd class="col-sm-8">
                        @if (Model.IsDisabled)
                        {
                            <span class="badge bg-danger">Disabled</span>
                            <small class="text-muted ms-2">@Model.DisabledAt?.ToString("dd MMM yyyy") — @Model.DisabledReason</small>
                        }
                        else
                        {
                            <span class="badge bg-success">Active</span>
                        }
                    </dd>
                    <dt class="col-sm-4">Created</dt>
                    <dd class="col-sm-8">@Model.CreatedAt.ToString("dd MMM yyyy HH:mm") UTC</dd>
                    <dt class="col-sm-4">Last Login</dt>
                    <dd class="col-sm-8">@(Model.LastLoginAt?.ToString("dd MMM yyyy HH:mm") ?? "Never")</dd>
                    <dt class="col-sm-4">Sessions</dt>
                    <dd class="col-sm-8">@Model.SessionCount</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

@* ── Override panel ───────────────────────────────────────────────────────── *@
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom fw-semibold">
        <i class="fa-solid fa-pen-to-square me-2 text-warning"></i>Override Actions
        <small class="text-muted fw-normal ms-2">All changes are audited</small>
    </div>
    <div class="card-body">
        <div class="row g-3">

            @* Update display name — Operator or SuperAdmin *@
            <div class="col-md-6">
                <form asp-action="UpdateDisplayName" method="post" class="border rounded p-3">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="mb-2">
                        <label class="form-label small fw-semibold">Update Display Name</label>
                        <input type="text" name="newDisplayName" class="form-control form-control-sm"
                               value="@Model.DisplayName" required />
                    </div>
                    <div class="mb-2">
                        <input type="text" name="reason" class="form-control form-control-sm"
                               placeholder="Reason (required)" required />
                    </div>
                    <button type="submit" class="btn btn-sm btn-warning w-100">Update Name</button>
                </form>
            </div>

            @* Disable / Enable — Operator or SuperAdmin *@
            <div class="col-md-6">
                <form asp-action="SetDisabled" method="post" class="border rounded p-3">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <input type="hidden" name="disable" value="@(!Model.IsDisabled)" />
                    <div class="mb-2">
                        <label class="form-label small fw-semibold">
                            @(Model.IsDisabled ? "Re-enable Account" : "Disable Account")
                        </label>
                        <input type="text" name="reason" class="form-control form-control-sm"
                               placeholder="Reason (required)" required />
                    </div>
                    <button type="submit"
                            class="btn btn-sm w-100 @(Model.IsDisabled ? "btn-success" : "btn-danger")">
                        @(Model.IsDisabled ? "Enable Account" : "Disable Account")
                    </button>
                </form>
            </div>

            @if (isSuperAdmin)
            {
                @* Update email — SuperAdmin only *@
                <div class="col-md-6">
                    <form asp-action="UpdateEmail" method="post" class="border border-warning rounded p-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        <div class="mb-2">
                            <label class="form-label small fw-semibold">
                                Update Email <span class="badge bg-warning text-dark">SuperAdmin</span>
                            </label>
                            <input type="email" name="newEmail" class="form-control form-control-sm"
                                   value="@Model.Email" required />
                        </div>
                        <div class="mb-2">
                            <input type="text" name="reason" class="form-control form-control-sm"
                                   placeholder="Reason (required)" required />
                        </div>
                        <button type="submit" class="btn btn-sm btn-warning w-100">Update Email</button>
                    </form>
                </div>

                @* Delete account — SuperAdmin only *@
                <div class="col-md-6">
                    <form asp-action="Delete" method="post" class="border border-danger rounded p-3"
                          onsubmit="return confirm('Permanently delete this account and all associated data? This cannot be undone.')">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        <div class="mb-2">
                            <label class="form-label small fw-semibold text-danger">
                                Delete Account <span class="badge bg-danger">SuperAdmin</span>
                            </label>
                            <input type="email" name="confirmationEmail" class="form-control form-control-sm"
                                   placeholder="Type user email to confirm" required />
                        </div>
                        <div class="mb-2">
                            <input type="text" name="reason" class="form-control form-control-sm"
                                   placeholder="Reason (required)" required />
                        </div>
                        <button type="submit" class="btn btn-sm btn-danger w-100">
                            <i class="fa-solid fa-trash me-1"></i>Delete Permanently
                        </button>
                    </form>
                </div>
            }
        </div>
    </div>
</div>

@* ── UserData entries ─────────────────────────────────────────────────────── *@
@if (Model.UserData.Any())
{
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-bottom fw-semibold">User Data (Settings)</div>
        <table class="table table-sm mb-0">
            <thead class="table-light">
                <tr><th>Key</th><th>Sensitive</th><th>Created</th><th>Updated</th></tr>
            </thead>
            <tbody>
                @foreach (var d in Model.UserData)
                {
                    <tr>
                        <td><code>@d.Key</code></td>
                        <td>@(d.IsSensitive ? "Yes" : "No")</td>
                        <td><small>@d.CreatedAt.ToString("dd MMM yyyy")</small></td>
                        <td><small>@d.UpdatedAt.ToString("dd MMM yyyy")</small></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
